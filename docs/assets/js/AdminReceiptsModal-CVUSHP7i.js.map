{"version":3,"file":"AdminReceiptsModal-CVUSHP7i.js","sources":["../../../frontend/src/components/modals/AdminReceiptsModal.jsx"],"sourcesContent":["import React, { useEffect, useState, useCallback, useRef } from \"react\";\r\nimport BaseModal from \"./BaseModal\";\r\nimport Button from \"../common/Button\";\r\nimport { api } from \"../../lib/api\";\r\nimport { useKeyboardShortcuts } from \"../../hooks/useKeyboardShortcuts\";\r\n\r\nfunction AdminReceiptsModal({ isOpen, onClose }) {\r\n  const [receipts, setReceipts] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [selectedIndex, setSelectedIndex] = useState(0);\r\n  const containerRef = useRef(null);\r\n  const modalContentRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n    const fetchReceipts = async () => {\r\n      setLoading(true);\r\n      setError(\"\");\r\n      try {\r\n        const token = sessionStorage.getItem(\"auth_token\");\r\n        const data = await api(\"/api/sales/business/recent\", {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n        setReceipts(Array.isArray(data) ? data : []);\r\n      } catch (e) {\r\n        console.error(\"Error fetching receipts:\", e);\r\n        setError(\"Failed to load receipts. Please try again.\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    fetchReceipts();\r\n  }, [isOpen]);\r\n\r\n  const openReceipt = useCallback((receipt) => {\r\n    const url = new URL(window.location.origin + \"/receipt\");\r\n    if (receipt.transaction_number)\r\n      url.searchParams.set(\"tn\", receipt.transaction_number);\r\n    if (receipt.transaction_id)\r\n      url.searchParams.set(\"tid\", String(receipt.transaction_id));\r\n    window.open(url.toString(), \"_blank\");\r\n  }, []);\r\n\r\n  const openReceiptByIndex = useCallback((index) => {\r\n    if (!receipts[index]) return;\r\n    openReceipt(receipts[index]);\r\n  }, [receipts, openReceipt]);\r\n\r\n  // Handle keyboard navigation\r\n  const handleKeyDown = useCallback((e) => {\r\n    if (!isOpen || !receipts.length) return;\r\n    e.preventDefault();\r\n\r\n    switch (e.key) {\r\n      case 'ArrowUp': {\r\n        setSelectedIndex(prev => {\r\n          const newIndex = prev <= 0 ? receipts.length - 1 : prev - 1;\r\n          // Use setTimeout to ensure state update is complete before scrolling\r\n          setTimeout(() => {\r\n            const items = containerRef.current?.querySelectorAll('button');\r\n            const selectedItem = items?.[newIndex];\r\n            if (selectedItem) {\r\n              // Scroll the item into view with smooth behavior\r\n              selectedItem.scrollIntoView({\r\n                behavior: 'smooth',\r\n                block: 'nearest',\r\n                inline: 'nearest'\r\n              });\r\n              selectedItem.focus({ preventScroll: true });\r\n            }\r\n          }, 0);\r\n          return newIndex;\r\n        });\r\n        break;\r\n      }\r\n      case 'ArrowDown': {\r\n        setSelectedIndex(prev => {\r\n          const newIndex = prev >= receipts.length - 1 ? 0 : prev + 1;\r\n          // Use setTimeout to ensure state update is complete before scrolling\r\n          setTimeout(() => {\r\n            const items = containerRef.current?.querySelectorAll('button');\r\n            const selectedItem = items?.[newIndex];\r\n            if (selectedItem) {\r\n              // Scroll the item into view with smooth behavior\r\n              selectedItem.scrollIntoView({\r\n                behavior: 'smooth',\r\n                block: 'nearest',\r\n                inline: 'nearest'\r\n              });\r\n              selectedItem.focus({ preventScroll: true });\r\n            }\r\n          }, 0);\r\n          return newIndex;\r\n        });\r\n        break;\r\n      }\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (receipts[selectedIndex]) {\r\n          openReceipt(receipts[selectedIndex]);\r\n        }\r\n        break;\r\n      case 'Escape':\r\n        onClose();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }, [isOpen, receipts, selectedIndex, onClose, openReceipt]);\r\n\r\n  // Set up keyboard shortcuts - removed as we're handling it in handleKeyDown\r\n\r\n  // Reset selected index when modal opens or receipts change\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setSelectedIndex(0);\r\n      // Focus the container when it opens\r\n      setTimeout(() => {\r\n        const firstButton = containerRef.current?.querySelector('button');\r\n        if (firstButton) {\r\n          firstButton.focus({ preventScroll: true });\r\n        }\r\n      }, 100);\r\n    }\r\n  }, [isOpen, receipts]);\r\n\r\n  return (\r\n    <BaseModal\r\n      isOpen={isOpen}\r\n      onClose={onClose}\r\n      title=\"All Transactions\"\r\n      subtitle=\"Latest transactions across all cashiers\"\r\n      size=\"lg\"\r\n      footer={\r\n        <Button\r\n          label=\"Close (Esc)\"\r\n          variant=\"secondary\"\r\n          onClick={onClose}\r\n          className=\"w-full\"\r\n        />\r\n      }\r\n    >\r\n      {loading && (\r\n        <div className=\"text-sm text-gray-600 py-4 text-center\">\r\n          Loading transactions...\r\n        </div>\r\n      )}\r\n      {error && (\r\n        <div className=\"text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg px-3 py-2 mb-2\">\r\n          {error}\r\n        </div>\r\n      )}\r\n      {!loading && !error && receipts.length === 0 && (\r\n        <div className=\"text-sm text-gray-500 py-6 text-center\">\r\n          No transactions found.\r\n        </div>\r\n      )}\r\n      <div \r\n        ref={containerRef}\r\n        className=\"space-y-2 max-h-[60vh] overflow-y-auto outline-none\"\r\n        onKeyDown={handleKeyDown}\r\n        tabIndex={0}\r\n      >\r\n        {receipts.map((r, index) => (\r\n          <button\r\n            key={`${r.transaction_id}-${r.transaction_number}`}\r\n            onClick={() => openReceipt(r)}\r\n            className={`w-full text-left border rounded-xl px-3 py-2 transition-colors ${\r\n              selectedIndex === index \r\n                ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' \r\n                : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'\r\n            }`}\r\n            onFocus={() => setSelectedIndex(index)}\r\n            tabIndex={0}\r\n          >\r\n            <div className=\"flex justify-between items-center\">\r\n              <div>\r\n                <p className=\"text-sm font-semibold text-gray-900\">\r\n                  {r.transaction_number || `TXN-${r.transaction_id || ''}`}\r\n                </p>\r\n                <p className=\"text-xs text-gray-600\">\r\n                  {new Date(r.updated_at || r.created_at).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <p className=\"text-sm font-bold text-blue-700\">\r\n                  ₱{Number(r.total_amount || r.total || 0).toFixed(2)}\r\n                </p>\r\n                <p className=\"text-[11px] text-gray-600 uppercase\">\r\n                  {r.payment?.method || r.payment_type || 'cash'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            {(r.discount_percentage || r.discount_amount) && (\r\n              <p className=\"text-[11px] text-emerald-700 mt-1\">\r\n                Discount applied{\" \"}\r\n                {r.discount_percentage\r\n                  ? `${r.discount_percentage}%`\r\n                  : `₱${Number(r.discount_amount || 0).toFixed(2)}`}\r\n              </p>\r\n            )}\r\n          </button>\r\n        ))}\r\n      </div>\r\n    </BaseModal>\r\n  );\r\n}\r\n\r\nexport default AdminReceiptsModal;\r\n"],"names":["AdminReceiptsModal","isOpen","onClose","receipts","setReceipts","useState","loading","setLoading","error","setError","selectedIndex","setSelectedIndex","containerRef","useRef","useEffect","async","token","sessionStorage","getItem","data","api","headers","Authorization","Array","isArray","e","fetchReceipts","openReceipt","useCallback","receipt","url","URL","window","location","origin","transaction_number","searchParams","set","transaction_id","String","open","toString","index","handleKeyDown","length","preventDefault","key","prev","newIndex","setTimeout","items","current","querySelectorAll","selectedItem","scrollIntoView","behavior","block","inline","focus","preventScroll","firstButton","querySelector","jsxs","BaseModal","title","subtitle","size","footer","jsx","Button","label","variant","onClick","className","children","ref","onKeyDown","tabIndex","map","r","onFocus","Date","updated_at","created_at","toLocaleString","Number","total_amount","total","toFixed","payment","method","payment_type","discount_percentage","discount_amount"],"mappings":"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"}