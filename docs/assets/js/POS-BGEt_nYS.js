import{j as e}from"./utils-BvZ1fgZQ.js";import{u as t,a as s,R as a}from"./vendor-90Ex_IR2.js";import{S as n}from"./ScannerCard-BcQLFClZ.js";import{P as o}from"./PageLayout-ZGpOeMzD.js";import{S as r,C as i,D as c,P as l,a as d,b as m,c as u,d as p}from"./ScanCustomerCartModal-BNwPbPYq.js";import{b as h,d as f,e as g,a as x}from"./index-BHIOgU_Y.js";import{N as w}from"./Nav-Admin-BGVfbYYi.js";import{P as y}from"./ProfileModal-CpfQ5Rlm.js";import{N as S}from"./NotificationDropdown-DpNQ0txa.js";import"./qr-Uy7X_oRy.js";import"./Navbar-BAKjuNh2.js";import"./Logo-KaO5eTot.js";import"./PrivacyPolicyModal-BqvnzTdR.js";import"./BaseModal-K8sibK3I.js";import"./Card-DcWNLe5M.js";import"./Input--0S5TeAm.js";import"./Modal-C4wSAEKc.js";import"./FormField-BoMr97kn.js";import"./index-rm3enqBU.js";function b(){const b=t(),[v,j]=s.useState(""),[k,_]=s.useState(1),[N,C]=s.useState([]),[O,I]=s.useState(!1),[P,L]=s.useState(!1),[M,$]=s.useState(""),[R,q]=s.useState(!1),[A,F]=s.useState(!1),[D,U]=s.useState(!1),[z,B]=s.useState(!1),[E,J]=s.useState(null),[T,W]=s.useState(!1),[H,K]=s.useState(!1),[Q,V]=s.useState(""),[Z,G]=s.useState(""),[X,Y]=s.useState(null),[ee,te]=s.useState(!1),[se,ae]=s.useState(!1),ne=s.useRef(null),oe=s.useRef(null),[re,ie]=s.useState(!1),ce=sessionStorage.getItem("auth_token"),le=JSON.parse(sessionStorage.getItem("user")||"{}"),de=a.useRef(!1),[me,ue]=s.useState("");s.useEffect(()=>{const e=e=>{if(!e.repeat)switch(e.key){case"F3":e.preventDefault(),oe.current?.focus();break;case"F4":e.preventDefault(),F(!0);break;case"F5":e.preventDefault(),I(!0);break;case"F6":e.preventDefault(),L(!0);break;case"F7":e.preventDefault(),q(!0);break;case"F8":e.preventDefault(),N.length>0&&U(!0)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[N.length]),s.useEffect(()=>{if(!Z){const e=le?.businessId||le?.business_id||"BIZ",t=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),s=Math.floor(1e3+9e3*Math.random());G(`T-${e}-${t}-${s}`)}},[]),s.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment"),t=le?.businessId||le?.business_id,s=window.opener&&!window.opener.closed,a=async(a,n)=>{const o=localStorage.getItem(a);if("success"===e&&o&&t)try{const e=JSON.parse(o);if(de.current)return;const t=`${n}_finalize_done`;if("1"===sessionStorage.getItem(t))return;de.current=!0,sessionStorage.setItem(t,"1");try{V("");const t={items:e.items||[],payment_type:n.toLowerCase(),money_received:e.total||null},a=await x("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ce}`},body:JSON.stringify(t)});a?.transaction_number&&G(a.transaction_number),a?.transaction_id&&Y(a.transaction_id),C([]);try{const e=new URL(window.location.origin+"/receipt");a?.transaction_number&&e.searchParams.set("tn",a.transaction_number),a?.transaction_id&&e.searchParams.set("tid",String(a.transaction_id)),null!=a?.total&&e.searchParams.set("total",String(a.total)),s&&window.opener?(window.opener.location.href=e.toString(),window.close()):window.location.href=e.toString()}catch(r){}}catch(i){V(`Failed to record ${n} payment`)}finally{if(localStorage.removeItem(a),!s){const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}}}catch(r){localStorage.removeItem(a)}else if("cancel"===e&&o)if(localStorage.removeItem(a),s&&window.opener)window.close();else{const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}};a("pending_gcash_cart","GCash"),a("pending_maya_cart","Maya")},[]);const pe=async(e,t=1)=>{if(e&&!(t<1)){V("");try{const s=await x(`/api/products/sku/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${ce}`}}),a=Number(s.selling_price||0),n=Number(s.stock_quantity??0);if(n<=0)return void V(`Stock for ${s.product_name} (SKU ${s.sku}) is 0.`);if(t>n)return void V(`Insufficient stock. Available: ${n}, requested: ${t}.`);C(e=>{const o=e.findIndex(e=>e.product_id===s.product_id);if(o>=0){const s=[...e],a=s[o].quantity+t;return a>n?(V(`Insufficient stock. Available: ${n}, requested: ${a}.`),e):(s[o]={...s[o],quantity:a},s)}return[...e,{product_id:s.product_id,sku:s.sku,name:s.product_name,quantity:t,price:a}]}),j(""),_(1),K(!1)}catch(s){V("Product not found")}}},he=N.reduce((e,t)=>e+t.price*t.quantity,0),fe=async(e,t=null)=>{if(0!==N.length){V("");try{const a={items:N.map(e=>({product_id:e.product_id,quantity:e.quantity,price:e.price})),payment_type:e,money_received:t,transaction_id:X,transaction_number:Z},n=await x("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ce}`},body:JSON.stringify(a)});n?.transaction_number&&G(n.transaction_number),n?.transaction_id&&Y(n.transaction_id),C([]);try{const e=new URL(window.location.origin+"/receipt");n?.transaction_number&&e.searchParams.set("tn",n.transaction_number),n?.transaction_id&&e.searchParams.set("tid",String(n.transaction_id)),null!=n?.total&&e.searchParams.set("total",String(n.total)),b(e.pathname+e.search)}catch(s){}const o=le?.businessId||le?.business_id||"BIZ",r=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),i=Math.floor(1e3+9e3*Math.random());G(`T-${o}-${r}-${i}`)}catch(a){console.error("Checkout error:",a),V("Checkout failed")}}},[ge,xe]=s.useState([]),[we,ye]=s.useState(0),Se=()=>{try{return JSON.parse(sessionStorage.getItem("read_notif_ids")||"[]")}catch(e){return[]}};s.useEffect(()=>{(async()=>{try{const e=await x("/api/logs",{headers:{Authorization:`Bearer ${ce}`}}),t=new Set(Se()),s=new Set(JSON.parse(sessionStorage.getItem("deleted_notif_ids")||"[]")),a=(e||[]).filter(e=>!s.has(e.log_id)).map(e=>({id:e.log_id,title:e.action,message:`${e.username} (${e.role}) did an action: ${e.action}`,time:new Date(e.date_time).toLocaleString(),isRead:t.has(e.log_id)}));xe(a),ye(a.filter(e=>!e.isRead).length)}catch(e){console.error("Failed to fetch notifications",e)}})()},[]),s.useEffect(()=>{ce&&(async()=>{try{const e=await x("/api/business/profile",{headers:{Authorization:`Bearer ${ce}`}});e?.business?.business_name&&ue(e.business.business_name)}catch(e){console.error("Failed to fetch business name",e)}})()},[ce]),s.useEffect(()=>{const e=e=>{ne.current&&!ne.current.contains(e.target)&&te(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const be=e.jsxs("div",{className:"flex items-center gap-1 sm:gap-4 mr-3",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("button",{onClick:async()=>{try{if(!le.store_name)return;await navigator.clipboard.writeText(le.store_name)}catch(e){}},title:"Copy store name",className:"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm",children:[e.jsx("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2"})}),e.jsx("span",{className:"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]",children:le.store_name})]})}),e.jsx("div",{className:"relative",ref:ne,children:e.jsx(S,{notifications:ge,unreadCount:we,onMarkAsRead:e=>{const t=Se();t.includes(e)||sessionStorage.setItem("read_notif_ids",JSON.stringify([...t,e])),xe(t=>t.map(t=>t.id===e?{...t,isRead:!0}:t)),ye(e=>Math.max(0,e-1))},onMarkAsUnread:e=>{const t=Se().filter(t=>t!==e);sessionStorage.setItem("read_notif_ids",JSON.stringify(t)),xe(t=>t.map(t=>t.id===e?{...t,isRead:!1}:t)),ye(e=>e+1)},onDelete:e=>{const t=JSON.parse(sessionStorage.getItem("deleted_notif_ids")||"[]");sessionStorage.setItem("deleted_notif_ids",JSON.stringify([...t,e])),xe(t=>t.filter(t=>t.id!==e));const s=ge.find(t=>t.id===e);s&&!s.isRead&&ye(e=>Math.max(0,e-1))},isOpen:ee,onToggle:()=>te(!ee),containerRef:ne})}),e.jsxs("button",{onClick:()=>ae(!0),className:"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80",children:[e.jsx("div",{className:"w-6 h-6 sm:w-7 sm:h-7 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full flex items-center justify-center text-sm font-medium shadow-md",children:le.username?.[0]?.toUpperCase()||"A"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 hidden sm:inline",children:le.username||"Admin"})]})]});return e.jsxs(o,{title:me?`${me} - POS`:"POS",sidebar:e.jsx(w,{}),headerActions:be,isSidebarOpen:re,setSidebarOpen:ie,children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-screen",children:e.jsx("main",{className:"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4",children:e.jsxs("div",{className:"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(n,{onScan:async e=>{const t=e?.[0]?.rawValue;t&&(K(!0),P?$(t):await pe(t,1))},paused:H,onResume:()=>K(!1),textMain:"text-blue-700"})}),e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx(r,{ref:oe,sku:v,setSku:j,quantity:k,setQuantity:_,handleAddToCart:async()=>{await pe(v,k)}}),Q&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),e.jsx("p",{className:"text-sm font-medium text-red-700",children:(()=>{try{const e=JSON.parse(Q);return e.error||e.message||Q}catch{return Q}})()})]})]})]}),e.jsxs("div",{className:"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0",children:[e.jsx("div",{className:"flex-1 min-h-0 max-h-[calc(100vh-280px)]",children:e.jsx(i,{cart:N,handleRemove:e=>C(N.filter((t,s)=>s!==e)),handleEditQuantity:async(e,t)=>{if(t<1)return void V("Quantity must be at least 1");const s=N[e];if(s){V("");try{const a=await x(`/api/products/sku/${encodeURIComponent(s.sku)}`,{headers:{Authorization:`Bearer ${ce}`}}),n=Number(a.stock_quantity??0);if(t>n)return void V(`Insufficient stock. Available: ${n}, requested: ${t}.`);C(s=>s.map((s,a)=>a===e?{...s,quantity:t}:s))}catch(a){V(a.message||"Failed to update quantity")}}},total:he,className:"flex-1 h-full"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0",children:[e.jsx("div",{className:"col-span-8",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3",children:[e.jsx(h,{label:"CASH LEDGER (F4)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",variant:"secondary",microinteraction:!0,onClick:()=>F(!0),icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:"DISCOUNT (F5)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>I(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:"PRICE CHECK (F6)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>L(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:"IMPORT CART (F7)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>q(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),iconPosition:"left"})]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(h,{label:"CHECKOUT (F8)",size:"md",className:"w-full h-full text-sm sm:text-base font-bold",variant:"primary",microinteraction:!0,onClick:()=>U(!0),disabled:0===N.length,icon:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"})})]})]})]})})}),e.jsx(c,{isOpen:O,onClose:()=>I(!1),onApplyDiscount:e=>{I(!1)}}),e.jsx(l,{isOpen:P,onClose:()=>L(!1),sku:M,setSku:$}),e.jsx(d,{isOpen:A,onClose:()=>F(!1)}),e.jsx(m,{isOpen:D,onClose:()=>U(!1),total:he,onSelectPayment:e=>{J(e),U(!1),"cash"===e?B(!0):"gcash"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_gcash_cart",JSON.stringify({items:N.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:he}));const{checkoutUrl:s}=await f({amount:Number(he||0),description:"POS Order",referenceNumber:Z||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(s,"_blank")}catch(e){V("Failed to init GCash"),localStorage.removeItem("pending_gcash_cart")}})():"maya"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_maya_cart",JSON.stringify({items:N.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:he}));const{checkoutUrl:s}=await g({amount:Number(he||0),description:"POS Order",referenceNumber:Z||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(s,"_blank")}catch(e){V("Failed to init Maya"),localStorage.removeItem("pending_maya_cart")}})():fe(e)}}),e.jsx(u,{isOpen:z,onClose:()=>B(!1),total:he,onConfirm:e=>{fe("cash",e),B(!1)}}),e.jsx(y,{isOpen:se,onClose:()=>ae(!1),userData:le}),e.jsx(p,{isOpen:R,onClose:()=>q(!1),onImport:(e,t)=>{t&&Y(t),C(t=>{const s=new Map(t.map(e=>[e.sku,e]));for(const a of e){const e=s.get(a.sku);e?e.quantity+=a.quantity:s.set(a.sku,{...a})}return Array.from(s.values())})}})]})}export{b as default};
//# sourceMappingURL=POS-BGEt_nYS.js.map
