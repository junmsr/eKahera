{"version":3,"file":"EnterStore-BhIJ7LGq.js","sources":["../../../frontend/src/pages/EnterStore.jsx"],"sourcesContent":["import React, { useState } from 'react';\r\nimport Background from '../components/layout/Background';\r\nimport Navbar from '../components/layout/Navbar';\r\nimport Card from '../components/common/Card';\r\nimport Button from '../components/common/Button';\r\nimport ScannerCard from '../components/ui/POS/ScannerCard';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nfunction parseBusinessIdFromCode(raw) {\r\n\ttry {\r\n\t\t// If it's a URL, parse query params\r\n\t\tconst url = new URL(raw);\r\n\t\tconst bid = url.searchParams.get('business_id') || url.searchParams.get('b') || url.searchParams.get('store');\r\n\t\tif (bid) return bid;\r\n\t} catch (_) {\r\n\t\t// not a URL; continue\r\n\t}\r\n\t// Try JSON payload\r\n\ttry {\r\n\t\tconst obj = JSON.parse(raw);\r\n\t\tif (obj && (obj.business_id || obj.businessId || obj.storeId)) {\r\n\t\t\treturn obj.business_id || obj.businessId || obj.storeId;\r\n\t\t}\r\n\t} catch (_) {}\r\n\t// Fallback: numeric/string id directly\r\n\treturn raw;\r\n}\r\n\r\nexport default function EnterStore() {\r\n\tconst navigate = useNavigate();\r\n\tconst [scannerPaused, setScannerPaused] = useState(false);\r\n\tconst [error, setError] = useState('');\r\n\r\n\tconst handleScan = async (result) => {\r\n\t\tconst code = result?.[0]?.rawValue;\r\n\t\tif (!code) return;\r\n\t\tsetScannerPaused(true);\r\n\t\tsetError('');\r\n\t\tconst businessId = parseBusinessIdFromCode(code);\r\n\t\tif (!businessId) {\r\n\t\t\tsetError('Invalid store QR');\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tsetScannerPaused(false);\r\n\t\t\t}, 500);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// Set business ID and generate a transaction number for this session\r\n\t\tlocalStorage.setItem('business_id', String(businessId));\r\n\t\t// Clear old transaction data\r\n\t\tlocalStorage.removeItem('provisionalTransactionNumber');\r\n\t\tlocalStorage.removeItem('customerCart');\r\n\t\t// Generate and save new transaction number\r\n\t\tconst timePart = new Date().toISOString().replace(/[-:T.Z]/g, '').slice(0, 14);\r\n\t\tconst randPart = Math.floor(1000 + Math.random() * 9000);\r\n\t\tconst transactionNumber = `T-${String(businessId).padStart(2, '0')}-${timePart}-${randPart}`;\r\n\t\tlocalStorage.setItem('provisionalTransactionNumber', transactionNumber);\r\n\r\n\t\t// Call backend /public/enter-store to create customer user\r\n\t\ttry {\r\n\t\t\tconst response = await fetch(\"/api/sales/public/enter-store\", {\r\n\t\t\t\tmethod: \"POST\",\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t\"Content-Type\": \"application/json\",\r\n\t\t\t\t},\r\n\t\t\t\tbody: JSON.stringify({ business_id: businessId }),\r\n\t\t\t});\r\n\r\n\t\t\tif (response.ok) {\r\n\t\t\t\tconst data = await response.json();\r\n\t\t\t\t// Store user_id and username in localStorage for use later\r\n\t\t\t\tif (data.user_id) {\r\n\t\t\t\t\tlocalStorage.setItem(\"customer_user_id\", String(data.user_id));\r\n\t\t\t\t\tconsole.log('Customer user created:', data.user_id);\r\n\t\t\t\t}\r\n\t\t\t\tif (data.username) {\r\n\t\t\t\t\tlocalStorage.setItem(\"customer_username\", data.username);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst errorData = await response.json().catch(() => ({ error: 'Failed to create customer' }));\r\n\t\t\t\tconsole.error('Failed to create customer user:', errorData);\r\n\t\t\t\t// Don't block navigation, but log the error\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error('Error creating customer user:', err);\r\n\t\t\t// Continue even if user creation fails\r\n\t\t}\r\n\r\n\t\tnavigate('/customer');\r\n\t};\r\n\r\n\treturn (\r\n\t\t<Background variant=\"gradientBlue\" pattern=\"dots\" overlay floatingElements>\r\n\t\t\t<div className=\"min-h-screen\">\r\n\t\t\t\t<div className=\"pt-20 px-4\">\r\n\t\t\t\t\t<Navbar />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div className=\"px-4 mt-6 grid gap-4\">\r\n\t\t\t\t\t<Card className=\"p-6\">\r\n\t\t\t\t\t\t<div className=\"text-2xl font-bold text-blue-900\">Scan Store QR</div>\r\n\t\t\t\t\t\t<div className=\"text-blue-700 mt-1\">Point your camera at the store QR to start self-checkout.</div>\r\n\t\t\t\t\t</Card>\r\n\t\t\t\t\t{error ? (\r\n\t\t\t\t\t\t<Card className=\"p-4 border-red-200\">\r\n\t\t\t\t\t\t\t<div className=\"text-red-700\">{error}</div>\r\n\t\t\t\t\t\t\t<div className=\"mt-2\">\r\n\t\t\t\t\t\t\t\t<Button label=\"Try again\" variant=\"secondary\" onClick={() => { setError(''); setScannerPaused(false); }} />\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</Card>\r\n\t\t\t\t\t) : null}\r\n\t\t\t\t\t<div className=\"h-[60vh]\">\r\n\t\t\t\t\t\t<ScannerCard onScan={handleScan} paused={scannerPaused} onResume={() => setScannerPaused(false)} className=\"w-full h-full\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</Background>\r\n\t);\r\n}\r\n\r\n\r\n"],"names":["EnterStore","navigate","useNavigate","scannerPaused","setScannerPaused","useState","error","setError","jsx","Background","variant","pattern","overlay","floatingElements","children","jsxs","className","Navbar","Card","Button","label","onClick","ScannerCard","onScan","async","result","code","rawValue","businessId","raw","url","URL","bid","searchParams","get","_","obj","JSON","parse","business_id","storeId","parseBusinessIdFromCode","setTimeout","localStorage","setItem","String","removeItem","timePart","Date","toISOString","replace","slice","randPart","Math","floor","random","transactionNumber","padStart","response","fetch","method","headers","body","stringify","ok","data","json","user_id","log","username","errorData","catch","err","paused","onResume"],"mappings":"yTA4BA,SAAwBA,IACvB,MAAMC,EAAWC,KACVC,EAAeC,GAAoBC,EAAAA,UAAS,IAC5CC,EAAOC,GAAYF,EAAAA,SAAS,IA2DnC,OACEG,EAAAA,IAAAC,EAAA,CAAWC,QAAQ,eAAeC,QAAQ,OAAOC,SAAO,EAACC,kBAAgB,EACzEC,SAACC,EAAAA,KAAA,MAAA,CAAIC,UAAU,eACdF,SAAA,CAAAN,MAAC,MAAI,CAAAQ,UAAU,aACdF,SAAAN,MAACS,GAAS,KAEXF,EAAAA,KAAC,MAAI,CAAAC,UAAU,uBACdF,SAAA,CAACC,EAAAA,KAAAG,EAAA,CAAKF,UAAU,MACfF,SAAA,CAACN,EAAAA,IAAA,MAAA,CAAIQ,UAAU,mCAAmCF,SAAa,kBAC9DN,EAAAA,IAAA,MAAA,CAAIQ,UAAU,qBAAqBF,SAAyD,iEAE7FR,EACAS,EAAAA,KAACG,EAAK,CAAAF,UAAU,qBACfF,SAAA,CAACN,EAAAA,IAAA,MAAA,CAAIQ,UAAU,eAAgBV,SAAMA,IACrCE,EAAAA,IAAC,MAAI,CAAAQ,UAAU,OACdF,SAAAN,EAAAA,IAACW,EAAO,CAAAC,MAAM,YAAYV,QAAQ,YAAYW,QAAS,KAAQd,EAAS,IAAKH,GAAiB,WAG7F,WACH,MAAI,CAAAY,UAAU,WACdF,SAAAN,EAAAA,IAACc,GAAYC,OA7ECC,MAAOC,IACnBC,MAAAA,EAAOD,IAAS,IAAIE,SAC1B,IAAKD,EAAM,OACXtB,GAAiB,GACjBG,EAAS,IACHqB,MAAAA,EA9BR,SAAiCC,GAC5B,IAEGC,MAAAA,EAAM,IAAIC,IAAIF,GACdG,EAAMF,EAAIG,aAAaC,IAAI,gBAAkBJ,EAAIG,aAAaC,IAAI,MAAQJ,EAAIG,aAAaC,IAAI,SACrG,GAAIF,EAAYA,OAAAA,QACRG,GAAG,CAIR,IACGC,MAAAA,EAAMC,KAAKC,MAAMT,GACvB,GAAIO,IAAQA,EAAIG,aAAeH,EAAIR,YAAcQ,EAAII,SACpD,OAAOJ,EAAIG,aAAeH,EAAIR,YAAcQ,EAAII,cAEzCL,GAAG,CAELN,OAAAA,CACR,CAYqBY,CAAwBf,GAC3C,IAAKE,EAKJ,OAJArB,EAAS,yBACTmC,WAAW,KACVtC,GAAiB,IACf,KAIJuC,aAAaC,QAAQ,cAAeC,OAAOjB,IAE3Ce,aAAaG,WAAW,gCACxBH,aAAaG,WAAW,gBAExB,MAAMC,GAAW,IAAIC,MAAOC,cAAcC,QAAQ,WAAY,IAAIC,MAAM,EAAG,IACrEC,EAAWC,KAAKC,MAAM,IAAuB,IAAhBD,KAAKE,UAClCC,EAAoB,KAAKX,OAAOjB,GAAY6B,SAAS,EAAG,QAAQV,KAAYK,IACrER,aAAAA,QAAQ,+BAAgCY,GAGjD,IACGE,MAAAA,QAAiBC,MAAM,gCAAiC,CAC7DC,OAAQ,OACRC,QAAS,CACR,eAAgB,oBAEjBC,KAAMzB,KAAK0B,UAAU,CAAExB,YAAaX,MAGrC,GAAI8B,EAASM,GAAI,CACVC,MAAAA,QAAaP,EAASQ,OAExBD,EAAKE,UACRxB,aAAaC,QAAQ,mBAAoBC,OAAOoB,EAAKE,UAC7CC,QAAAA,IAAI,yBAA0BH,EAAKE,UAExCF,EAAKI,UACKzB,aAAAA,QAAQ,oBAAqBqB,EAAKI,SAChD,KACM,CACN,MAAMC,QAAkBZ,EAASQ,OAAOK,MAAM,KAAO,CAAEjE,MAAO,+BACtDA,QAAAA,MAAM,kCAAmCgE,EAAS,QAGnDE,GACAlE,QAAAA,MAAM,gCAAiCkE,EAAG,CAInDvE,EAAS,cAuB4BwE,OAAQtE,EAAeuE,SAAU,IAAMtE,GAAiB,GAAQY,UAAU,2BAMjH"}