{"version":3,"file":"POS-CuOivqzU.js","sources":["../../../frontend/src/pages/POS.jsx"],"sourcesContent":["import React, { useState, useRef, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport ScannerCard from \"../components/ui/POS/ScannerCard\";\r\nimport PageLayout from \"../components/layout/PageLayout\";\r\nimport SkuFormCard from \"../components/ui/POS/SkuFormCard\";\r\nimport CartTableCard from \"../components/ui/POS/CartTableCard\";\r\nimport Button from \"../components/common/Button\";\r\nimport NavAdmin from \"../components/layout/Nav-Admin\";\r\n// Background gradient removed for a neutral look\r\nimport { api, createGcashCheckout, createMayaCheckout } from \"../lib/api\";\r\nimport PriceCheckModal from \"../components/modals/PriceCheckModal\";\r\nimport DiscountModal from \"../components/modals/DiscountModal\";\r\nimport CashLedgerModal from \"../components/modals/CashLedgerModal\";\r\nimport CheckoutModal from \"../components/modals/CheckoutModal\";\r\nimport CashPaymentModal from \"../components/modals/CashPaymentModal\";\r\nimport ScanCustomerCartModal from \"../components/modals/ScanCustomerCartModal\";\r\nimport ProfileModal from \"../components/modals/ProfileModal\";\r\nimport NotificationDropdown from \"../components/common/NotificationDropdown\";\r\nimport { BiBell, BiSync, BiUser } from \"react-icons/bi\";\r\nimport { MdClose } from \"react-icons/md\";\r\n\r\nfunction POS() {\r\n  const navigate = useNavigate();\r\n\r\n  // States\r\n  const [sku, setSku] = useState(\"\");\r\n  const [quantity, setQuantity] = useState(1);\r\n  const [cart, setCart] = useState([]);\r\n  const [showDiscount, setShowDiscount] = useState(false);\r\n  const [showPriceCheck, setShowPriceCheck] = useState(false);\r\n  const [priceCheckSku, setPriceCheckSku] = useState(\"\");\r\n  const [showImportCart, setShowImportCart] = useState(false);\r\n  const [showCashLedger, setShowCashLedger] = useState(false);\r\n  const [showCheckout, setShowCheckout] = useState(false);\r\n  const [showCashModal, setShowCashModal] = useState(false);\r\n  const [selectedPayment, setSelectedPayment] = useState(null);\r\n  const [darkMode, setDarkMode] = useState(false);\r\n  const [scannerPaused, setScannerPaused] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [transactionNumber, setTransactionNumber] = useState(\"\");\r\n  const [transactionId, setTransactionId] = useState(null);\r\n  const [showNotifications, setShowNotifications] = useState(false);\r\n  const [showProfileModal, setShowProfileModal] = useState(false);\r\n  const notificationRef = useRef(null);\r\n  const skuInputRef = useRef(null);\r\n  const [isSidebarOpen, setSidebarOpen] = useState(false);\r\n  const token = sessionStorage.getItem(\"auth_token\");\r\n  const user = JSON.parse(sessionStorage.getItem(\"user\") || \"{}\");\r\n  const hasFinalizedRef = React.useRef(false);\r\n  const [businessName, setBusinessName] = useState(\"\");\r\n\r\n  // Add keyboard shortcuts for buttons: F3-F8\r\n  useEffect(() => {\r\n    const keyDownHandler = (e) => {\r\n      if (e.repeat) return;\r\n      switch (e.key) {\r\n        case \"F3\":\r\n          e.preventDefault();\r\n          skuInputRef.current?.focus();\r\n          break;\r\n        case \"F4\":\r\n          e.preventDefault();\r\n          setShowCashLedger(true);\r\n          break;\r\n        case \"F5\":\r\n          e.preventDefault();\r\n          setShowDiscount(true);\r\n          break;\r\n        case \"F6\":\r\n          e.preventDefault();\r\n          setShowPriceCheck(true);\r\n          break;\r\n        case \"F7\":\r\n          e.preventDefault();\r\n          setShowImportCart(true);\r\n          break;\r\n        case \"F8\":\r\n          e.preventDefault();\r\n          if (cart.length > 0) {\r\n            setShowCheckout(true);\r\n          }\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    };\r\n    window.addEventListener(\"keydown\", keyDownHandler);\r\n    return () => window.removeEventListener(\"keydown\", keyDownHandler);\r\n  }, [cart.length]);\r\n\r\n  // Generate a client-side provisional transaction number when POS opens\r\n  useEffect(() => {\r\n    if (!transactionNumber) {\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(`T-${businessId}-${timePart}-${randPart}`);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // On mount, if returned from PayMongo success/cancel, finalize or cleanup\r\n  useEffect(() => {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const status = params.get(\"payment\");\r\n    const businessId = user?.businessId || user?.business_id;\r\n\r\n    // Check if we're in a new tab (opened from payment)\r\n    const isNewTab = window.opener && !window.opener.closed;\r\n\r\n    const finalizeOnlinePayment = async (pendingCartKey, paymentType) => {\r\n      const pending = localStorage.getItem(pendingCartKey);\r\n      if (status === \"success\" && pending && businessId) {\r\n        try {\r\n          const parsed = JSON.parse(pending);\r\n          if (hasFinalizedRef.current) return;\r\n          const guardKey = `${paymentType}_finalize_done`;\r\n          if (sessionStorage.getItem(guardKey) === \"1\") return;\r\n          hasFinalizedRef.current = true;\r\n          sessionStorage.setItem(guardKey, \"1\");\r\n          try {\r\n            setError(\"\");\r\n            const body = {\r\n              items: parsed.items || [],\r\n              payment_type: paymentType.toLowerCase(),\r\n              money_received: parsed.total || null,\r\n            };\r\n            const resp = await api(\"/api/sales/checkout\", {\r\n              method: \"POST\",\r\n              headers: { Authorization: `Bearer ${token}` },\r\n              body: JSON.stringify(body),\r\n            });\r\n            if (resp?.transaction_number)\r\n              setTransactionNumber(resp.transaction_number);\r\n            if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n            setCart([]);\r\n            try {\r\n              const url = new URL(window.location.origin + \"/receipt\");\r\n              if (resp?.transaction_number)\r\n                url.searchParams.set(\"tn\", resp.transaction_number);\r\n              if (resp?.transaction_id)\r\n                url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n              if (resp?.total != null)\r\n                url.searchParams.set(\"total\", String(resp.total));\r\n              \r\n              // If in new tab, redirect opener and close this tab\r\n              if (isNewTab && window.opener) {\r\n                window.opener.location.href = url.toString();\r\n                window.close();\r\n              } else {\r\n                window.location.href = url.toString();\r\n              }\r\n            } catch (_) {}\r\n          } catch (e) {\r\n            setError(`Failed to record ${paymentType} payment`);\r\n          } finally {\r\n            localStorage.removeItem(pendingCartKey);\r\n            if (!isNewTab) {\r\n              const url = new URL(window.location.href);\r\n              url.searchParams.delete(\"payment\");\r\n              window.history.replaceState({}, \"\", url.toString());\r\n            }\r\n          }\r\n        } catch (_) {\r\n          localStorage.removeItem(pendingCartKey);\r\n        }\r\n      } else if (status === \"cancel\" && pending) {\r\n        localStorage.removeItem(pendingCartKey);\r\n        // If in new tab, close it; otherwise just clean up URL\r\n        if (isNewTab && window.opener) {\r\n          window.close();\r\n        } else {\r\n          const url = new URL(window.location.href);\r\n          url.searchParams.delete(\"payment\");\r\n          window.history.replaceState({}, \"\", url.toString());\r\n        }\r\n      }\r\n    };\r\n    \r\n    finalizeOnlinePayment(\"pending_gcash_cart\", \"GCash\");\r\n    finalizeOnlinePayment(\"pending_maya_cart\", \"Maya\");\r\n\r\n  }, []);\r\n\r\n  const addSkuToCart = async (skuValue, qty = 1) => {\r\n    if (!skuValue || qty < 1) return;\r\n    setError(\"\");\r\n    try {\r\n      const product = await api(\r\n        `/api/products/sku/${encodeURIComponent(skuValue)}`,\r\n        {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        }\r\n      );\r\n      const price = Number(product.selling_price || 0);\r\n      const stockQty = Number(product.stock_quantity ?? 0);\r\n      if (stockQty <= 0) {\r\n        setError(\r\n          `Stock for ${product.product_name} (SKU ${product.sku}) is 0.`\r\n        );\r\n        return;\r\n      }\r\n      if (qty > stockQty) {\r\n        setError(\r\n          `Insufficient stock. Available: ${stockQty}, requested: ${qty}.`\r\n        );\r\n        return;\r\n      }\r\n      setCart((prev) => {\r\n        const existingIdx = prev.findIndex(\r\n          (i) => i.product_id === product.product_id\r\n        );\r\n        if (existingIdx >= 0) {\r\n          const next = [...prev];\r\n          const newQty = next[existingIdx].quantity + qty;\r\n          if (newQty > stockQty) {\r\n            setError(\r\n              `Insufficient stock. Available: ${stockQty}, requested: ${newQty}.`\r\n            );\r\n            return prev;\r\n          }\r\n          next[existingIdx] = { ...next[existingIdx], quantity: newQty };\r\n          return next;\r\n        }\r\n        return [\r\n          ...prev,\r\n          {\r\n            product_id: product.product_id,\r\n            sku: product.sku,\r\n            name: product.product_name,\r\n            quantity: qty,\r\n            price,\r\n          },\r\n        ];\r\n      });\r\n      setSku(\"\");\r\n      setQuantity(1);\r\n      setScannerPaused(false);\r\n    } catch (err) {\r\n      setError(\"Product not found\");\r\n    }\r\n  };\r\n\r\n  const handleAddToCart = async () => {\r\n    await addSkuToCart(sku, quantity);\r\n  };\r\n\r\n  const handleRemove = (idx) => setCart(cart.filter((_, i) => i !== idx));\r\n\r\n  const handleEditQuantity = async (idx, newQty) => {\r\n    if (newQty < 1) {\r\n      setError(\"Quantity must be at least 1\");\r\n      return;\r\n    }\r\n    const item = cart[idx];\r\n    if (!item) return;\r\n    setError(\"\");\r\n    try {\r\n      const product = await api(\r\n        `/api/products/sku/${encodeURIComponent(item.sku)}`,\r\n        {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        }\r\n      );\r\n      const stockQty = Number(product.stock_quantity ?? 0);\r\n      if (newQty > stockQty) {\r\n        setError(\r\n          `Insufficient stock. Available: ${stockQty}, requested: ${newQty}.`\r\n        );\r\n        return;\r\n      }\r\n      setCart((prev) =>\r\n        prev.map((it, i) => (i === idx ? { ...it, quantity: newQty } : it))\r\n      );\r\n    } catch (err) {\r\n      setError(err.message || \"Failed to update quantity\");\r\n    }\r\n  };\r\n\r\n  const subtotal = cart.reduce(\r\n    (sum, item) => sum + item.price * item.quantity,\r\n    0\r\n  );\r\n\r\n  // Placeholder for appliedDiscount state and discount calculation if needed\r\n  // const [appliedDiscount, setAppliedDiscount] = useState(null);\r\n  // const total = calculateTotalWithDiscount(subtotal, appliedDiscount);\r\n  // For now, total equals subtotal\r\n  const total = subtotal;\r\n\r\n  const handleCheckout = async (paymentMethod, amountReceived = null) => {\r\n    if (cart.length === 0) return;\r\n    setError(\"\");\r\n    try {\r\n      // Prepare the checkout payload\r\n      const payload = {\r\n        items: cart.map((item) => ({\r\n          product_id: item.product_id,\r\n          quantity: item.quantity,\r\n          price: item.price,\r\n        })),\r\n        payment_type: paymentMethod,\r\n        money_received: amountReceived,\r\n        transaction_id: transactionId, // Include the transaction ID if it exists\r\n        transaction_number: transactionNumber,\r\n      };\r\n\r\n      const resp = await api(\"/api/sales/checkout\", {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${token}` },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (resp?.transaction_number)\r\n        setTransactionNumber(resp.transaction_number);\r\n      if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n      setCart([]);\r\n      try {\r\n        const url = new URL(window.location.origin + \"/receipt\");\r\n        if (resp?.transaction_number)\r\n          url.searchParams.set(\"tn\", resp.transaction_number);\r\n        if (resp?.transaction_id)\r\n          url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n        if (resp?.total != null)\r\n          url.searchParams.set(\"total\", String(resp.total));\r\n        navigate(url.pathname + url.search);\r\n      } catch (_) {}\r\n      // Start a fresh provisional transaction number after successful checkout\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(`T-${businessId}-${timePart}-${randPart}`);\r\n      // setAppliedDiscount(null); // if using discount\r\n    } catch (err) {\r\n      console.error(\"Checkout error:\", err);\r\n      setError(\"Checkout failed\");\r\n    }\r\n  };\r\n\r\n  const [notifications, setNotifications] = useState([]);\r\n  const [unreadCount, setUnreadCount] = useState(0);\r\n\r\n  const getReadNotifIds = () => {\r\n    try {\r\n      return JSON.parse(sessionStorage.getItem(\"read_notif_ids\") || \"[]\");\r\n    } catch (e) {\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const fetchNotifications = async () => {\r\n    try {\r\n      const resp = await api(\"/api/logs\", {\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      });\r\n      const readIds = new Set(getReadNotifIds());\r\n      const deletedIds = new Set(\r\n        JSON.parse(sessionStorage.getItem(\"deleted_notif_ids\") || \"[]\")\r\n      );\r\n      const mapped = (resp || [])\r\n        .filter((log) => !deletedIds.has(log.log_id))\r\n        .map((log) => ({\r\n          id: log.log_id,\r\n          title: log.action,\r\n          message: `${log.username} (${log.role}) did an action: ${log.action}`,\r\n          time: new Date(log.date_time).toLocaleString(),\r\n          isRead: readIds.has(log.log_id),\r\n        }));\r\n      setNotifications(mapped);\r\n      setUnreadCount(mapped.filter((n) => !n.isRead).length);\r\n    } catch (e) {\r\n      console.error(\"Failed to fetch notifications\", e);\r\n    }\r\n  };\r\n\r\n  const handleMarkAsRead = (id) => {\r\n    const readIds = getReadNotifIds();\r\n    if (!readIds.includes(id)) {\r\n      sessionStorage.setItem(\r\n        \"read_notif_ids\",\r\n        JSON.stringify([...readIds, id])\r\n      );\r\n    }\r\n    setNotifications((notifs) =>\r\n      notifs.map((n) => (n.id === id ? { ...n, isRead: true } : n))\r\n    );\r\n    setUnreadCount((c) => Math.max(0, c - 1));\r\n  };\r\n\r\n  const handleMarkAsUnread = (id) => {\r\n    const readIds = getReadNotifIds();\r\n    const filtered = readIds.filter((rid) => rid !== id);\r\n    sessionStorage.setItem(\"read_notif_ids\", JSON.stringify(filtered));\r\n    setNotifications((notifs) =>\r\n      notifs.map((n) => (n.id === id ? { ...n, isRead: false } : n))\r\n    );\r\n    setUnreadCount((c) => c + 1);\r\n  };\r\n\r\n  const handleDeleteNotification = (id) => {\r\n    const deletedIds = JSON.parse(\r\n      sessionStorage.getItem(\"deleted_notif_ids\") || \"[]\"\r\n    );\r\n    sessionStorage.setItem(\r\n      \"deleted_notif_ids\",\r\n      JSON.stringify([...deletedIds, id])\r\n    );\r\n    setNotifications((notifs) => notifs.filter((n) => n.id !== id));\r\n    // Update unread count if deleted notification was unread\r\n    const notif = notifications.find((n) => n.id === id);\r\n    if (notif && !notif.isRead) {\r\n      setUnreadCount((c) => Math.max(0, c - 1));\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchNotifications();\r\n  }, []);\r\n\r\n  // Fetch business name\r\n  useEffect(() => {\r\n    const fetchBusinessName = async () => {\r\n      try {\r\n        const resp = await api(\"/api/business/profile\", {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n        if (resp?.business?.business_name) {\r\n          setBusinessName(resp.business.business_name);\r\n        }\r\n      } catch (e) {\r\n        console.error(\"Failed to fetch business name\", e);\r\n      }\r\n    };\r\n    if (token) {\r\n      fetchBusinessName();\r\n    }\r\n  }, [token]);\r\n\r\n  // Close dropdown when clicking outside notifications\r\n  useEffect(() => {\r\n    const handleClickOutside = (event) => {\r\n      if (\r\n        notificationRef.current &&\r\n        !notificationRef.current.contains(event.target)\r\n      ) {\r\n        setShowNotifications(false);\r\n      }\r\n    };\r\n    document.addEventListener(\"mousedown\", handleClickOutside);\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n  }, []);\r\n\r\n  const handleCopyTn = async () => {\r\n    try {\r\n      if (!user.store_name) return;\r\n      await navigator.clipboard.writeText(user.store_name);\r\n    } catch (_) {}\r\n  };\r\n\r\n  const headerActions = (\r\n    <div className=\"flex items-center gap-1 sm:gap-4 mr-3\">\r\n      {/* Transaction Number display */}\r\n      <div className=\"flex-1 flex items-center justify-center\">\r\n        <button\r\n          onClick={handleCopyTn}\r\n          title=\"Copy store name\"\r\n          className=\"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm\"\r\n        >\r\n          <svg\r\n            className=\"w-3 h-3 sm:w-4 sm:h-4\"\r\n            fill=\"none\"\r\n            stroke=\"currentColor\"\r\n            viewBox=\"0 0 24 24\"\r\n          >\r\n            <path\r\n              strokeLinecap=\"round\"\r\n              strokeLinejoin=\"round\"\r\n              strokeWidth={2}\r\n              d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2\"\r\n            />\r\n          </svg>\r\n          <span className=\"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]\">\r\n            {user.store_name}\r\n          </span>\r\n        </button>\r\n      </div>\r\n      {/* Notification Button with Dropdown */}\r\n      <div className=\"relative\" ref={notificationRef}>\r\n        <NotificationDropdown\r\n          notifications={notifications}\r\n          unreadCount={unreadCount}\r\n          onMarkAsRead={handleMarkAsRead}\r\n          onMarkAsUnread={handleMarkAsUnread}\r\n          onDelete={handleDeleteNotification}\r\n          isOpen={showNotifications}\r\n          onToggle={() => setShowNotifications(!showNotifications)}\r\n          containerRef={notificationRef}\r\n        />\r\n      </div>\r\n\r\n      {/* Cashier Profile Button */}\r\n      <button\r\n        onClick={() => setShowProfileModal(true)}\r\n        className=\"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80\"\r\n      >\r\n        <div className=\"w-6 h-6 sm:w-7 sm:h-7 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full flex items-center justify-center text-sm font-medium shadow-md\">\r\n          {user.username?.[0]?.toUpperCase() || \"A\"}\r\n        </div>\r\n        <span className=\"text-sm font-medium text-gray-700 hidden sm:inline\">\r\n          {user.username || \"Admin\"}\r\n        </span>\r\n      </button>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <PageLayout\r\n      title={businessName ? `${businessName} - POS` : \"POS\"}\r\n      sidebar={<NavAdmin />}\r\n      headerActions={headerActions}\r\n      isSidebarOpen={isSidebarOpen}\r\n      setSidebarOpen={setSidebarOpen}\r\n    >\r\n      <div className=\"flex-1 flex flex-col min-h-screen\">\r\n        <main className=\"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4\">\r\n          <div className=\"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12\">\r\n            {/* Left Column - Scanner, SKU Form, Transaction */}\r\n            <div className=\"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4\">\r\n              {/* ScannerCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <ScannerCard\r\n                  onScan={async (result) => {\r\n                    const code = result?.[0]?.rawValue;\r\n                    if (!code) return;\r\n                    setScannerPaused(true);\r\n                    if (showPriceCheck) {\r\n                      setPriceCheckSku(code);\r\n                    } else {\r\n                      await addSkuToCart(code, 1);\r\n                    }\r\n                  }}\r\n                  paused={scannerPaused}\r\n                  onResume={() => setScannerPaused(false)}\r\n                  textMain=\"text-blue-700\"\r\n                />\r\n              </div>\r\n\r\n              {/* SkuFormCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <SkuFormCard\r\n                  ref={skuInputRef}\r\n                  sku={sku}\r\n                  setSku={setSku}\r\n                  quantity={quantity}\r\n                  setQuantity={setQuantity}\r\n                  handleAddToCart={handleAddToCart}\r\n                />\r\n                {error && (\r\n                  <div className=\"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3\">\r\n                    <svg\r\n                      className=\"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5\"\r\n                      fill=\"none\"\r\n                      stroke=\"currentColor\"\r\n                      viewBox=\"0 0 24 24\"\r\n                    >\r\n                      <path\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        strokeWidth={2}\r\n                        d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\"\r\n                      />\r\n                    </svg>\r\n                    <p className=\"text-sm font-medium text-red-700\">\r\n                      {(() => {\r\n                        try {\r\n                          const parsed = JSON.parse(error);\r\n                          return parsed.error || parsed.message || error;\r\n                        } catch {\r\n                          return error;\r\n                        }\r\n                      })()}\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* TransactionCard */}\r\n              {/* Removed card display; transaction number now shown in header */}\r\n              {/* <div className=\"flex-shrink-0\">\r\n                  <TransactionCard\r\n                    transactionNumber={transactionNumber}\r\n                    transactionId={transactionId}\r\n                  />\r\n                </div> */}\r\n            </div>\r\n\r\n            {/* Right Column - Cart and Actions */}\r\n            <div className=\"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0\">\r\n              {/* CartTableCard */}\r\n              <div className=\"flex-1 min-h-0 max-h-[calc(100vh-280px)]\">\r\n                <CartTableCard\r\n                  cart={cart}\r\n                  handleRemove={handleRemove}\r\n                  handleEditQuantity={handleEditQuantity}\r\n                  total={total}\r\n                  className=\"flex-1 h-full\"\r\n                />\r\n              </div>\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0\">\r\n                {/* Grouped Buttons */}\r\n                <div className=\"col-span-8\">\r\n                  <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3\">\r\n                    <Button\r\n                      label=\"CASH LEDGER (F4)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      onClick={() => setShowCashLedger(true)}\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"DISCOUNT (F5)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowDiscount(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"PRICE CHECK (F6)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowPriceCheck(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"IMPORT CART (F7)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowImportCart(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Checkout Button */}\r\n                <div className=\"col-span-4\">\r\n                  <Button\r\n                    label=\"CHECKOUT (F8)\"\r\n                    size=\"md\"\r\n                    className=\"w-full h-full text-sm sm:text-base font-bold\"\r\n                    variant=\"primary\"\r\n                    microinteraction\r\n                    onClick={() => setShowCheckout(true)}\r\n                    disabled={cart.length === 0}\r\n                    icon={\r\n                      <svg\r\n                        className=\"w-5 h-5\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        viewBox=\"0 0 24 24\"\r\n                      >\r\n                        <path\r\n                          strokeLinecap=\"round\"\r\n                          strokeLinejoin=\"round\"\r\n                          strokeWidth={2}\r\n                          d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                        />\r\n                      </svg>\r\n                    }\r\n                    iconPosition=\"left\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </main>\r\n      </div>\r\n      {/* Modals */}\r\n      <DiscountModal\r\n        isOpen={showDiscount}\r\n        onClose={() => setShowDiscount(false)}\r\n        onApplyDiscount={(discount) => {\r\n          // Apply the discount to your transaction/cart here\r\n          // Optionally handle discount state update\r\n          setShowDiscount(false);\r\n        }}\r\n      />\r\n      <PriceCheckModal\r\n        isOpen={showPriceCheck}\r\n        onClose={() => setShowPriceCheck(false)}\r\n        sku={priceCheckSku}\r\n        setSku={setPriceCheckSku}\r\n      />\r\n      <CashLedgerModal\r\n        isOpen={showCashLedger}\r\n        onClose={() => setShowCashLedger(false)}\r\n      />\r\n      <CheckoutModal\r\n        isOpen={showCheckout}\r\n        onClose={() => setShowCheckout(false)}\r\n        total={total}\r\n        onSelectPayment={(method) => {\r\n          setSelectedPayment(method);\r\n          setShowCheckout(false);\r\n\r\n          if (method === \"cash\") {\r\n            setShowCashModal(true);\r\n          } else if (method === \"gcash\") {\r\n            (async () => {\r\n              try {\r\n                const successUrl =\r\n                  window.location.origin + \"/pos?payment=success\";\r\n                const cancelUrl =\r\n                  window.location.origin + \"/pos?payment=cancel\";\r\n                // persist cart to finalize after redirect back\r\n                localStorage.setItem(\r\n                  \"pending_gcash_cart\",\r\n                  JSON.stringify({\r\n                    items: cart.map((i) => ({\r\n                      product_id: i.product_id,\r\n                      quantity: i.quantity,\r\n                    })),\r\n                    total,\r\n                  })\r\n                );\r\n                const { checkoutUrl } = await createGcashCheckout({\r\n                  amount: Number(total || 0),\r\n                  description: \"POS Order\",\r\n                  referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                  cancelUrl,\r\n                  successUrl,\r\n                });\r\n                window.open(checkoutUrl, '_blank');\r\n              } catch (e) {\r\n                setError(\"Failed to init GCash\");\r\n                localStorage.removeItem(\"pending_gcash_cart\");\r\n              }\r\n            })();\r\n          } else if (method === \"maya\") {\r\n            (async () => {\r\n              try {\r\n                const successUrl =\r\n                  window.location.origin + \"/pos?payment=success\";\r\n                const cancelUrl =\r\n                  window.location.origin + \"/pos?payment=cancel\";\r\n                // persist cart to finalize after redirect back\r\n                localStorage.setItem(\r\n                  \"pending_maya_cart\",\r\n                  JSON.stringify({\r\n                    items: cart.map((i) => ({\r\n                      product_id: i.product_id,\r\n                      quantity: i.quantity,\r\n                    })),\r\n                    total,\r\n                  })\r\n                );\r\n                const { checkoutUrl } = await createMayaCheckout({\r\n                  amount: Number(total || 0),\r\n                  description: \"POS Order\",\r\n                  referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                  cancelUrl,\r\n                  successUrl,\r\n                });\r\n                window.open(checkoutUrl, '_blank');\r\n              } catch (e) {\r\n                setError(\"Failed to init Maya\");\r\n                localStorage.removeItem(\"pending_maya_cart\");\r\n              }\r\n            })();\r\n          } else {\r\n            handleCheckout(method);\r\n          }\r\n        }}\r\n      />\r\n      <CashPaymentModal\r\n        isOpen={showCashModal}\r\n        onClose={() => setShowCashModal(false)}\r\n        total={total}\r\n        onConfirm={(amountReceived) => {\r\n          handleCheckout(\"cash\", amountReceived);\r\n          setShowCashModal(false);\r\n        }}\r\n      />\r\n      <ProfileModal\r\n        isOpen={showProfileModal}\r\n        onClose={() => setShowProfileModal(false)}\r\n        userData={user}\r\n      />\r\n      <ScanCustomerCartModal\r\n        isOpen={showImportCart}\r\n        onClose={() => setShowImportCart(false)}\r\n        onImport={(items, transactionId) => {\r\n          // If we have a transaction ID from the scanned cart, use it\r\n          if (transactionId) {\r\n            setTransactionId(transactionId);\r\n          }\r\n          \r\n          // Merge imported items into current cart\r\n          setCart((prev) => {\r\n            const bySku = new Map(prev.map((i) => [i.sku, i]));\r\n            for (const it of items) {\r\n              const existing = bySku.get(it.sku);\r\n              if (existing) {\r\n                existing.quantity += it.quantity;\r\n              } else {\r\n                bySku.set(it.sku, { ...it });\r\n              }\r\n            }\r\n            return Array.from(bySku.values());\r\n          });\r\n        }}\r\n      />\r\n    </PageLayout>\r\n  );\r\n}\r\n\r\nexport default POS;\r\n"],"names":["POS","navigate","useNavigate","sku","setSku","useState","quantity","setQuantity","cart","setCart","showDiscount","setShowDiscount","showPriceCheck","setShowPriceCheck","priceCheckSku","setPriceCheckSku","showImportCart","setShowImportCart","showCashLedger","setShowCashLedger","showCheckout","setShowCheckout","showCashModal","setShowCashModal","selectedPayment","setSelectedPayment","darkMode","setDarkMode","scannerPaused","setScannerPaused","error","setError","transactionNumber","setTransactionNumber","transactionId","setTransactionId","showNotifications","setShowNotifications","showProfileModal","setShowProfileModal","notificationRef","useRef","skuInputRef","isSidebarOpen","setSidebarOpen","token","sessionStorage","getItem","user","JSON","parse","hasFinalizedRef","React","businessName","setBusinessName","useEffect","keyDownHandler","e","repeat","key","preventDefault","current","focus","length","addEventListener","window","removeEventListener","businessId","business_id","timePart","Date","toISOString","replace","slice","randPart","Math","floor","random","status","URLSearchParams","location","search","get","isNewTab","opener","closed","finalizeOnlinePayment","async","pendingCartKey","paymentType","pending","localStorage","parsed","guardKey","setItem","body","items","payment_type","toLowerCase","money_received","total","resp","api","method","headers","Authorization","stringify","transaction_number","transaction_id","url","URL","origin","searchParams","set","String","href","toString","close","_","removeItem","delete","history","replaceState","addSkuToCart","skuValue","qty","product","encodeURIComponent","price","Number","selling_price","stockQty","stock_quantity","product_name","prev","existingIdx","findIndex","i","product_id","next","newQty","name","err","reduce","sum","item","handleCheckout","paymentMethod","amountReceived","payload","map","pathname","notifications","setNotifications","unreadCount","setUnreadCount","getReadNotifIds","readIds","Set","deletedIds","mapped","filter","log","has","log_id","id","title","action","message","username","role","time","date_time","toLocaleString","isRead","n","fetchNotifications","business","business_name","fetchBusinessName","handleClickOutside","event","contains","target","document","headerActions","jsxs","className","children","jsx","onClick","store_name","navigator","clipboard","writeText","fill","stroke","viewBox","strokeLinecap","strokeLinejoin","strokeWidth","d","ref","NotificationDropdown","onMarkAsRead","includes","notifs","max","c","onMarkAsUnread","filtered","rid","onDelete","notif","find","isOpen","onToggle","containerRef","toUpperCase","PageLayout","sidebar","NavAdmin","ScannerCard","onScan","result","code","rawValue","paused","onResume","textMain","SkuFormCard","handleAddToCart","CartTableCard","handleRemove","idx","handleEditQuantity","it","Button","label","size","variant","microinteraction","icon","iconPosition","disabled","DiscountModal","onClose","onApplyDiscount","discount","PriceCheckModal","CashLedgerModal","CheckoutModal","onSelectPayment","successUrl","cancelUrl","checkoutUrl","createGcashCheckout","amount","description","referenceNumber","now","open","createMayaCheckout","CashPaymentModal","onConfirm","ProfileModal","userData","ScanCustomerCartModal","onImport","bySku","Map","existing","Array","from","values"],"mappings":"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"}