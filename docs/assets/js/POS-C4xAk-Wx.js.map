{"version":3,"file":"POS-C4xAk-Wx.js","sources":["../../../frontend/src/components/modals/AdminReceiptsModal.jsx","../../../frontend/src/pages/POS.jsx"],"sourcesContent":["import React, { useEffect, useState, useCallback, useRef } from \"react\";\r\nimport BaseModal from \"./BaseModal\";\r\nimport Button from \"../common/Button\";\r\nimport { api } from \"../../lib/api\";\r\nimport { useKeyboardShortcuts } from \"../../hooks/useKeyboardShortcuts\";\r\n\r\nfunction AdminReceiptsModal({ isOpen, onClose }) {\r\n  const [receipts, setReceipts] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [selectedIndex, setSelectedIndex] = useState(0);\r\n  const containerRef = useRef(null);\r\n  const modalContentRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n    const fetchReceipts = async () => {\r\n      setLoading(true);\r\n      setError(\"\");\r\n      try {\r\n        const token = sessionStorage.getItem(\"auth_token\");\r\n        const data = await api(\"/api/sales/business/recent\", {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n        setReceipts(Array.isArray(data) ? data : []);\r\n      } catch (e) {\r\n        console.error(\"Error fetching receipts:\", e);\r\n        setError(\"Failed to load receipts. Please try again.\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    fetchReceipts();\r\n  }, [isOpen]);\r\n\r\n  const openReceipt = useCallback((receipt) => {\r\n    const url = new URL(window.location.origin + \"/receipt\");\r\n    if (receipt.transaction_number)\r\n      url.searchParams.set(\"tn\", receipt.transaction_number);\r\n    if (receipt.transaction_id)\r\n      url.searchParams.set(\"tid\", String(receipt.transaction_id));\r\n    window.open(url.toString(), \"_blank\");\r\n  }, []);\r\n\r\n  const openReceiptByIndex = useCallback((index) => {\r\n    if (!receipts[index]) return;\r\n    openReceipt(receipts[index]);\r\n  }, [receipts, openReceipt]);\r\n\r\n  // Handle keyboard navigation\r\n  const handleKeyDown = useCallback((e) => {\r\n    if (!isOpen || !receipts.length) return;\r\n    e.preventDefault();\r\n\r\n    switch (e.key) {\r\n      case 'ArrowUp': {\r\n        setSelectedIndex(prev => {\r\n          const newIndex = prev <= 0 ? receipts.length - 1 : prev - 1;\r\n          // Use setTimeout to ensure state update is complete before scrolling\r\n          setTimeout(() => {\r\n            const items = containerRef.current?.querySelectorAll('button');\r\n            const selectedItem = items?.[newIndex];\r\n            if (selectedItem) {\r\n              // Scroll the item into view with smooth behavior\r\n              selectedItem.scrollIntoView({\r\n                behavior: 'smooth',\r\n                block: 'nearest',\r\n                inline: 'nearest'\r\n              });\r\n              selectedItem.focus({ preventScroll: true });\r\n            }\r\n          }, 0);\r\n          return newIndex;\r\n        });\r\n        break;\r\n      }\r\n      case 'ArrowDown': {\r\n        setSelectedIndex(prev => {\r\n          const newIndex = prev >= receipts.length - 1 ? 0 : prev + 1;\r\n          // Use setTimeout to ensure state update is complete before scrolling\r\n          setTimeout(() => {\r\n            const items = containerRef.current?.querySelectorAll('button');\r\n            const selectedItem = items?.[newIndex];\r\n            if (selectedItem) {\r\n              // Scroll the item into view with smooth behavior\r\n              selectedItem.scrollIntoView({\r\n                behavior: 'smooth',\r\n                block: 'nearest',\r\n                inline: 'nearest'\r\n              });\r\n              selectedItem.focus({ preventScroll: true });\r\n            }\r\n          }, 0);\r\n          return newIndex;\r\n        });\r\n        break;\r\n      }\r\n      case 'Enter':\r\n        e.preventDefault();\r\n        if (receipts[selectedIndex]) {\r\n          openReceipt(receipts[selectedIndex]);\r\n        }\r\n        break;\r\n      case 'Escape':\r\n        onClose();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }, [isOpen, receipts, selectedIndex, onClose, openReceipt]);\r\n\r\n  // Set up keyboard shortcuts - removed as we're handling it in handleKeyDown\r\n\r\n  // Reset selected index when modal opens or receipts change\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setSelectedIndex(0);\r\n      // Focus the container when it opens\r\n      setTimeout(() => {\r\n        const firstButton = containerRef.current?.querySelector('button');\r\n        if (firstButton) {\r\n          firstButton.focus({ preventScroll: true });\r\n        }\r\n      }, 100);\r\n    }\r\n  }, [isOpen, receipts]);\r\n\r\n  return (\r\n    <BaseModal\r\n      isOpen={isOpen}\r\n      onClose={onClose}\r\n      title=\"All Transactions\"\r\n      subtitle=\"Latest transactions across all cashiers\"\r\n      size=\"lg\"\r\n      footer={\r\n        <Button\r\n          label=\"Close (Esc)\"\r\n          variant=\"secondary\"\r\n          onClick={onClose}\r\n          className=\"w-full\"\r\n        />\r\n      }\r\n    >\r\n      {loading && (\r\n        <div className=\"text-sm text-gray-600 py-4 text-center\">\r\n          Loading transactions...\r\n        </div>\r\n      )}\r\n      {error && (\r\n        <div className=\"text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg px-3 py-2 mb-2\">\r\n          {error}\r\n        </div>\r\n      )}\r\n      {!loading && !error && receipts.length === 0 && (\r\n        <div className=\"text-sm text-gray-500 py-6 text-center\">\r\n          No transactions found.\r\n        </div>\r\n      )}\r\n      <div \r\n        ref={containerRef}\r\n        className=\"space-y-2 max-h-[60vh] overflow-y-auto outline-none\"\r\n        onKeyDown={handleKeyDown}\r\n        tabIndex={0}\r\n      >\r\n        {receipts.map((r, index) => (\r\n          <button\r\n            key={`${r.transaction_id}-${r.transaction_number}`}\r\n            onClick={() => openReceipt(r)}\r\n            className={`w-full text-left border rounded-xl px-3 py-2 transition-colors ${\r\n              selectedIndex === index \r\n                ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' \r\n                : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'\r\n            }`}\r\n            onFocus={() => setSelectedIndex(index)}\r\n            tabIndex={0}\r\n          >\r\n            <div className=\"flex justify-between items-center\">\r\n              <div>\r\n                <p className=\"text-sm font-semibold text-gray-900\">\r\n                  {r.transaction_number || `TXN-${r.transaction_id || ''}`}\r\n                </p>\r\n                <p className=\"text-xs text-gray-600\">\r\n                  {new Date(r.updated_at || r.created_at).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <p className=\"text-sm font-bold text-blue-700\">\r\n                  ₱{Number(r.total_amount || r.total || 0).toFixed(2)}\r\n                </p>\r\n                <p className=\"text-[11px] text-gray-600 uppercase\">\r\n                  {r.payment?.method || r.payment_type || 'cash'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            {(r.discount_percentage || r.discount_amount) && (\r\n              <p className=\"text-[11px] text-emerald-700 mt-1\">\r\n                Discount applied{\" \"}\r\n                {r.discount_percentage\r\n                  ? `${r.discount_percentage}%`\r\n                  : `₱${Number(r.discount_amount || 0).toFixed(2)}`}\r\n              </p>\r\n            )}\r\n          </button>\r\n        ))}\r\n      </div>\r\n    </BaseModal>\r\n  );\r\n}\r\n\r\nexport default AdminReceiptsModal;\r\n","import React, { useState, useRef, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport ScannerCard from \"../components/ui/POS/ScannerCard\";\r\nimport PageLayout from \"../components/layout/PageLayout\";\r\nimport SkuFormCard from \"../components/ui/POS/SkuFormCard\";\r\nimport CartTableCard from \"../components/ui/POS/CartTableCard\";\r\nimport Button from \"../components/common/Button\";\r\nimport NavAdmin from \"../components/layout/Nav-Admin\";\r\n// Background gradient removed for a neutral look\r\nimport { api, createGcashCheckout, createMayaCheckout } from \"../lib/api\";\r\nimport PriceCheckModal from \"../components/modals/PriceCheckModal\";\r\nimport DiscountModal from \"../components/modals/DiscountModal\";\r\nimport CashLedgerModal from \"../components/modals/CashLedgerModal\";\r\nimport CheckoutModal from \"../components/modals/CheckoutModal\";\r\nimport CashPaymentModal from \"../components/modals/CashPaymentModal\";\r\nimport ScanCustomerCartModal from \"../components/modals/ScanCustomerCartModal\";\r\nimport { BiReceipt, BiSync } from \"react-icons/bi\";\r\nimport AdminReceiptsModal from \"../components/modals/AdminReceiptsModal\";\r\nimport { MdClose } from \"react-icons/md\";\r\nimport { useKeyboardShortcuts } from \"../hooks/useKeyboardShortcuts\";\r\n\r\nfunction POS() {\r\n  const navigate = useNavigate();\r\n\r\n  // States\r\n  const [sku, setSku] = useState(\"\");\r\n  const [quantity, setQuantity] = useState(1);\r\n  const [cart, setCart] = useState([]);\r\n  const [showDiscount, setShowDiscount] = useState(false);\r\n  const [showPriceCheck, setShowPriceCheck] = useState(false);\r\n  const [priceCheckSku, setPriceCheckSku] = useState(\"\");\r\n  const [showImportCart, setShowImportCart] = useState(false);\r\n  const [showCashLedger, setShowCashLedger] = useState(false);\r\n  const [showCheckout, setShowCheckout] = useState(false);\r\n  const [showCashModal, setShowCashModal] = useState(false);\r\n  const [selectedPayment, setSelectedPayment] = useState(null);\r\n  const [darkMode, setDarkMode] = useState(false);\r\n  const [scannerPaused, setScannerPaused] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [transactionNumber, setTransactionNumber] = useState(\"\");\r\n  const [transactionId, setTransactionId] = useState(null);\r\n  const [showReceipts, setShowReceipts] = useState(false);\r\n  const skuInputRef = useRef(null);\r\n  const [isSidebarOpen, setSidebarOpen] = useState(false);\r\n  const [selectedItemIdx, setSelectedItemIdx] = useState(-1);\r\n  const [editingIdx, setEditingIdx] = useState(null);\r\n  const token = sessionStorage.getItem(\"auth_token\");\r\n  const user = JSON.parse(sessionStorage.getItem(\"user\") || \"{}\");\r\n  const hasFinalizedRef = React.useRef(false);\r\n  const [businessName, setBusinessName] = useState(\"\");\r\n  const [selectedCartIdx, setSelectedCartIdx] = useState(0);\r\n  const [editingCartItem, setEditingCartItem] = useState(null);\r\n  const [editQty, setEditQty] = useState('1');\r\n  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);\r\n  const [appliedDiscount, setAppliedDiscount] = useState(null);\r\n  const quantityInputRef = useRef(null);\r\n\r\n  // Set editing cart item and initialize quantity\r\n  const setSelectedCartItem = (idx) => {\r\n    setSelectedCartIdx(idx);\r\n    if (idx >= 0 && idx < cart.length) {\r\n      setEditQty(String(cart[idx].quantity));\r\n    }\r\n  };\r\n\r\n  // Generate a client-side provisional transaction number when POS opens\r\n  useEffect(() => {\r\n    if (!transactionNumber) {\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(\r\n        `T-${businessId.toString().padStart(2, \"0\")}-${timePart}-${randPart}`\r\n      );\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // On mount, if returned from PayMongo success/cancel, finalize or cleanup\r\n  useEffect(() => {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const status = params.get(\"payment\");\r\n    const businessId = user?.businessId || user?.business_id;\r\n\r\n    // Check if we're in a new tab (opened from payment)\r\n    const isNewTab = window.opener && !window.opener.closed;\r\n\r\n    const finalizeOnlinePayment = async (pendingCartKey, paymentType) => {\r\n      const pending = localStorage.getItem(pendingCartKey);\r\n      if (status === \"success\" && pending && businessId) {\r\n        try {\r\n          const parsed = JSON.parse(pending);\r\n          if (hasFinalizedRef.current) return;\r\n          const guardKey = `${paymentType}_finalize_done`;\r\n          if (sessionStorage.getItem(guardKey) === \"1\") return;\r\n          hasFinalizedRef.current = true;\r\n          sessionStorage.setItem(guardKey, \"1\");\r\n          try {\r\n            setError(\"\");\r\n            const body = {\r\n              items: parsed.items || [],\r\n              payment_type: paymentType.toLowerCase(),\r\n              money_received: parsed.total || null,\r\n              discount_id: parsed.discount_id || null,\r\n              discount_percentage: parsed.discount_percentage || null,\r\n              discount_amount: parsed.discount_amount || null,\r\n            };\r\n            const resp = await api(\"/api/sales/checkout\", {\r\n              method: \"POST\",\r\n              headers: { Authorization: `Bearer ${token}` },\r\n              body: JSON.stringify(body),\r\n            });\r\n            if (resp?.transaction_number)\r\n              setTransactionNumber(resp.transaction_number);\r\n            if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n            setCart([]);\r\n            try {\r\n              const url = new URL(window.location.origin + \"/receipt\");\r\n              if (resp?.transaction_number)\r\n                url.searchParams.set(\"tn\", resp.transaction_number);\r\n              if (resp?.transaction_id)\r\n                url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n              if (resp?.total != null)\r\n                url.searchParams.set(\"total\", String(resp.total));\r\n\r\n              // If in new tab, redirect opener and close this tab\r\n              if (isNewTab && window.opener) {\r\n                window.opener.location.href = url.toString();\r\n                window.close();\r\n              } else {\r\n                window.location.href = url.toString();\r\n              }\r\n            } catch (_) {}\r\n          } catch (e) {\r\n            setError(`Failed to record ${paymentType} payment`);\r\n          } finally {\r\n            localStorage.removeItem(pendingCartKey);\r\n            if (!isNewTab) {\r\n              const url = new URL(window.location.href);\r\n              url.searchParams.delete(\"payment\");\r\n              window.history.replaceState({}, \"\", url.toString());\r\n            }\r\n          }\r\n        } catch (_) {\r\n          localStorage.removeItem(pendingCartKey);\r\n        }\r\n      } else if (status === \"cancel\" && pending) {\r\n        localStorage.removeItem(pendingCartKey);\r\n        // If in new tab, close it; otherwise just clean up URL\r\n        if (isNewTab && window.opener) {\r\n          window.close();\r\n        } else {\r\n          const url = new URL(window.location.href);\r\n          url.searchParams.delete(\"payment\");\r\n          window.history.replaceState({}, \"\", url.toString());\r\n        }\r\n      }\r\n    };\r\n\r\n    finalizeOnlinePayment(\"pending_gcash_cart\", \"GCash\");\r\n    finalizeOnlinePayment(\"pending_maya_cart\", \"Maya\");\r\n  }, []);\r\n\r\n  const addSkuToCart = async (skuValue, qty = 1) => {\r\n    if (!skuValue || qty < 1) return;\r\n    setError(\"\");\r\n    try {\r\n      const product = await api(\r\n        `/api/products/sku/${encodeURIComponent(skuValue)}`,\r\n        {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        }\r\n      );\r\n      const price = Number(product.selling_price || 0);\r\n      const stockQty = Number(product.stock_quantity ?? 0);\r\n      if (stockQty <= 0) {\r\n        setError(\r\n          `Stock for ${product.product_name} (SKU ${product.sku}) is 0.`\r\n        );\r\n        return;\r\n      }\r\n      if (qty > stockQty) {\r\n        setError(\r\n          `Insufficient stock. Available: ${stockQty}, requested: ${qty}.`\r\n        );\r\n        return;\r\n      }\r\n      setCart((prev) => {\r\n        const existingIdx = prev.findIndex(\r\n          (i) => i.product_id === product.product_id\r\n        );\r\n        if (existingIdx >= 0) {\r\n          const next = [...prev];\r\n          const newQty = next[existingIdx].quantity + qty;\r\n          if (newQty > stockQty) {\r\n            setError(\r\n              `Insufficient stock. Available: ${stockQty}, requested: ${newQty}.`\r\n            );\r\n            return prev;\r\n          }\r\n          next[existingIdx] = { ...next[existingIdx], quantity: newQty };\r\n          return next;\r\n        }\r\n        return [\r\n          ...prev,\r\n          {\r\n            product_id: product.product_id,\r\n            sku: product.sku,\r\n            name: product.product_name,\r\n            quantity: qty,\r\n            price,\r\n          },\r\n        ];\r\n      });\r\n      setSku(\"\");\r\n      setQuantity(1);\r\n      setScannerPaused(false);\r\n    } catch (err) {\r\n      setError(\"Product not found\");\r\n    }\r\n  };\r\n\r\n  const handleAddToCart = async () => {\r\n    await addSkuToCart(sku, quantity);\r\n  };\r\n\r\n  const handleRemove = (idx) => {\r\n    if (idx >= 0 && idx < cart.length) {\r\n      setCart(cart.filter((_, i) => i !== idx));\r\n    }\r\n  };\r\n\r\n  const handleEditQuantity = async (idx, qty) => {\r\n    const newQty = qty === '' ? 1 : Math.max(1, Number(qty) || 1);\r\n    const item = cart[idx];\r\n    if (!item) return;\r\n    setError(\"\");\r\n    try {\r\n      const product = await api(\r\n        `/api/products/sku/${encodeURIComponent(item.sku)}`,\r\n        {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        }\r\n      );\r\n      const stockQty = Number(product.stock_quantity ?? 0);\r\n      if (newQty > stockQty) {\r\n        setError(\r\n          `Insufficient stock. Available: ${stockQty}, requested: ${newQty}.`\r\n        );\r\n        return;\r\n      }\r\n      setCart((prev) =>\r\n        prev.map((item, i) =>\r\n          i === idx ? { ...item, quantity: newQty } : item\r\n        )\r\n      );\r\n      setEditQty(newQty); // Keep editQty in sync\r\n      setEditingCartItem(null);\r\n    } catch (err) {\r\n      setError(err.message || \"Failed to update quantity\");\r\n    }\r\n  };\r\n  \r\n  // Handle edit quantity change\r\n  const handleEditQtyChange = (value) => {\r\n    setEditQty(value);\r\n  };\r\n\r\n  const subtotal = cart.reduce(\r\n    (sum, item) => sum + item.price * item.quantity,\r\n    0\r\n  );\r\n\r\n  // Calculate total with discount\r\n  let total = subtotal;\r\n  if (appliedDiscount) {\r\n    if (appliedDiscount.type === \"percentage\") {\r\n      const discountValue = Number(appliedDiscount.value);\r\n      if (!isNaN(discountValue) && discountValue > 0) {\r\n        const discountAmount = subtotal * (discountValue / 100);\r\n        total = Math.max(0, subtotal - discountAmount);\r\n      }\r\n    } else if (appliedDiscount.type === \"amount\") {\r\n      const discountValue = Number(appliedDiscount.value);\r\n      if (!isNaN(discountValue) && discountValue > 0) {\r\n        total = Math.max(0, subtotal - discountValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Handle keyboard navigation for cart items\r\n  useEffect(() => {\r\n    const handleKeyDown = (e) => {\r\n      if (showDiscount || showPriceCheck || showImportCart || showCashLedger || showCheckout || showCashModal || showReceipts || showLogoutConfirm) {\r\n        return; // Don't handle keys when modals are open\r\n      }\r\n\r\n      switch (e.key) {\r\n        case 'ArrowUp':\r\n          e.preventDefault();\r\n          setSelectedCartIdx(prev => prev > 0 ? prev - 1 : cart.length - 1);\r\n          break;\r\n        case 'ArrowDown':\r\n          e.preventDefault();\r\n          setSelectedCartIdx(prev => prev < cart.length - 1 ? prev + 1 : 0);\r\n          break;\r\n        case 'e':\r\n        case 'E':\r\n          e.preventDefault();\r\n          if (cart.length > 0 && selectedCartIdx >= 0 && selectedCartIdx < cart.length) {\r\n            setEditingCartItem(selectedCartIdx);\r\n            setEditQty(String(cart[selectedCartIdx].quantity));\r\n          }\r\n          break;\r\n        case 'd':\r\n        case 'D':\r\n          e.preventDefault();\r\n          if (cart.length > 0 && selectedCartIdx >= 0 && selectedCartIdx < cart.length) {\r\n            handleRemove(selectedCartIdx);\r\n            setSelectedCartIdx(prev => Math.min(prev, cart.length - 2));\r\n          }\r\n          break;\r\n        case 'Enter':\r\n          if (editingCartItem !== null) {\r\n            e.preventDefault();\r\n            handleEditQuantity(editingCartItem, editQty);\r\n            setEditingCartItem(null);\r\n          }\r\n          break;\r\n        case 'Escape':\r\n          if (editingCartItem !== null) {\r\n            e.preventDefault();\r\n            setEditingCartItem(null);\r\n          }\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, [cart.length, selectedCartIdx, editingCartItem, editQty, showDiscount, showPriceCheck, showImportCart, showCashLedger, showCheckout, showCashModal, showReceipts, showLogoutConfirm]);\r\n\r\n  // Reset selected index when cart changes\r\n  useEffect(() => {\r\n    if (cart.length === 0) {\r\n      setSelectedCartIdx(0);\r\n    } else {\r\n      setSelectedCartIdx(prev => Math.min(prev, cart.length - 1));\r\n    }\r\n  }, [cart.length]);\r\n\r\n  // Pause scanner when any modal is open to avoid hardware scanner/keyboard events interfering with shortcuts\r\n  useEffect(() => {\r\n    const anyModalOpen =\r\n      showDiscount ||\r\n      showPriceCheck ||\r\n      showImportCart ||\r\n      showCashLedger ||\r\n      showCheckout ||\r\n      showCashModal ||\r\n      showReceipts ||\r\n      showLogoutConfirm;\r\n    setScannerPaused(anyModalOpen);\r\n  }, [\r\n    showDiscount,\r\n    showPriceCheck,\r\n    showImportCart,\r\n    showCashLedger,\r\n    showCheckout,\r\n    showCashModal,\r\n    showReceipts,\r\n    showLogoutConfirm,\r\n  ]);\r\n\r\n  const focusSkuInput = () => {\r\n    skuInputRef.current?.focus();\r\n    skuInputRef.current?.select?.();\r\n  };\r\n\r\n  const handleNewTransaction = () => {\r\n    setCart([]);\r\n    setAppliedDiscount(null);\r\n    setTransactionId(null);\r\n    setError(\"\");\r\n    focusSkuInput();\r\n  };\r\n\r\n  const handleVoidSelected = () => {\r\n    if (cart.length === 0 || selectedCartIdx == null) return;\r\n    handleRemove(selectedCartIdx);\r\n  };\r\n\r\n  const handleSetQuantityShortcut = () => {\r\n    if (cart.length === 0 || selectedCartIdx == null) return;\r\n    const current = cart[selectedCartIdx];\r\n    const nextQty = Number(\r\n      window.prompt(\r\n        `Set quantity for ${current.name || current.sku}:`,\r\n        current.quantity\r\n      )\r\n    );\r\n    if (!Number.isNaN(nextQty) && nextQty > 0) {\r\n      handleEditQuantity(selectedCartIdx, nextQty);\r\n    }\r\n  };\r\n\r\n  const handleRemoveDiscount = () => {\r\n    if (appliedDiscount) {\r\n      setAppliedDiscount(null);\r\n    }\r\n  };\r\n\r\n  useKeyboardShortcuts(\r\n    [\r\n      { key: \"f1\", action: handleNewTransaction },\r\n      {\r\n        key: \"f2\",\r\n        action: () => {\r\n          setShowPriceCheck(true);\r\n        },\r\n      },\r\n      { key: \"f3\", action: focusSkuInput },\r\n      {\r\n        key: \"f4\",\r\n        action: handleVoidSelected,\r\n        enabled: cart.length > 0,\r\n      },\r\n      { key: \"f5\", action: () => setShowDiscount(true) },\r\n      {\r\n        key: \"f6\",\r\n        action: handleSetQuantityShortcut,\r\n        enabled: cart.length > 0,\r\n      },\r\n      {\r\n        key: \"f7\",\r\n        action: () => setShowCheckout(true),\r\n        enabled: cart.length > 0,\r\n      },\r\n      {\r\n        key: \"f8\",\r\n        action: () => setShowImportCart(true),\r\n      },\r\n      {\r\n        key: \"f10\",\r\n        action: () => setShowCheckout(true),\r\n        enabled: cart.length > 0,\r\n      },\r\n      { key: \"f11\", action: () => setShowReceipts(true) },\r\n      {\r\n        key: \"f12\",\r\n        description: \"Logout\",\r\n        action: () => setShowLogoutConfirm(true),\r\n      },\r\n      {\r\n        key: \"r\",\r\n        description: \"Remove Discount\",\r\n        action: handleRemoveDiscount,\r\n        enabled: !!appliedDiscount,\r\n      },\r\n      { key: \"ctrl+l\", action: () => setShowCashLedger(true) },\r\n      {\r\n        key: \"escape\",\r\n        action: () => {\r\n          if (showCheckout) setShowCheckout(false);\r\n          else if (showDiscount) setShowDiscount(false);\r\n          else if (showPriceCheck) setShowPriceCheck(false);\r\n          else if (showImportCart) setShowImportCart(false);\r\n          else if (showCashModal) setShowCashModal(false);\r\n          else if (showCashLedger) setShowCashLedger(false);\r\n          else if (showReceipts) setShowReceipts(false);\r\n          else if (showLogoutConfirm) setShowLogoutConfirm(false);\r\n        },\r\n        allowWhileTyping: true,\r\n      },\r\n    ],\r\n    [\r\n      cart.length,\r\n      selectedCartIdx,\r\n      showCheckout,\r\n      showDiscount,\r\n      showPriceCheck,\r\n      showImportCart,\r\n      showCashModal,\r\n      showCashLedger,\r\n      showReceipts,\r\n      showLogoutConfirm,\r\n      appliedDiscount,\r\n    ]\r\n  );\r\n\r\n  // show confirmation modal first, perform actual logout in confirmLogout\r\n  const handleLogout = () => {\r\n    setShowLogoutConfirm(true);\r\n  };\r\n\r\n  const confirmLogout = () => {\r\n    sessionStorage.removeItem(\"auth_token\");\r\n    sessionStorage.removeItem(\"user\");\r\n    // close modal then navigate home\r\n    setShowLogoutConfirm(false);\r\n    navigate(\"/\");\r\n  };\r\n\r\n  const handleCloseLogoutModal = () => {\r\n    setShowLogoutConfirm(false);\r\n  };\r\n\r\n  // Handle keyboard events for logout confirmation\r\n  useEffect(() => {\r\n    if (!showLogoutConfirm) return;\r\n\r\n    const handleKeyDown = (e) => {\r\n      // Use stopPropagation to prevent other handlers from interfering\r\n      e.stopPropagation();\r\n      \r\n      if (e.key === 'Escape' || e.key === 'Esc') {\r\n        e.preventDefault();\r\n        handleCloseLogoutModal();\r\n      } else if (e.key === 'Enter') {\r\n        e.preventDefault();\r\n        confirmLogout();\r\n      }\r\n    };\r\n\r\n    // Use capture phase to ensure we get the event first\r\n    document.addEventListener('keydown', handleKeyDown, { capture: true });\r\n    return () => document.removeEventListener('keydown', handleKeyDown, { capture: true });\r\n  }, [showLogoutConfirm]);\r\n\r\n  const handleCheckout = async (paymentMethod, amountReceived = null) => {\r\n    if (cart.length === 0) return;\r\n    setError(\"\");\r\n    try {\r\n      // Prepare the checkout payload\r\n      const payload = {\r\n        items: cart.map((item) => ({\r\n          product_id: item.product_id,\r\n          quantity: item.quantity,\r\n          price: item.price,\r\n        })),\r\n        payment_type: paymentMethod,\r\n        money_received: amountReceived,\r\n        transaction_id: transactionId, // Include the transaction ID if it exists\r\n        transaction_number: transactionNumber,\r\n        discount_id: appliedDiscount?.discount_id || null,\r\n        discount_percentage: appliedDiscount?.type === 'percentage' ? appliedDiscount.value : null,\r\n        discount_amount: appliedDiscount?.type === 'amount' ? appliedDiscount.value : null,\r\n      };\r\n\r\n      const resp = await api(\"/api/sales/checkout\", {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${token}` },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (resp?.transaction_number)\r\n        setTransactionNumber(resp.transaction_number);\r\n      if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n      setCart([]);\r\n      try {\r\n        const url = new URL(window.location.origin + \"/receipt\");\r\n        if (resp?.transaction_number)\r\n          url.searchParams.set(\"tn\", resp.transaction_number);\r\n        if (resp?.transaction_id)\r\n          url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n        if (resp?.total != null)\r\n          url.searchParams.set(\"total\", String(resp.total));\r\n        navigate(url.pathname + url.search);\r\n      } catch (_) {}\r\n      // Start a fresh provisional transaction number after successful checkout\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(\r\n        `T-${businessId.toString().padStart(2, \"0\")}-${timePart}-${randPart}`\r\n      );\r\n      setAppliedDiscount(null); // Reset discount after successful checkout\r\n      setTransactionId(null);\r\n    } catch (err) {\r\n      console.error(\"Checkout error:\", err);\r\n      setError(\"Checkout failed\");\r\n    }\r\n  };\r\n\r\n  const [showRecentReceiptsModal, setShowRecentReceiptsModal] = useState(false);\r\n\r\n  const handleCopyTn = async () => {\r\n    try {\r\n      if (!user.store_name) return;\r\n      await navigator.clipboard.writeText(user.store_name);\r\n    } catch (_) {}\r\n  };\r\n\r\n  const headerActions = (\r\n    <div className=\"flex items-center gap-1 sm:gap-4 mr-3\">\r\n      {/* Transaction Number display */}\r\n      <div className=\"space-y-2\">\r\n        {appliedDiscount && (\r\n          <div className=\"flex items-center justify-between text-sm text-green-600\">\r\n            <span>Discount Applied:</span>\r\n            <span className=\"font-medium\">\r\n              {appliedDiscount.type === 'percentage' \r\n                ? `${appliedDiscount.value}%` \r\n                : `₱${Number(appliedDiscount.value).toFixed(2)}`}\r\n            </span>\r\n          </div>\r\n        )}\r\n        <div className=\"flex items-center justify-between text-lg font-semibold\">\r\n          <span>Total:</span>\r\n          <div className=\"flex items-center gap-2\">\r\n            {appliedDiscount && (\r\n              <span className=\"text-sm text-gray-500 line-through\">\r\n                ₱{subtotal.toFixed(2)}\r\n              </span>\r\n            )}\r\n            <span>₱{total.toFixed(2)}</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      {/* Transaction Number display */}\r\n      <div className=\"flex-1 flex items-center justify-center\">\r\n        <button\r\n          onClick={handleCopyTn}\r\n          title=\"Copy store name\"\r\n          className=\"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm\"\r\n        >\r\n          <svg\r\n            className=\"w-3 h-3 sm:w-4 sm:h-4\"\r\n            fill=\"none\"\r\n            stroke=\"currentColor\"\r\n            viewBox=\"0 0 24 24\"\r\n          >\r\n            <path\r\n              strokeLinecap=\"round\"\r\n              strokeLinejoin=\"round\"\r\n              strokeWidth={2}\r\n              d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2\"\r\n            />\r\n          </svg>\r\n          <span className=\"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]\">\r\n            {user.store_name}\r\n          </span>\r\n        </button>\r\n      </div>\r\n      {/* View All Receipts Button */}\r\n      <button\r\n        onClick={() => setShowReceipts(true)}\r\n        className=\"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80 hover:bg-gray-50 transition-colors\"\r\n        title=\"View all receipts\"\r\n      >\r\n        <div className=\"relative\">\r\n          <BiReceipt className=\"w-5 h-5 text-blue-600\" />\r\n        </div>\r\n        <span className=\"text-sm font-medium text-gray-700 hidden sm:inline\">\r\n          (F11) Receipts\r\n        </span>\r\n      </button>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <PageLayout\r\n      title=\"POS\"\r\n      sidebar={<NavAdmin />}\r\n      headerActions={headerActions}\r\n      isSidebarOpen={isSidebarOpen}\r\n      setSidebarOpen={setSidebarOpen}\r\n    >\r\n      <div className=\"flex-1 flex flex-col min-h-screen\">\r\n        <main className=\"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4\">\r\n          <div className=\"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12\">\r\n            {/* Left Column - Scanner, SKU Form, Transaction */}\r\n            <div className=\"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4\">\r\n              {/* ScannerCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <ScannerCard\r\n                  onScan={async (result) => {\r\n                    const code = result?.[0]?.rawValue;\r\n                    if (!code) return;\r\n                    setScannerPaused(true);\r\n                    if (showPriceCheck) {\r\n                      setPriceCheckSku(code);\r\n                    } else {\r\n                      try {\r\n                        let scannedData;\r\n                        try {\r\n                          scannedData = JSON.parse(code);\r\n                        } catch (e) {\r\n                          scannedData = null;\r\n                        }\r\n                        if (\r\n                          scannedData &&\r\n                          scannedData.t === \"cart\" &&\r\n                          Array.isArray(scannedData.items)\r\n                        ) {\r\n                          // set transactionId from scanned data if present\r\n                          if (scannedData.transaction_id) {\r\n                            setTransactionId(scannedData.transaction_id);\r\n                          }\r\n                          // set transaction_number from scanned data if present\r\n                          if (scannedData.transaction_number) {\r\n                            setTransactionNumber(\r\n                              scannedData.transaction_number\r\n                            );\r\n                          }\r\n                          const items = scannedData.items.map((it) => ({\r\n                            product_id: it.p,\r\n                            quantity: it.q,\r\n                            sku: it.sku || \"\",\r\n                          }));\r\n                          try {\r\n                            const fetchedProducts = await Promise.all(\r\n                              items.map(async (item) => {\r\n                                const res = await api(\r\n                                  `/api/products/${item.product_id}`,\r\n                                  {\r\n                                    headers: {\r\n                                      Authorization: `Bearer ${token}`,\r\n                                    },\r\n                                  }\r\n                                );\r\n                                return {\r\n                                  product_id: item.product_id,\r\n                                  sku: res.sku || item.sku || \"\",\r\n                                  name: res.product_name || \"\",\r\n                                  price: Number(res.selling_price) || 0,\r\n                                  quantity: item.quantity,\r\n                                };\r\n                              })\r\n                            );\r\n                            setCart((prev) => {\r\n                              const byProductId = new Map(\r\n                                prev.map((i) => [i.product_id, i])\r\n                              );\r\n                              for (const it of fetchedProducts) {\r\n                                const existing = byProductId.get(it.product_id);\r\n                                if (existing) {\r\n                                  existing.quantity += it.quantity;\r\n                                } else {\r\n                                  byProductId.set(it.product_id, { ...it });\r\n                                }\r\n                              }\r\n                              return Array.from(byProductId.values());\r\n                            });\r\n                            return;\r\n                          } catch (err) {\r\n                            console.error(\r\n                              \"Error fetching product details for scanned cart:\",\r\n                              err\r\n                            );\r\n                            // fallback to merging raw scanned items without product details\r\n                            setCart((prev) => {\r\n                              const byProductId = new Map(\r\n                                prev.map((i) => [i.product_id, i])\r\n                              );\r\n                              for (const it of items) {\r\n                                const existing = byProductId.get(it.product_id);\r\n                                if (existing) {\r\n                                  existing.quantity += it.quantity;\r\n                                } else {\r\n                                  byProductId.set(it.product_id, {\r\n                                    ...it,\r\n                                    name: \"\",\r\n                                    price: 0,\r\n                                  });\r\n                                }\r\n                              }\r\n                              return Array.from(byProductId.values());\r\n                            });\r\n                            return;\r\n                          }\r\n                        }\r\n                        await addSkuToCart(code, 1);\r\n                      } catch (err) {\r\n                        console.error(\"Error processing scanned code:\", err);\r\n                        await addSkuToCart(code, 1);\r\n                      }\r\n                    }\r\n                  }}\r\n                  paused={scannerPaused}\r\n                  onResume={() => setScannerPaused(false)}\r\n                  textMain=\"text-blue-700\"\r\n                />\r\n              </div>\r\n\r\n              {/* SkuFormCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <SkuFormCard\r\n                  ref={skuInputRef}\r\n                  sku={sku}\r\n                  setSku={setSku}\r\n                  quantity={quantity}\r\n                  setQuantity={setQuantity}\r\n                  handleAddToCart={handleAddToCart}\r\n                  quantityInputRef={quantityInputRef}\r\n                />\r\n                {error && (\r\n                  <div className=\"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3\">\r\n                    <svg\r\n                      className=\"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5\"\r\n                      fill=\"none\"\r\n                      stroke=\"currentColor\"\r\n                      viewBox=\"0 0 24 24\"\r\n                    >\r\n                      <path\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        strokeWidth={2}\r\n                        d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\"\r\n                      />\r\n                    </svg>\r\n                    <p className=\"text-sm font-medium text-red-700\">\r\n                      {(() => {\r\n                        try {\r\n                          const parsed = JSON.parse(error);\r\n                          return parsed.error || parsed.message || error;\r\n                        } catch {\r\n                          return error;\r\n                        }\r\n                      })()}\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* TransactionCard */}\r\n              {/* Removed card display; transaction number now shown in header */}\r\n              {/* <div className=\"flex-shrink-0\">\r\n                  <TransactionCard\r\n                    transactionNumber={transactionNumber}\r\n                    transactionId={transactionId}\r\n                  />\r\n                </div> */}\r\n            </div>\r\n\r\n            {/* Right Column - Cart and Actions */}\r\n            <div className=\"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0\">\r\n              {/* CartTableCard */}\r\n              <div className=\"flex-1 min-h-0 max-h-[calc(100vh-280px)]\">\r\n                <CartTableCard\r\n                cart={cart}\r\n                handleRemove={handleRemove}\r\n                handleEditQuantity={(idx, newQuantity) => {\r\n                  handleEditQuantity(idx, newQuantity);\r\n                  setEditingCartItem(null);\r\n                }}\r\n                total={total}\r\n                appliedDiscount={appliedDiscount}\r\n                selectedIdx={selectedCartIdx}\r\n                onSelectRow={setSelectedCartItem}\r\n                editingIdx={editingCartItem}\r\n                editQty={editQty}\r\n                onEditQtyChange={handleEditQtyChange}\r\n                onEditComplete={() => setEditingCartItem(null)}\r\n                className=\"flex-1 h-full\"\r\n              />\r\n              </div>\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0\">\r\n                {appliedDiscount && (\r\n                  <div className=\"col-span-12 flex items-center justify-between bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg px-3 py-2\">\r\n                    <span className=\"text-sm font-semibold\">\r\n                      Discount applied: {appliedDiscount.label}\r\n                    </span>\r\n                    <button\r\n                      className=\"text-xs font-bold underline flex items-center gap-1\"\r\n                      onClick={() => setAppliedDiscount(null)}\r\n                    >\r\n                      <span className=\"text-yellow-600\">(R)</span> Remove\r\n                    </button>\r\n                  </div>\r\n                )}\r\n                {/* Grouped Buttons */}\r\n                <div className=\"col-span-8\">\r\n                  <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3\">\r\n                    <Button\r\n                      label=\"CASH LEDGER (Ctrl+L)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      onClick={() => setShowCashLedger(true)}\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <div className=\"relative group flex-1\">\r\n                      <Button\r\n                        label={\r\n                          appliedDiscount\r\n                            ? `REMOVE ${appliedDiscount.label || 'DISCOUNT'}`\r\n                            : \"ADD DISCOUNT (F5)\"\r\n                        }\r\n                        variant={appliedDiscount ? \"danger\" : \"secondary\"}\r\n                        onClick={() => {\r\n                          if (appliedDiscount) {\r\n                            if (window.confirm(`Remove ${appliedDiscount.label || 'discount'}?`)) {\r\n                              setAppliedDiscount(null);\r\n                            }\r\n                          } else {\r\n                            setShowDiscount(true);\r\n                          }\r\n                        }}\r\n                        icon={\r\n                          appliedDiscount ? (\r\n                            <svg\r\n                              className=\"w-5 h-5\"\r\n                              fill=\"none\"\r\n                              stroke=\"currentColor\"\r\n                              viewBox=\"0 0 24 24\"\r\n                            >\r\n                              <path\r\n                                strokeLinecap=\"round\"\r\n                                strokeLinejoin=\"round\"\r\n                                strokeWidth={2}\r\n                                d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\"\r\n                              />\r\n                            </svg>\r\n                          ) : (\r\n                            <svg\r\n                              className=\"w-5 h-5\"\r\n                              fill=\"none\"\r\n                              stroke=\"currentColor\"\r\n                              viewBox=\"0 0 24 24\"\r\n                            >\r\n                              <path\r\n                                strokeLinecap=\"round\"\r\n                                strokeLinejoin=\"round\"\r\n                                strokeWidth={2}\r\n                                d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                              />\r\n                            </svg>\r\n                          )\r\n                        }\r\n                        className={`w-full h-10 sm:h-12 text-xs sm:text-sm font-bold ${\r\n                          appliedDiscount ? 'bg-red-600 hover:bg-red-700' : ''\r\n                        }`}\r\n                      />\r\n                      {appliedDiscount && (\r\n                        <div className=\"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\r\n                          Click to remove discount\r\n                          <div className=\"absolute bottom-0 left-1/2 w-2 h-2 bg-gray-800 transform -translate-x-1/2 translate-y-1/2 rotate-45\"></div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <Button\r\n                      label=\"PRICE CHECK (F2)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowPriceCheck(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"SCAN CUSTOMER QR (F8)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowImportCart(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Checkout Button */}\r\n                <div className=\"col-span-4\">\r\n                  <Button\r\n                    label=\"CHECKOUT (F10)\"\r\n                    size=\"md\"\r\n                    className=\"w-full h-full text-sm sm:text-base font-bold\"\r\n                    variant=\"primary\"\r\n                    microinteraction\r\n                    onClick={() => setShowCheckout(true)}\r\n                    disabled={cart.length === 0}\r\n                    icon={\r\n                      <svg\r\n                        className=\"w-5 h-5\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        viewBox=\"0 0 24 24\"\r\n                      >\r\n                        <path\r\n                          strokeLinecap=\"round\"\r\n                          strokeLinejoin=\"round\"\r\n                          strokeWidth={2}\r\n                          d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                        />\r\n                      </svg>\r\n                    }\r\n                    iconPosition=\"left\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </main>\r\n      </div>\r\n      {/* Modals */}\r\n      <DiscountModal\r\n        isOpen={showDiscount}\r\n        onClose={() => setShowDiscount(false)}\r\n        onApplyDiscount={(discount) => {\r\n          setAppliedDiscount(discount);\r\n          setShowDiscount(false);\r\n        }}\r\n      />\r\n      <PriceCheckModal\r\n        isOpen={showPriceCheck}\r\n        onClose={() => setShowPriceCheck(false)}\r\n        sku={priceCheckSku}\r\n        setSku={setPriceCheckSku}\r\n      />\r\n      <CashLedgerModal\r\n        isOpen={showCashLedger}\r\n        onClose={() => setShowCashLedger(false)}\r\n      />\r\n      <AdminReceiptsModal\r\n        isOpen={showReceipts}\r\n        onClose={() => setShowReceipts(false)}\r\n      />\r\n      <CheckoutModal\r\n        isOpen={showCheckout}\r\n        onClose={() => setShowCheckout(false)}\r\n        total={total}\r\n        onSelectPayment={(method) => {\r\n          setSelectedPayment(method);\r\n          setShowCheckout(false);\r\n\r\n          if (method === \"cash\") {\r\n            setShowCashModal(true);\r\n          } else if (method === \"gcash\") {\r\n            (async () => {\r\n              try {\r\n                const successUrl =\r\n                  window.location.origin + \"/pos?payment=success\";\r\n                const cancelUrl =\r\n                  window.location.origin + \"/pos?payment=cancel\";\r\n                // persist cart to finalize after redirect back\r\n                localStorage.setItem(\r\n                  \"pending_gcash_cart\",\r\n                  JSON.stringify({\r\n                    items: cart.map((i) => ({\r\n                      product_id: i.product_id,\r\n                      quantity: i.quantity,\r\n                    })),\r\n                    total,\r\n                    discount_id: appliedDiscount?.discount_id || null,\r\n                    discount_percentage: appliedDiscount?.type === 'percentage' ? Number(appliedDiscount.value) : null,\r\n                    discount_amount: appliedDiscount?.type === 'amount' ? Number(appliedDiscount.value) : null,\r\n                  })\r\n                );\r\n                const { checkoutUrl } = await createGcashCheckout({\r\n                  amount: Number(total || 0),\r\n                  description: \"POS Order\",\r\n                  referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                  cancelUrl,\r\n                  successUrl,\r\n                });\r\n                window.open(checkoutUrl, \"_blank\");\r\n              } catch (e) {\r\n                setError(\"Failed to init GCash\");\r\n                localStorage.removeItem(\"pending_gcash_cart\");\r\n              }\r\n            })();\r\n          } else if (method === \"maya\") {\r\n            (async () => {\r\n              try {\r\n                const successUrl =\r\n                  window.location.origin + \"/pos?payment=success\";\r\n                const cancelUrl =\r\n                  window.location.origin + \"/pos?payment=cancel\";\r\n                // persist cart to finalize after redirect back\r\n                localStorage.setItem(\r\n                  \"pending_maya_cart\",\r\n                  JSON.stringify({\r\n                    items: cart.map((i) => ({\r\n                      product_id: i.product_id,\r\n                      quantity: i.quantity,\r\n                    })),\r\n                    total,\r\n                    discount_id: appliedDiscount?.discount_id || null,\r\n                    discount_percentage: appliedDiscount?.type === 'percentage' ? Number(appliedDiscount.value) : null,\r\n                    discount_amount: appliedDiscount?.type === 'amount' ? Number(appliedDiscount.value) : null,\r\n                  })\r\n                );\r\n                const { checkoutUrl } = await createMayaCheckout({\r\n                  amount: Number(total || 0),\r\n                  description: \"POS Order\",\r\n                  referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                  cancelUrl,\r\n                  successUrl,\r\n                });\r\n                window.open(checkoutUrl, \"_blank\");\r\n              } catch (e) {\r\n                setError(\"Failed to init Maya\");\r\n                localStorage.removeItem(\"pending_maya_cart\");\r\n              }\r\n            })();\r\n          } else {\r\n            handleCheckout(method);\r\n          }\r\n        }}\r\n      />\r\n      <CashPaymentModal\r\n        isOpen={showCashModal}\r\n        onClose={() => setShowCashModal(false)}\r\n        total={total}\r\n        onConfirm={(amountReceived) => {\r\n          handleCheckout(\"cash\", amountReceived);\r\n          setShowCashModal(false);\r\n        }}\r\n      />\r\n      {showLogoutConfirm && (\r\n        <div className=\"fixed inset-0 z-90 flex items-center justify-center\">\r\n          <div\r\n            className=\"absolute inset-0 bg-black/80 z-90\"\r\n            onClick={handleCloseLogoutModal}\r\n          />\r\n          <div \r\n            className=\"relative bg-white rounded-xl shadow-xl w-[92%] max-w-md z-100 p-0\"\r\n            onKeyDown={(e) => {\r\n              // Prevent event from bubbling up to document\r\n              e.stopPropagation();\r\n              \r\n              // Handle Enter key specifically for the modal\r\n              if (e.key === 'Enter' && !e.isPropagationStopped()) {\r\n                e.preventDefault();\r\n                confirmLogout();\r\n              }\r\n            }}\r\n          >\r\n            {/* Header Section */}\r\n            <div className=\"bg-gradient-to-r from-red-50 via-red-50/80 to-orange-50/50 border-b border-red-100 px-6 py-5 rounded-t-2xl\">\r\n              <div className=\"flex items-center gap-4\">\r\n                <div className=\"w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg\">\r\n                  <svg\r\n                    className=\"w-6 h-6 text-white\"\r\n                    fill=\"none\"\r\n                    stroke=\"white\"\r\n                    viewBox=\"0 0 24 24\"\r\n                  >\r\n                    <path\r\n                      strokeWidth=\"2\"\r\n                      strokeLinecap=\"round\"\r\n                      strokeLinejoin=\"round\"\r\n                      d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\"\r\n                    />\r\n                  </svg>\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <h2 className=\"text-xl font-bold text-gray-900 mb-1\">\r\n                    Confirm Logout\r\n                  </h2>\r\n                  <p className=\"text-sm text-gray-600\">\r\n                    Are you sure you want to log out? <span className=\"text-xs opacity-70\">(Press Esc to cancel, Enter to confirm)</span>\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Content Section */}\r\n            <div className=\"p-6\">\r\n              <p className=\"text-sm text-gray-700 mb-6\">\r\n                You will be redirected to the login page and your session will\r\n                end.\r\n              </p>\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"flex justify-end gap-3\">\r\n                <button\r\n                  onClick={handleCloseLogoutModal}\r\n                  className=\"px-5 py-2.5 rounded-lg text-sm font-semibold text-gray-700 bg-white border-2 border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500\"\r\n                  autoFocus\r\n                >\r\n                  Cancel (Esc)\r\n                </button>\r\n                <button\r\n                  onClick={confirmLogout}\r\n                  className=\"px-5 py-2.5 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500\"\r\n                >\r\n                  <svg\r\n                    className=\"w-5 h-5\"\r\n                    fill=\"none\"\r\n                    stroke=\"currentColor\"\r\n                    viewBox=\"0 0 24 24\"\r\n                  >\r\n                    <path\r\n                      strokeWidth=\"2\"\r\n                      strokeLinecap=\"round\"\r\n                      strokeLinejoin=\"round\"\r\n                      d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\"\r\n                    />\r\n                  </svg>\r\n                  Logout (Enter)\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      <ScanCustomerCartModal\r\n        isOpen={showImportCart}\r\n        onClose={() => setShowImportCart(false)}\r\n        onImport={async (items, transactionId, completionResponse) => {\r\n          try {\r\n            // If transaction was completed (completionResponse exists), navigate to receipt\r\n            if (completionResponse && transactionId) {\r\n              setCart([]);\r\n              setTransactionId(null);\r\n              setTransactionNumber(null);\r\n              setError(\"\");\r\n              setShowImportCart(false);\r\n              // Navigate to receipt page for admin\r\n              window.location.href = `/receipt?tn=${completionResponse.transaction_number || transactionId}`;\r\n              return;\r\n            }\r\n            \r\n            // Otherwise, import items (backward compatibility for old QR format)\r\n            if (!items || items.length === 0) {\r\n              setError(\"No items found in QR code\");\r\n              return;\r\n            }\r\n            \r\n            // If we have a transaction ID from the scanned cart, use it\r\n            if (transactionId) {\r\n              setTransactionId(transactionId);\r\n            }\r\n            \r\n            console.log(\"Scanned items:\", items);\r\n            // Fetch product details by product_id for all scanned items concurrently\r\n            const fetchedProducts = await Promise.all(\r\n              items.map(async (item) => {\r\n                const res = await api(`/api/products/${item.product_id}`, {\r\n                  headers: { Authorization: `Bearer ${token}` },\r\n                });\r\n                console.log(\r\n                  \"Fetched product for id\",\r\n                  item.product_id,\r\n                  \":\",\r\n                  res\r\n                );\r\n                return {\r\n                  product_id: item.product_id,\r\n                  sku: res.sku || item.sku || \"\",\r\n                  name: res.product_name || \"\",\r\n                  price: Number(res.selling_price) || 0,\r\n                  quantity: item.quantity,\r\n                };\r\n              })\r\n            );\r\n            setCart((prev) => {\r\n              const byProductId = new Map(prev.map((i) => [i.product_id, i]));\r\n              for (const it of fetchedProducts) {\r\n                const existing = byProductId.get(it.product_id);\r\n                if (existing) {\r\n                  existing.quantity += it.quantity;\r\n                } else {\r\n                  byProductId.set(it.product_id, { ...it });\r\n                }\r\n              }\r\n              return Array.from(byProductId.values());\r\n            });\r\n          } catch (e) {\r\n            console.error(\"Error fetching products for scanned items:\", e);\r\n            // Fallback to use raw items if fetch fails\r\n            setCart((prev) => {\r\n              const byProductId = new Map(prev.map((i) => [i.product_id, i]));\r\n              for (const it of items) {\r\n                const existing = byProductId.get(it.product_id);\r\n                if (existing) {\r\n                  existing.quantity += it.quantity;\r\n                } else {\r\n                  byProductId.set(it.product_id, {\r\n                    ...it,\r\n                    name: \"\",\r\n                    price: 0,\r\n                  });\r\n                }\r\n              }\r\n              return Array.from(byProductId.values());\r\n            });\r\n          }\r\n        }}\r\n      />\r\n    </PageLayout>\r\n  );\r\n}\r\n\r\nexport default POS;\r\n"],"names":["AdminReceiptsModal","isOpen","onClose","receipts","setReceipts","useState","loading","setLoading","error","setError","selectedIndex","setSelectedIndex","containerRef","useRef","useEffect","async","token","sessionStorage","getItem","data","api","headers","Authorization","Array","isArray","e","fetchReceipts","openReceipt","useCallback","receipt","url","URL","window","location","origin","transaction_number","searchParams","set","transaction_id","String","open","toString","index","handleKeyDown","length","preventDefault","key","prev","newIndex","setTimeout","items","current","querySelectorAll","selectedItem","scrollIntoView","behavior","block","inline","focus","preventScroll","firstButton","querySelector","jsxs","BaseModal","title","subtitle","size","footer","jsx","Button","label","variant","onClick","className","children","ref","onKeyDown","tabIndex","map","r","onFocus","Date","updated_at","created_at","toLocaleString","Number","total_amount","total","toFixed","payment","method","payment_type","discount_percentage","discount_amount","POS","navigate","useNavigate","sku","setSku","quantity","setQuantity","cart","setCart","showDiscount","setShowDiscount","showPriceCheck","setShowPriceCheck","priceCheckSku","setPriceCheckSku","showImportCart","setShowImportCart","showCashLedger","setShowCashLedger","showCheckout","setShowCheckout","showCashModal","setShowCashModal","selectedPayment","setSelectedPayment","darkMode","setDarkMode","scannerPaused","setScannerPaused","transactionNumber","setTransactionNumber","transactionId","setTransactionId","showReceipts","setShowReceipts","skuInputRef","isSidebarOpen","setSidebarOpen","selectedItemIdx","setSelectedItemIdx","editingIdx","setEditingIdx","user","JSON","parse","hasFinalizedRef","React","businessName","setBusinessName","selectedCartIdx","setSelectedCartIdx","editingCartItem","setEditingCartItem","editQty","setEditQty","showLogoutConfirm","setShowLogoutConfirm","appliedDiscount","setAppliedDiscount","quantityInputRef","businessId","business_id","timePart","toISOString","replace","slice","randPart","Math","floor","random","padStart","status","URLSearchParams","search","get","isNewTab","opener","closed","finalizeOnlinePayment","pendingCartKey","paymentType","pending","localStorage","parsed","guardKey","setItem","body","toLowerCase","money_received","discount_id","resp","stringify","href","close","_","removeItem","delete","history","replaceState","addSkuToCart","skuValue","qty","product","encodeURIComponent","price","selling_price","stockQty","stock_quantity","product_name","existingIdx","findIndex","i","product_id","next","newQty","name","err","handleRemove","idx","filter","handleEditQuantity","max","item","message","subtotal","reduce","sum","type","discountValue","value","isNaN","discountAmount","min","addEventListener","removeEventListener","focusSkuInput","select","useKeyboardShortcuts","action","handleNewTransaction","handleVoidSelected","enabled","handleSetQuantityShortcut","nextQty","prompt","description","handleRemoveDiscount","allowWhileTyping","confirmLogout","handleCloseLogoutModal","stopPropagation","capture","document","handleCheckout","paymentMethod","amountReceived","payload","pathname","showRecentReceiptsModal","setShowRecentReceiptsModal","headerActions","store_name","navigator","clipboard","writeText","fill","stroke","viewBox","strokeLinecap","strokeLinejoin","strokeWidth","d","BiReceipt","PageLayout","sidebar","NavAdmin","ScannerCard","onScan","result","code","rawValue","scannedData","t","it","p","q","fetchedProducts","Promise","all","res","byProductId","Map","existing","from","values","paused","onResume","textMain","SkuFormCard","handleAddToCart","CartTableCard","newQuantity","selectedIdx","onSelectRow","onEditQtyChange","onEditComplete","microinteraction","icon","iconPosition","confirm","disabled","DiscountModal","onApplyDiscount","discount","PriceCheckModal","CashLedgerModal","CheckoutModal","onSelectPayment","successUrl","cancelUrl","checkoutUrl","createGcashCheckout","amount","referenceNumber","now","createMayaCheckout","CashPaymentModal","onConfirm","isPropagationStopped","autoFocus","ScanCustomerCartModal","onImport","completionResponse","log","console"],"mappings":"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"}