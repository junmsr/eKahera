import{j as e,m as t,A as s}from"./utils-CzS7jPpm.js";import{a,u as i}from"./vendor-DpjJfaBO.js";import{b as n,a as r,L as o,B as l,d as c}from"./index-DXkpZ5oM.js";import{S as d}from"./ScannerCard-BF2D7Jq6.js";import{C as m}from"./Card-BlR7hDww.js";import{M as u}from"./Modal-B68Uj7nQ.js";import{B as x}from"./BaseModal-BODUq_pt.js";function h({item:t,onIncrement:s,onDecrement:a,onRemove:i}){return e.jsxs("div",{className:"grid grid-cols-[40px_1fr_80px_80px] items-center gap-2 py-2",children:[e.jsxs("div",{className:"text-sm text-blue-900 font-semibold",children:[t.quantity,"x"]}),e.jsx("div",{children:e.jsx("input",{value:t.name,readOnly:!0,className:"w-full px-3 py-2 rounded-lg border border-blue-200 bg-white text-blue-900 text-sm shadow-sm focus:outline-none"})}),e.jsxs("div",{className:"text-right text-sm text-blue-900 font-semibold",children:["â‚±",t.price.toFixed(2)]}),e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx("button",{onClick:a,className:"text-blue-700",children:"âˆ’"}),e.jsx("button",{onClick:s,className:"text-blue-700",children:"ï¼‹"}),e.jsx("button",{onClick:i,className:"text-red-600",children:"ðŸ—‘"})]})]})}function p({cart:t,onIncrement:s,onDecrement:a,onRemove:i}){return e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"text-blue-900 text-lg font-bold mb-3",children:"Your Order"}),e.jsxs("div",{className:"grid grid-cols-[40px_1fr_80px_80px] text-xs text-blue-700 font-semibold px-1 mb-2",children:[e.jsx("div",{children:"QTY"}),e.jsx("div",{children:"Item"}),e.jsx("div",{children:"Price"}),e.jsx("div",{className:"text-right",children:"Settings"})]}),e.jsx("div",{className:"space-y-2 max-h-[45vh] overflow-y-auto pr-1",children:0===t.length?e.jsx("div",{className:"text-blue-500 text-center py-6",children:"Scan items to add them to your order."}):t.map(t=>e.jsx(h,{item:t,onIncrement:()=>s(t.sku),onDecrement:()=>a(t.sku),onRemove:()=>i(t.sku)},t.sku))})]})}function b({isOpen:s,onClose:a,total:i,method:r,setMethod:o,onPay:l,cart:c=[]}){const d=c.reduce((e,t)=>e+(t.quantity||0),0),m=[{id:"Cash",name:"Cash",icon:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"})}),description:"Pay with cash at counter"},{id:"GCash",name:"GCash",icon:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"})}),description:"Pay online with GCash"},{id:"PayMaya",name:"PayMaya",icon:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"})}),description:"Pay online with PayMaya"}];return e.jsx(u,{isOpen:s,onClose:a,title:"",children:e.jsxs(t.div,{className:"space-y-8 p-2",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{className:"bg-blue-50 rounded-xl p-6 border border-blue-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-5 h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-blue-600 font-medium",children:"Order Summary"}),e.jsxs("div",{className:"text-xs text-blue-500",children:[d," item",1!==d?"s":""]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-blue-600 font-medium",children:"Total"}),e.jsxs("div",{className:"text-lg font-bold text-blue-900",children:["â‚±",i.toFixed(2)]})]})]})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-blue-900 mb-6",children:"Choose Payment Method"}),e.jsx("div",{className:"space-y-4",children:m.map(s=>e.jsx(t.div,{className:"relative p-5 rounded-xl border-2 cursor-pointer transition-all duration-200 "+(r===s.id?"border-blue-500 bg-blue-50 shadow-md":"border-gray-200 bg-white"),onClick:()=>o(s.id),whileTap:{scale:.98},children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center "+(r===s.id?"bg-blue-500 text-white":"bg-gray-100 text-gray-600"),children:s.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-blue-900",children:s.name}),e.jsx("div",{className:"text-sm text-gray-600",children:s.description})]}),e.jsx("div",{className:"w-5 h-5 rounded-full border-2 flex items-center justify-center "+(r===s.id?"border-blue-500 bg-blue-500":"border-gray-300"),children:r===s.id&&e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]})},s.id))})]}),e.jsx(t.div,{className:"pt-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},children:e.jsx(n,{label:`Pay â‚±${i.toFixed(2)}`,variant:"primary",onClick:()=>l(r||"Cash"),microinteraction:!0,className:"w-full py-3 text-lg font-semibold"})})]})})}function y({total:s,onCancel:a,onCheckout:i,disabled:r=!1}){return e.jsx(t.div,{className:"fixed bottom-0 left-0 right-0 px-4 pb-4 sm:pb-6 pt-3 bg-white/95 backdrop-blur-xl border-t border-blue-200/50 shadow-2xl",initial:{y:100,opacity:0},animate:{y:0,opacity:1},transition:{duration:.3,ease:"easeOut"},children:e.jsxs("div",{className:"max-w-screen-md mx-auto flex items-center justify-between gap-3",children:[e.jsx(n,{label:"Cancel",variant:"secondary",onClick:a,microinteraction:!0,disabled:r,className:"flex-shrink-0"}),e.jsx(n,{label:"Check Out",variant:"primary",onClick:i,microinteraction:!0,disabled:r,className:"flex-shrink-0"}),e.jsxs(t.div,{className:"text-right text-sm flex-shrink-0 min-w-[100px]",initial:{scale:.9},animate:{scale:1},transition:{delay:.2},children:[e.jsx("div",{className:"text-blue-600 font-medium text-xs sm:text-sm",children:"Order Total:"}),e.jsxs("div",{className:"text-blue-900 font-extrabold text-lg sm:text-xl",children:["â‚±",s.toFixed(2)]})]})]})})}function g({isOpen:t,onClose:s,qrPayload:i,transactionId:n,onTransactionComplete:l}){const[c,d]=a.useState("pending"),[m,u]=a.useState(""),h=a.useMemo(()=>i||"{}",[i]);a.useEffect(()=>{if(t&&n){const e=setInterval(async()=>{try{const t=await r(`/sales/public/transaction/${n}`);"completed"===t.status&&(d("completed"),clearInterval(e),l&&l(t.tn))}catch(t){console.error("Error fetching transaction status:",t),u("Could not fetch transaction status."),clearInterval(e)}},3e3);return()=>clearInterval(e)}},[t,n,l]),a.useEffect(()=>{t||setTimeout(()=>{d("pending"),u("")},300)},[t]);const p=a.useMemo(()=>`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(h)}&qzone=2&format=png&_=${Date.now()}`,[h]);return e.jsxs(x,{isOpen:t,onClose:s,title:"Show to Cashier",subtitle:"Let the cashier scan this QR code to finalize payment.",size:"sm",contentClassName:"text-center space-y-3",children:[e.jsx("img",{src:p,alt:"Customer Cart QR",className:"w-[300px] h-[300px] border-4 border-blue-200 rounded-2xl bg-white mx-auto shadow-lg"}),e.jsxs("div",{className:"h-8",children:["pending"===c&&e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-blue-800 animate-pulse",children:[e.jsx(o,{size:"sm"}),e.jsx("span",{children:"Waiting for cashier..."})]}),"completed"===c&&e.jsx("div",{className:"text-green-600 font-bold",children:"Transaction Complete! Redirecting..."}),m&&e.jsx("div",{className:"text-red-500 text-sm",children:m})]}),e.jsx("div",{className:"pt-4",children:e.jsx("button",{onClick:s,className:"w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors duration-300",children:"Cancel"})})]})}function f(){const n=i(),[o,u]=a.useState([]),[x,h]=a.useState(!1),[f,j]=a.useState(!1),[v,N]=a.useState("GCash"),[w,k]=a.useState(!0),[_,C]=a.useState(!1),[S,M]=a.useState(""),[I,P]=a.useState(""),[q,L]=a.useState(!1),O=a.useRef(!1),[R,T]=a.useState(null),[z,B]=a.useState(null),[$,E]=a.useState(""),U=a.useMemo(()=>o.reduce((e,t)=>t&&"number"==typeof t.price&&"number"==typeof t.quantity?e+t.price*t.quantity:e,0),[o]);a.useEffect(()=>{const e=localStorage.getItem("business_id");e&&r(`/api/business/public/${e}`).then(e=>{E(e.business_name)}).catch(()=>{P("Could not fetch store name.")})},[]),a.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment"),t=localStorage.getItem("pending_gcash_cart_public"),s=localStorage.getItem("business_id");if("success"===e&&t&&s)try{const e=JSON.parse(t);(async()=>{if(O.current)return;const t="gcash_finalize_done_public";if("1"!==sessionStorage.getItem(t)){O.current=!0,sessionStorage.setItem(t,"1");try{const t={items:e.items||[],payment_type:"gcash",money_received:e.total||null,business_id:Number(s),transaction_number:e.transactionNumber||null},a=await r("/api/sales/public/checkout",{method:"POST",body:JSON.stringify(t)});u([]);const i=new URL(window.location.origin+"/receipt");i.searchParams.set("tn",a.transaction_number),i.searchParams.set("tid",String(a.transaction_id)),i.searchParams.set("total",String(a.total||0)),window.location.href=i.toString()}catch(a){P("Failed to record payment")}finally{localStorage.removeItem("pending_gcash_cart_public");const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}}})()}catch(a){localStorage.removeItem("pending_gcash_cart_public")}},[]);return e.jsxs(l,{variant:"gradientBlue",pattern:"dots",floatingElements:!0,overlay:!0,children:[e.jsx(t.div,{className:"absolute -top-24 -left-24 w-[28rem] h-[28rem] rounded-full bg-gradient-to-br from-blue-400/15 to-cyan-400/10 blur-3xl",animate:{scale:[1,1.08,1],opacity:[.35,.5,.35]},transition:{duration:10,repeat:1/0,ease:"easeInOut"}}),e.jsx(t.div,{className:"absolute bottom-0 -right-24 w-[30rem] h-[30rem] rounded-full bg-gradient-to-bl from-indigo-400/15 to-purple-400/10 blur-3xl",animate:{scale:[1,1.12,1],opacity:[.3,.45,.3]},transition:{duration:12,repeat:1/0,ease:"easeInOut"}}),e.jsxs("div",{className:"min-h-screen pb-32 pt-4 sm:pt-6",children:[e.jsxs(t.div,{className:"px-4 space-y-4 max-w-screen-md mx-auto",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[e.jsx("div",{className:"flex items-center justify-center p-2",children:e.jsxs("button",{onClick:()=>{navigator.clipboard.writeText($||"")},title:"Copy store name",className:"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2.5 py-1.5 shadow-sm hover:bg-blue-100 transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2"})}),e.jsx("span",{className:"font-mono text-xs sm:text-sm md:text-base font-bold tracking-wider truncate max-w-[50vw]",children:$||"Scan Store QR to Begin"})]})}),e.jsx(t.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.4,delay:.1},children:e.jsx(d,{onScan:async e=>{const t=e?.[0]?.rawValue;if(t){h(!0),P(""),C(!0);try{const e=o.findIndex(e=>e.sku===t);if(-1!==e)return u(t=>{const s=[...t];return s[e]={...s[e],quantity:s[e].quantity+1},s}),void h(!1);const s=localStorage.getItem("business_id"),a=s?`?business_id=${encodeURIComponent(s)}`:"",i=await r(`/api/products/public/sku/${encodeURIComponent(t)}${a}`);if(!i||s&&Number(i.business_id)!==Number(s))throw new Error("Product not found in this store");{const e=Number(i.selling_price||0),s=i.product_name||`Product ${t}`;u(t=>[...t,{product_id:i.product_id,sku:i.sku,name:s,quantity:1,price:e}])}}catch(s){P("Product not found")}finally{C(!1),h(!1)}}},paused:x,onResume:()=>h(!1),className:"w-full",textMain:"text-blue-700"})}),e.jsx(s,{children:I&&e.jsx(t.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 text-sm shadow-lg backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:I})]})})}),e.jsx(s,{children:_&&e.jsx(t.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-blue-50 border border-blue-200 rounded-xl p-4 text-blue-700 text-sm text-center shadow-lg backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(t.div,{className:"w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}}),e.jsx("span",{children:"Loading product..."})]})})}),e.jsx(t.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:e.jsxs(m,{className:"w-full",variant:"glass",children:[e.jsx(p,{open:w,onToggle:()=>k(e=>!e),cart:o,onIncrement:e=>u(t=>t.map(t=>t.sku===e?{...t,quantity:t.quantity+1}:t)),onDecrement:e=>u(t=>t.map(t=>t.sku===e?{...t,quantity:Math.max(1,t.quantity-1)}:t)),onRemove:e=>u(t=>t.filter(t=>t.sku!==e))}),0===o.length&&e.jsx("div",{className:"p-4 text-center text-gray-500",children:"Cart is empty"})]})})]}),e.jsx(y,{total:U,onCancel:async()=>{const e=localStorage.getItem("customer_user_id");if(e)try{await r(`/api/cleanup/user/${e}`,{method:"DELETE"})}catch(t){}u([]),n("/")},onCheckout:()=>j(!0)}),o.length>0&&e.jsx(b,{isOpen:f,onClose:()=>j(!1),total:U,method:v,setMethod:N,cart:o,onPay:async e=>{const t=localStorage.getItem("business_id");if(!t)return P("No store selected. Please scan the store QR first."),void j(!1);if("Cash"===e){const a=localStorage.getItem("customer_user_id");j(!1);try{const s={items:o.map(e=>({product_id:e.product_id,sku:e.sku,quantity:e.quantity})),payment_type:e.toLowerCase(),money_received:U,business_id:Number(t),customer_user_id:a?Number(a):null,transaction_number:localStorage.getItem("provisionalTransactionNumber")},i=await r("/api/sales/public/checkout",{method:"POST",body:JSON.stringify(s)});u([]),i.qr_payload?(L(!0),M(""),T(i.qr_payload),B(i.transaction_id)):M("Failed to generate payment QR")}catch(s){M("Checkout failed")}return}if("GCash"!==e)try{const s=localStorage.getItem("customer_user_id"),a={items:o.map(e=>({product_id:e.product_id,sku:e.sku,quantity:e.quantity})),payment_type:e,money_received:U,business_id:Number(t),customer_user_id:s?Number(s):null,transaction_number:localStorage.getItem("provisionalTransactionNumber")},i=await r("/api/sales/public/checkout",{method:"POST",body:JSON.stringify(a)});if(u([]),i.qr_payload)L(!0),M(""),T(i.qr_payload),B(i.transaction_id);else{const e=new URL(window.location.origin+"/receipt");e.searchParams.set("tn",i.transaction_number),e.searchParams.set("tid",String(i.transaction_id)),e.searchParams.set("total",String(i.total||0)),window.location.href=e.toString()}}catch(s){M("Checkout failed")}finally{j(!1)}else try{const e=window.location.origin+"/customer?payment=success",t=window.location.origin+"/customer?payment=cancel";localStorage.setItem("pending_gcash_cart_public",JSON.stringify({items:o.map(e=>({product_id:e.product_id,sku:e.sku,quantity:e.quantity})),total:U,transactionNumber:localStorage.getItem("provisionalTransactionNumber")}));const{checkoutUrl:s}=await c({amount:Number(U||0),description:"Self-checkout Order",referenceNumber:`SC-${Date.now()}`,cancelUrl:t,successUrl:e});window.location.href=s}catch(a){P("Failed to initialize online payment"),localStorage.removeItem("pending_gcash_cart_public")}finally{j(!1)}}}),e.jsx(g,{isOpen:q,onClose:()=>L(!1),onTransactionComplete:e=>{L(!1),n(`/receipt?tn=${e}&from=customer`)},qrPayload:R,transactionId:z}),e.jsx(s,{children:S&&e.jsx(t.div,{className:"px-4 mt-4 max-w-screen-md mx-auto",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-xl p-4 text-green-700 text-sm shadow-lg backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:S})]})})})})]})]})}export{f as M};
//# sourceMappingURL=MobileScannerView-g2X6YJra.js.map
