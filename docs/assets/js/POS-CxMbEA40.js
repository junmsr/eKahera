import{j as e}from"./utils-B2FtDWBX.js";import{u as t,a as s,R as a}from"./vendor-mHQTfcnf.js";import{S as n}from"./ScannerCard-CU2Pf-JL.js";import{P as o}from"./PageLayout-BtLpjQ7R.js";import{S as r,C as i,D as c,P as l,a as d,b as m,c as u,d as h}from"./ScanCustomerCartModal-DETaSfGI.js";import{a as p,b as f,d as g}from"./index-C9q1jg2T.js";import{N as x}from"./Nav-Admin-DAvPkiTQ.js";import{P as w}from"./ProfileModal-BP2vGh1v.js";import{N as S}from"./NotificationDropdown-CrXtv_k3.js";import"./qr-CE9N9WuW.js";import"./Navbar-BRrsrSrO.js";import"./Logo-DJ17xljn.js";/* empty css              */import"./PrivacyPolicyModal-Nf9ZWTPr.js";import"./BaseModal-DLQpfPIu.js";import"./Card-BnHxHSFu.js";import"./Input-Cu9uKTuc.js";import"./FormField-BokbHxN5.js";import"./index-DrH1VSyj.js";function y(){const y=t(),[j,v]=s.useState(""),[b,k]=s.useState(1),[_,N]=s.useState([]),[C,O]=s.useState(!1),[I,L]=s.useState(!1),[P,M]=s.useState(""),[$,R]=s.useState(!1),[A,q]=s.useState(!1),[F,D]=s.useState(!1),[z,B]=s.useState(!1),[E,U]=s.useState(null),[J,T]=s.useState(!1),[W,H]=s.useState(!1),[G,K]=s.useState(""),[V,Z]=s.useState(""),[Q,X]=s.useState(null),[Y,ee]=s.useState(!1),[te,se]=s.useState(!1),ae=s.useRef(null),ne=s.useRef(null),[oe,re]=s.useState(!1),ie=sessionStorage.getItem("auth_token"),ce=JSON.parse(sessionStorage.getItem("user")||"{}"),le=a.useRef(!1),[de,me]=s.useState("");s.useEffect(()=>{const e=e=>{if(!e.repeat)switch(e.key){case"F3":e.preventDefault(),ne.current?.focus();break;case"F4":e.preventDefault(),q(!0);break;case"F5":e.preventDefault(),O(!0);break;case"F6":e.preventDefault(),L(!0);break;case"F7":e.preventDefault(),R(!0);break;case"F8":e.preventDefault(),_.length>0&&D(!0)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[_.length]),s.useEffect(()=>{if(!V){const e=ce?.businessId||ce?.business_id||"BIZ",t=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),s=Math.floor(1e3+9e3*Math.random());Z(`T-${e}-${t}-${s}`)}},[]),s.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment"),t=localStorage.getItem("pending_gcash_cart");if("success"===e&&t)try{const e=JSON.parse(t);(async()=>{if(le.current)return;const t="gcash_finalize_done";if("1"!==sessionStorage.getItem(t)){le.current=!0,sessionStorage.setItem(t,"1");try{K("");const t={items:e.items||[],payment_type:"gcash",money_received:e.total||null},a=await p("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ie}`},body:JSON.stringify(t)});a?.transaction_number&&Z(a.transaction_number),a?.transaction_id&&X(a.transaction_id),N([]);try{const e=new URL(window.location.origin+"/receipt");a?.transaction_number&&e.searchParams.set("tn",a.transaction_number),a?.transaction_id&&e.searchParams.set("tid",String(a.transaction_id)),null!=a?.total&&e.searchParams.set("total",String(a.total)),window.location.href=e.toString()}catch(s){}}catch(a){K("Failed to record GCASH payment")}finally{localStorage.removeItem("pending_gcash_cart");const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}}})()}catch(s){localStorage.removeItem("pending_gcash_cart")}else if("cancel"===e){localStorage.removeItem("pending_gcash_cart");const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}},[]);const ue=async(e,t=1)=>{if(e&&!(t<1)){K("");try{const s=await p(`/api/products/sku/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${ie}`}}),a=Number(s.selling_price||0),n=Number(s.stock_quantity??0);if(n<=0)return void K(`Stock for ${s.product_name} (SKU ${s.sku}) is 0.`);if(t>n)return void K(`Insufficient stock. Available: ${n}, requested: ${t}.`);N(e=>{const o=e.findIndex(e=>e.product_id===s.product_id);if(o>=0){const s=[...e],a=s[o].quantity+t;return a>n?(K(`Insufficient stock. Available: ${n}, requested: ${a}.`),e):(s[o]={...s[o],quantity:a},s)}return[...e,{product_id:s.product_id,sku:s.sku,name:s.product_name,quantity:t,price:a}]}),v(""),k(1),H(!1)}catch(s){K("Product not found")}}},he=_.reduce((e,t)=>e+t.price*t.quantity,0),pe=async(e="cash",t=he)=>{if(0!==_.length){K("");try{const a={items:_.map(e=>({product_id:e.product_id,quantity:e.quantity})),payment_type:e,money_received:t},n=await p("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ie}`},body:JSON.stringify(a)});n?.transaction_number&&Z(n.transaction_number),n?.transaction_id&&X(n.transaction_id),N([]);try{const e=new URL(window.location.origin+"/receipt");n?.transaction_number&&e.searchParams.set("tn",n.transaction_number),n?.transaction_id&&e.searchParams.set("tid",String(n.transaction_id)),null!=n?.total&&e.searchParams.set("total",String(n.total)),y(e.pathname+e.search)}catch(s){}const o=ce?.businessId||ce?.business_id||"BIZ",r=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),i=Math.floor(1e3+9e3*Math.random());Z(`T-${o}-${r}-${i}`)}catch(a){K("Checkout failed")}}},[fe,ge]=s.useState([]),[xe,we]=s.useState(0),Se=()=>{try{return JSON.parse(sessionStorage.getItem("read_notif_ids")||"[]")}catch(e){return[]}};s.useEffect(()=>{(async()=>{try{const e=await p("/api/logs",{headers:{Authorization:`Bearer ${ie}`}}),t=new Set(Se()),s=new Set(JSON.parse(sessionStorage.getItem("deleted_notif_ids")||"[]")),a=(e||[]).filter(e=>!s.has(e.log_id)).map(e=>({id:e.log_id,title:e.action,message:`${e.username} (${e.role}) did an action: ${e.action}`,time:new Date(e.date_time).toLocaleString(),isRead:t.has(e.log_id)}));ge(a),we(a.filter(e=>!e.isRead).length)}catch(e){console.error("Failed to fetch notifications",e)}})()},[]),s.useEffect(()=>{ie&&(async()=>{try{const e=await p("/api/business/profile",{headers:{Authorization:`Bearer ${ie}`}});e?.business?.business_name&&me(e.business.business_name)}catch(e){console.error("Failed to fetch business name",e)}})()},[ie]),s.useEffect(()=>{const e=e=>{ae.current&&!ae.current.contains(e.target)&&ee(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const ye=e.jsxs("div",{className:"flex items-center gap-1 sm:gap-4 mr-3",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("button",{onClick:async()=>{try{if(!ce.store_name)return;await navigator.clipboard.writeText(ce.store_name)}catch(e){}},title:"Copy store name",className:"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm",children:[e.jsx("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2"})}),e.jsx("span",{className:"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]",children:ce.store_name})]})}),e.jsx("div",{className:"relative",ref:ae,children:e.jsx(S,{notifications:fe,unreadCount:xe,onMarkAsRead:e=>{const t=Se();t.includes(e)||sessionStorage.setItem("read_notif_ids",JSON.stringify([...t,e])),ge(t=>t.map(t=>t.id===e?{...t,isRead:!0}:t)),we(e=>Math.max(0,e-1))},onMarkAsUnread:e=>{const t=Se().filter(t=>t!==e);sessionStorage.setItem("read_notif_ids",JSON.stringify(t)),ge(t=>t.map(t=>t.id===e?{...t,isRead:!1}:t)),we(e=>e+1)},onDelete:e=>{const t=JSON.parse(sessionStorage.getItem("deleted_notif_ids")||"[]");sessionStorage.setItem("deleted_notif_ids",JSON.stringify([...t,e])),ge(t=>t.filter(t=>t.id!==e));const s=fe.find(t=>t.id===e);s&&!s.isRead&&we(e=>Math.max(0,e-1))},isOpen:Y,onToggle:()=>ee(!Y),containerRef:ae})}),e.jsxs("button",{onClick:()=>se(!0),className:"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80",children:[e.jsx("div",{className:"w-6 h-6 sm:w-7 sm:h-7 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full flex items-center justify-center text-sm font-medium shadow-md",children:ce.username?.[0]?.toUpperCase()||"A"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 hidden sm:inline",children:ce.username||"Admin"})]})]});return e.jsxs(o,{title:de?`${de} - POS`:"POS",sidebar:e.jsx(x,{}),headerActions:ye,isSidebarOpen:oe,setSidebarOpen:re,children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-screen",children:e.jsx("main",{className:"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4",children:e.jsxs("div",{className:"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(n,{onScan:async e=>{const t=e?.[0]?.rawValue;t&&(H(!0),I?M(t):await ue(t,1))},paused:W,onResume:()=>H(!1),textMain:"text-blue-700"})}),e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx(r,{ref:ne,sku:j,setSku:v,quantity:b,setQuantity:k,handleAddToCart:async()=>{await ue(j,b)}}),G&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),e.jsx("p",{className:"text-sm font-medium text-red-700",children:(()=>{try{const e=JSON.parse(G);return e.error||e.message||G}catch{return G}})()})]})]})]}),e.jsxs("div",{className:"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0",children:[e.jsx("div",{className:"flex-1 min-h-0 max-h-[calc(100vh-280px)]",children:e.jsx(i,{cart:_,handleRemove:e=>N(_.filter((t,s)=>s!==e)),handleEditQuantity:async(e,t)=>{if(t<1)return void K("Quantity must be at least 1");const s=_[e];if(s){K("");try{const a=await p(`/api/products/sku/${encodeURIComponent(s.sku)}`,{headers:{Authorization:`Bearer ${ie}`}}),n=Number(a.stock_quantity??0);if(t>n)return void K(`Insufficient stock. Available: ${n}, requested: ${t}.`);N(s=>s.map((s,a)=>a===e?{...s,quantity:t}:s))}catch(a){K(a.message||"Failed to update quantity")}}},total:he,className:"flex-1 h-full"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0",children:[e.jsx("div",{className:"col-span-8",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3",children:[e.jsx(f,{label:"CASH LEDGER (F4)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",variant:"secondary",microinteraction:!0,onClick:()=>q(!0),icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(f,{label:"DISCOUNT (F5)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>O(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(f,{label:"PRICE CHECK (F6)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>L(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(f,{label:"IMPORT CART (F7)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>R(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),iconPosition:"left"})]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(f,{label:"CHECKOUT (F8)",size:"md",className:"w-full h-full text-sm sm:text-base font-bold",variant:"primary",microinteraction:!0,onClick:()=>D(!0),disabled:0===_.length,icon:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"})})]})]})]})})}),e.jsx(c,{isOpen:C,onClose:()=>O(!1),onApplyDiscount:e=>{O(!1)}}),e.jsx(l,{isOpen:I,onClose:()=>L(!1),sku:P,setSku:M}),e.jsx(d,{isOpen:A,onClose:()=>q(!1)}),e.jsx(m,{isOpen:F,onClose:()=>D(!1),total:he,onSelectPayment:e=>{U(e),D(!1),"cash"===e?B(!0):"gcash"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_gcash_cart",JSON.stringify({items:_.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:he}));const{checkoutUrl:s}=await g({amount:Number(he||0),description:"POS Order",referenceNumber:V||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.location.href=s}catch(e){K("Failed to init GCash"),localStorage.removeItem("pending_gcash_cart")}})():pe(e)}}),e.jsx(u,{isOpen:z,onClose:()=>B(!1),total:he,onConfirm:e=>{pe("cash",e),B(!1)}}),e.jsx(w,{isOpen:te,onClose:()=>se(!1),userData:ce}),e.jsx(h,{isOpen:$,onClose:()=>R(!1),onImport:e=>{N(t=>{const s=new Map(t.map(e=>[e.sku,e]));for(const a of e){const e=s.get(a.sku);e?e.quantity+=a.quantity:s.set(a.sku,{...a})}return Array.from(s.values())})}})]})}export{y as default};
//# sourceMappingURL=POS-CxMbEA40.js.map
