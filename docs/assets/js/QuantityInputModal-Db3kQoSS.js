import{j as e}from"./utils-BnCj7yKo.js";import{a as t}from"./vendor-BZrj58oz.js";import{B as s,M as r,a}from"./BaseModal-C-8Qp-dk.js";import{S as n}from"./ScannerCard-DdUmj5XW.js";import{a as i,b as o}from"./index-B6EMrwoj.js";import{u as l}from"./useKeyboardShortcuts-C3XQk2oo.js";function c({isOpen:r,onClose:a,onImport:c}){const[d,u]=t.useState(!1),[m,x]=t.useState(""),p=sessionStorage.getItem("auth_token"),b=JSON.parse(sessionStorage.getItem("user")||"{}"),h=e.jsx(o,{label:"Close (Esc)",variant:"secondary",onClick:a,className:"w-full"});return l([{key:"escape",action:a,enabled:r}],[r]),e.jsxs(s,{isOpen:r,onClose:a,title:"Scan Customer Cart",subtitle:"Ask customer to show their QR",icon:e.jsx("svg",{className:"w-5 h-5 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),footer:h,size:"lg",contentClassName:"space-y-3",children:[e.jsx("div",{className:"text-blue-800 text-sm font-medium",children:"Ask the customer to show their cart QR code"}),e.jsx("div",{className:"h-[50vh]",children:e.jsx(n,{onScan:async e=>{const t=e?.[0]?.rawValue;if(t){u(!0),x("");try{let e;try{e=JSON.parse(t)}catch(s){throw new Error("Invalid QR payload")}if("cart"===e.t&&e.transaction_id){const{transaction_id:t,business_id:s}=e,n=b?.businessId||b?.business_id;if(s&&n&&Number(s)!==Number(n))throw new Error("This QR code is not valid for this store.");try{const e=await i(`/api/sales/${t}/pending-items`,{method:"GET",headers:{Authorization:`Bearer ${p}`}});if(e.transaction_id&&e.items)return c(e.items,e.transaction_id,null,e.transaction_number),void a();throw new Error("Failed to load transaction items")}catch(r){throw console.error("Error loading transaction items:",r),new Error(r.message||"Failed to load customer transaction items")}}else{if("cart"!==e.t||!Array.isArray(e.items))throw new Error("Unsupported QR code format");{const{items:t,b:s}=e,r=b?.businessId||b?.business_id;if(s&&r&&Number(s)!==Number(r))throw new Error("This QR code is not valid for this store.");const n=[];for(const e of t){if(!e?.p||!e?.q)continue;const t=await i(`/api/products/${encodeURIComponent(e.p)}`,{headers:{Authorization:`Bearer ${p}`}});n.push({product_id:t.product_id,sku:t.sku,name:t.product_name,quantity:Number(e.q),price:Number(t.selling_price||0)})}if(0===n.length)throw new Error("No items to import");c(n),a()}}}catch(s){x(s.message||"Failed to process QR code"),console.error("Scan error:",s)}finally{setTimeout(()=>{u(!1)},500)}}},paused:d,onResume:()=>u(!1),className:"w-full h-full"})}),m&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:m}),e.jsx("div",{className:"text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Close:"}),e.jsx("span",{className:"font-mono bg-white px-2 py-0.5 rounded",children:"Esc"})]})})]})}function d({isOpen:n,onClose:i,product:c,onConfirm:d,existingQuantity:u=0}){const[m,x]=t.useState(""),[p,b]=t.useState(""),h=t.useRef(null);t.useEffect(()=>{n&&(x(""),b(""),setTimeout(()=>{h.current?.focus(),h.current?.select()},100))},[n]);const f=()=>{if(!c)return"";return c.base_unit||""},g=()=>{if(!c)return"";const e=c.base_unit||"";return"g"===e?"Grams (g)":"kg"===e?"Kilograms (kg)":"mL"===e?"Milliliters (mL)":"L"===e?"Liters (L)":e},y=()=>{if(!c||"count"===c.product_type)return Number(c.selling_price||0);const e=Number(c.quantity_per_unit||1),t=Number(c.selling_price||0);return e>0?t/e:t},N=()=>{if(!c)return"0";const e=Number(c.stock_quantity||0);if("count"===c.product_type)return`${e} pcs`;const t=f();let s=e,r=t;return"g"===t&&e>=1e3?(s=e/1e3,r="kg"):"mL"===t&&e>=1e3&&(s=e/1e3,r="L"),s%1==0?`${s} ${r}`:`${s.toFixed(2)} ${r}`},j=e=>{e&&e.preventDefault();const t=Number(m);if(!m||""===m.trim())return void b("Please enter a quantity");if(isNaN(t)||t<=0)return void b("Quantity must be greater than 0");const s=t,r=Number(c.stock_quantity||0);if(s+(u||0)>r){const e=f();return void b(`Insufficient stock. Available: ${N()}, requested: ${t} ${e}`)}d(s)};if(l([{key:"escape",action:i,enabled:n},{key:"enter",action:j,enabled:n&&m}],[n,m]),!c)return null;const _="weight"===c.product_type,v="volume"===c.product_type,w=N(),k=e.jsxs("div",{className:"flex gap-3 w-full",children:[e.jsx(o,{label:"Cancel",variant:"secondary",onClick:i,type:"button",className:"flex-1"}),e.jsx(o,{label:"Add to Cart",variant:"primary",type:"submit",onClick:j,className:"flex-1"})]});return e.jsx(s,{isOpen:n,onClose:i,title:"Enter Quantity",subtitle:`How much ${c.product_name} would you like to add?`,icon:_?e.jsx(r,{className:"w-6 h-6 text-white"}):e.jsx(a,{className:"w-6 h-6 text-white"}),size:"md",footer:k,headerIconBgClassName:_?"bg-gradient-to-br from-amber-500 to-orange-600":"bg-gradient-to-br from-blue-500 to-cyan-600",contentClassName:"space-y-6",children:e.jsxs("form",{onSubmit:j,className:"space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-slate-50 to-blue-50/30 rounded-xl p-4 border border-slate-200",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-1",children:c.product_name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[_&&"Sold by weight",v&&"Sold by volume"]}),c.display_unit&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Package: ",c.display_unit]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-lg font-bold text-blue-600",children:["₱",Number(c.selling_price||0).toFixed(2)]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Available: ",w]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700",children:["Enter Quantity (",g(),")",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{ref:h,type:"number",value:m,onChange:e=>{x(e.target.value),b("")},placeholder:"e.g., 0.25, 1.5, 250",className:"w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-gray-900 font-medium text-lg",step:"0.01",min:"0.01",required:!0,autoFocus:!0}),e.jsx("div",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium",children:f()})]}),p&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Enter the quantity in ",g().toLowerCase(),". You can enter any amount (e.g., 0.25L for 250mL, 1.5L, etc.).",c.display_unit&&c.quantity_per_unit&&e.jsxs("span",{className:"block mt-1 text-gray-400",children:["(Each package contains ",c.quantity_per_unit," ",f(),")"]})]})]}),m&&!isNaN(Number(m))&&Number(m)>0&&e.jsxs("div",{className:"bg-blue-50 rounded-xl p-4 border border-blue-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Estimated Total:"}),e.jsxs("span",{className:"text-xl font-bold text-blue-600",children:["₱",(C=Number(m),c&&"count"!==c.product_type?C*y():C*Number(c.selling_price||0)).toFixed(2)]})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[m," ",f()," × ₱",y().toFixed(2)," per ",f()]}),"count"!==c.product_type&&c.quantity_per_unit&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["(Price per package: ₱",Number(c.selling_price||0).toFixed(2)," for ",c.quantity_per_unit," ",f(),")"]})]})]})});var C}export{d as Q,c as S};
//# sourceMappingURL=QuantityInputModal-Db3kQoSS.js.map
