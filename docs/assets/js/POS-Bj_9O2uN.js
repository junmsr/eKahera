import{j as e}from"./utils-L0j39QIW.js";import{a as t,u as s,R as a}from"./vendor-DPJ7iNYg.js";import{S as n}from"./ScannerCard-D_DUdZEG.js";import{P as r}from"./PageLayout-B8S1WfrH.js";import{S as o,C as i,D as c,P as l,a as d,b as m,c as u,d as p}from"./ScanCustomerCartModal-CPcYVW_0.js";import{b as h,a as x,d as f,e as g}from"./index-C3oyeyrQ.js";import{N as y}from"./Nav-Admin-D_8KEzuU.js";import{P as b}from"./ProfileModal-CxynDHFl.js";import{f as w}from"./index-BXEzUCnW.js";import{B as j}from"./BaseModal-BJkFAYW_.js";import"./qr-Dta_7pGb.js";import"./Navbar-C-KCmNet.js";import"./Logo-CwZruO2T.js";import"./PrivacyPolicyModal-gs4rrr-L.js";import"./Card-Cru2VKQZ.js";function v({isOpen:s,onClose:a}){const[n,r]=t.useState([]),[o,i]=t.useState(!1),[c,l]=t.useState("");t.useEffect(()=>{if(!s)return;(async()=>{i(!0),l("");try{const e=sessionStorage.getItem("auth_token"),t=await x("/api/sales/business/recent",{headers:{Authorization:`Bearer ${e}`}});r(Array.isArray(t)?t:[])}catch(e){console.error("Error fetching receipts:",e),l("Failed to load receipts. Please try again.")}finally{i(!1)}})()},[s]);return e.jsxs(j,{isOpen:s,onClose:a,title:"All Transactions",subtitle:"Latest transactions across all cashiers",size:"lg",footer:e.jsx(h,{label:"Close",variant:"secondary",onClick:a,className:"w-full"}),children:[o&&e.jsx("div",{className:"text-sm text-gray-600 py-4 text-center",children:"Loading transactions..."}),c&&e.jsx("div",{className:"text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg px-3 py-2 mb-2",children:c}),!o&&!c&&0===n.length&&e.jsx("div",{className:"text-sm text-gray-500 py-6 text-center",children:"No transactions found."}),e.jsx("div",{className:"space-y-2 max-h-[60vh] overflow-y-auto",children:n.map(t=>e.jsxs("button",{onClick:()=>(e=>{const t=new URL(window.location.origin+"/receipt");e.transaction_number&&t.searchParams.set("tn",e.transaction_number),e.transaction_id&&t.searchParams.set("tid",String(e.transaction_id)),window.open(t.toString(),"_blank")})(t),className:"w-full text-left border border-gray-200 rounded-xl px-3 py-2 hover:border-blue-300 hover:bg-blue-50 transition-colors",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:t.transaction_number||`TXN-${t.transaction_id||""}`}),e.jsx("p",{className:"text-xs text-gray-600",children:new Date(t.updated_at||t.created_at).toLocaleString()})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-bold text-blue-700",children:["₱",Number(t.total_amount||t.total||0).toFixed(2)]}),e.jsx("p",{className:"text-[11px] text-gray-600 uppercase",children:t.payment?.method||t.payment_type||"cash"})]})]}),(t.discount_percentage||t.discount_amount)&&e.jsxs("p",{className:"text-[11px] text-emerald-700 mt-1",children:["Discount applied"," ",t.discount_percentage?`${t.discount_percentage}%`:`₱${Number(t.discount_amount||0).toFixed(2)}`]})]},`${t.transaction_id}-${t.transaction_number}`))})]})}function S(){const j=s(),[S,k]=t.useState(""),[N,_]=t.useState(1),[C,P]=t.useState([]),[L,O]=t.useState(!1),[$,I]=t.useState(!1),[M,F]=t.useState(""),[A,q]=t.useState(!1),[D,R]=t.useState(!1),[U,z]=t.useState(!1),[B,E]=t.useState(!1),[T,J]=t.useState(null),[W,V]=t.useState(!1),[H,Q]=t.useState(!1),[Z,G]=t.useState(""),[K,X]=t.useState(""),[Y,ee]=t.useState(null),[te,se]=t.useState(!1),[ae,ne]=t.useState(!1),re=t.useRef(null),[oe,ie]=t.useState(!1),ce=sessionStorage.getItem("auth_token"),le=JSON.parse(sessionStorage.getItem("user")||"{}"),de=a.useRef(!1),[me,ue]=t.useState("");t.useEffect(()=>{const e=e=>{if(!e.repeat)switch(e.key){case"F3":e.preventDefault(),re.current?.focus();break;case"F4":e.preventDefault(),R(!0);break;case"F5":e.preventDefault(),O(!0);break;case"F6":e.preventDefault(),I(!0);break;case"F7":e.preventDefault(),q(!0);break;case"F8":e.preventDefault(),C.length>0&&z(!0)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[C.length]),t.useEffect(()=>{if(!K){const e=le?.businessId||le?.business_id||"BIZ",t=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),s=Math.floor(1e3+9e3*Math.random());X(`T-${e}-${t}-${s}`)}},[]),t.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment"),t=le?.businessId||le?.business_id,s=window.opener&&!window.opener.closed,a=async(a,n)=>{const r=localStorage.getItem(a);if("success"===e&&r&&t)try{const e=JSON.parse(r);if(de.current)return;const t=`${n}_finalize_done`;if("1"===sessionStorage.getItem(t))return;de.current=!0,sessionStorage.setItem(t,"1");try{G("");const t={items:e.items||[],payment_type:n.toLowerCase(),money_received:e.total||null},a=await x("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ce}`},body:JSON.stringify(t)});a?.transaction_number&&X(a.transaction_number),a?.transaction_id&&ee(a.transaction_id),P([]);try{const e=new URL(window.location.origin+"/receipt");a?.transaction_number&&e.searchParams.set("tn",a.transaction_number),a?.transaction_id&&e.searchParams.set("tid",String(a.transaction_id)),null!=a?.total&&e.searchParams.set("total",String(a.total)),s&&window.opener?(window.opener.location.href=e.toString(),window.close()):window.location.href=e.toString()}catch(o){}}catch(i){G(`Failed to record ${n} payment`)}finally{if(localStorage.removeItem(a),!s){const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}}}catch(o){localStorage.removeItem(a)}else if("cancel"===e&&r)if(localStorage.removeItem(a),s&&window.opener)window.close();else{const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}};a("pending_gcash_cart","GCash"),a("pending_maya_cart","Maya")},[]);const pe=async(e,t=1)=>{if(e&&!(t<1)){G("");try{const s=await x(`/api/products/sku/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${ce}`}}),a=Number(s.selling_price||0),n=Number(s.stock_quantity??0);if(n<=0)return void G(`Stock for ${s.product_name} (SKU ${s.sku}) is 0.`);if(t>n)return void G(`Insufficient stock. Available: ${n}, requested: ${t}.`);P(e=>{const r=e.findIndex(e=>e.product_id===s.product_id);if(r>=0){const s=[...e],a=s[r].quantity+t;return a>n?(G(`Insufficient stock. Available: ${n}, requested: ${a}.`),e):(s[r]={...s[r],quantity:a},s)}return[...e,{product_id:s.product_id,sku:s.sku,name:s.product_name,quantity:t,price:a}]}),k(""),_(1),Q(!1)}catch(s){G("Product not found")}}},he=C.reduce((e,t)=>e+t.price*t.quantity,0),[xe,fe]=t.useState(null),ge="percentage"===xe?.type?Math.max(0,he-he*(Number(xe.value||0)/100)):"amount"===xe?.type?Math.max(0,he-Number(xe.value||0)):he,ye=async(e,t=null)=>{if(0!==C.length){G("");try{const a={items:C.map(e=>({product_id:e.product_id,quantity:e.quantity,price:e.price})),payment_type:e,money_received:t,transaction_id:Y,transaction_number:K,discount_id:xe?.discount_id||null,discount_percentage:"percentage"===xe?.type?xe.value:null,discount_amount:"amount"===xe?.type?xe.value:null},n=await x("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${ce}`},body:JSON.stringify(a)});n?.transaction_number&&X(n.transaction_number),n?.transaction_id&&ee(n.transaction_id),P([]);try{const e=new URL(window.location.origin+"/receipt");n?.transaction_number&&e.searchParams.set("tn",n.transaction_number),n?.transaction_id&&e.searchParams.set("tid",String(n.transaction_id)),null!=n?.total&&e.searchParams.set("total",String(n.total)),j(e.pathname+e.search)}catch(s){}const r=le?.businessId||le?.business_id||"BIZ",o=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),i=Math.floor(1e3+9e3*Math.random());X(`T-${r}-${o}-${i}`),fe(null)}catch(a){console.error("Checkout error:",a),G("Checkout failed")}}},[be,we]=t.useState(!1),je=e.jsxs("div",{className:"flex items-center gap-1 sm:gap-4 mr-3",children:[e.jsxs("div",{className:"space-y-2",children:[xe&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-green-600",children:[e.jsx("span",{children:"Discount Applied:"}),e.jsx("span",{className:"font-medium",children:"percentage"===xe.type?`${xe.value}%`:`₱${Number(xe.value).toFixed(2)}`})]}),e.jsxs("div",{className:"flex items-center justify-between text-lg font-semibold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[xe&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["₱",he.toFixed(2)]}),e.jsxs("span",{children:["₱",ge.toFixed(2)]})]})]})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("button",{onClick:async()=>{try{if(!le.store_name)return;await navigator.clipboard.writeText(le.store_name)}catch(e){}},title:"Copy store name",className:"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm",children:[e.jsx("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2"})}),e.jsx("span",{className:"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]",children:le.store_name})]})}),e.jsxs("button",{onClick:()=>se(!0),className:"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80 hover:bg-gray-50 transition-colors",title:"View all receipts",children:[e.jsx("div",{className:"relative",children:e.jsx(w,{className:"w-5 h-5 text-blue-600"})}),e.jsx("span",{className:"text-sm font-medium text-gray-700 hidden sm:inline",children:"Receipts"})]}),e.jsxs("button",{onClick:()=>ne(!0),className:"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80",children:[e.jsx("div",{className:"w-6 h-6 sm:w-7 sm:h-7 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full flex items-center justify-center text-sm font-medium shadow-md",children:le.username?.[0]?.toUpperCase()||"A"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 hidden sm:inline",children:le.username||"Admin"})]})]});return e.jsxs(r,{title:"POS",sidebar:e.jsx(y,{}),headerActions:je,isSidebarOpen:oe,setSidebarOpen:ie,children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-screen",children:e.jsx("main",{className:"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4",children:e.jsxs("div",{className:"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(n,{onScan:async e=>{const t=e?.[0]?.rawValue;t&&(Q(!0),$?F(t):await pe(t,1))},paused:H,onResume:()=>Q(!1),textMain:"text-blue-700"})}),e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx(o,{ref:re,sku:S,setSku:k,quantity:N,setQuantity:_,handleAddToCart:async()=>{await pe(S,N)}}),Z&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),e.jsx("p",{className:"text-sm font-medium text-red-700",children:(()=>{try{const e=JSON.parse(Z);return e.error||e.message||Z}catch{return Z}})()})]})]})]}),e.jsxs("div",{className:"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0",children:[e.jsx("div",{className:"flex-1 min-h-0 max-h-[calc(100vh-280px)]",children:e.jsx(i,{cart:C,handleRemove:e=>P(C.filter((t,s)=>s!==e)),handleEditQuantity:async(e,t)=>{if(t<1)return void G("Quantity must be at least 1");const s=C[e];if(s){G("");try{const a=await x(`/api/products/sku/${encodeURIComponent(s.sku)}`,{headers:{Authorization:`Bearer ${ce}`}}),n=Number(a.stock_quantity??0);if(t>n)return void G(`Insufficient stock. Available: ${n}, requested: ${t}.`);P(s=>s.map((s,a)=>a===e?{...s,quantity:t}:s))}catch(a){G(a.message||"Failed to update quantity")}}},total:ge,className:"flex-1 h-full"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0",children:[e.jsx("div",{className:"col-span-8",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3",children:[e.jsx(h,{label:"CASH LEDGER (F4)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",variant:"secondary",microinteraction:!0,onClick:()=>R(!0),icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:xe?"Edit Discount (F5)":"Add Discount (F5)",variant:xe?"primary":"secondary",onClick:()=>O(!0),icon:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),className:"flex-1 "+(xe?"bg-green-600 hover:bg-green-700":"")}),e.jsx(h,{label:"PRICE CHECK (F6)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>I(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:"SCAN CUSTOMER QR (F7)",size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>q(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),iconPosition:"left"})]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(h,{label:"CHECKOUT (F8)",size:"md",className:"w-full h-full text-sm sm:text-base font-bold",variant:"primary",microinteraction:!0,onClick:()=>z(!0),disabled:0===C.length,icon:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"})})]})]})]})})}),e.jsx(c,{isOpen:L,onClose:()=>O(!1),onApplyDiscount:e=>{fe(e)}}),e.jsx(l,{isOpen:$,onClose:()=>I(!1),sku:M,setSku:F}),e.jsx(d,{isOpen:D,onClose:()=>R(!1)}),e.jsx(v,{isOpen:te,onClose:()=>se(!1)}),e.jsx(m,{isOpen:U,onClose:()=>z(!1),total:ge,onSelectPayment:e=>{J(e),z(!1),"cash"===e?E(!0):"gcash"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_gcash_cart",JSON.stringify({items:C.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:ge}));const{checkoutUrl:s}=await f({amount:Number(ge||0),description:"POS Order",referenceNumber:K||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(s,"_blank")}catch(e){G("Failed to init GCash"),localStorage.removeItem("pending_gcash_cart")}})():"maya"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_maya_cart",JSON.stringify({items:C.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:ge}));const{checkoutUrl:s}=await g({amount:Number(ge||0),description:"POS Order",referenceNumber:K||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(s,"_blank")}catch(e){G("Failed to init Maya"),localStorage.removeItem("pending_maya_cart")}})():ye(e)}}),e.jsx(u,{isOpen:B,onClose:()=>E(!1),total:ge,onConfirm:e=>{ye("cash",e),E(!1)}}),e.jsx(b,{isOpen:ae,onClose:()=>ne(!1),userData:le}),e.jsx(p,{isOpen:A,onClose:()=>q(!1),onImport:(e,t)=>{t&&ee(t),P(t=>{const s=new Map(t.map(e=>[e.sku,e]));for(const a of e){const e=s.get(a.sku);e?e.quantity+=a.quantity:s.set(a.sku,{...a})}return Array.from(s.values())})}})]})}export{S as default};
//# sourceMappingURL=POS-Bj_9O2uN.js.map
