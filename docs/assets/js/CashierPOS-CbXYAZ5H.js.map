{"version":3,"file":"CashierPOS-CbXYAZ5H.js","sources":["../../../frontend/src/components/modals/RecentReceiptsModal.jsx","../../../frontend/src/pages/CashierPOS.jsx"],"sourcesContent":["import React, { useEffect, useState } from \"react\";\r\nimport BaseModal from \"./BaseModal\";\r\nimport Button from \"../common/Button\";\r\nimport { api } from \"../../lib/api\";\r\n\r\nfunction RecentReceiptsModal({ isOpen, onClose }) {\r\n  const [receipts, setReceipts] = useState([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n    const fetchReceipts = async () => {\r\n      setLoading(true);\r\n      setError(\"\");\r\n      try {\r\n        const token = sessionStorage.getItem(\"auth_token\");\r\n        const data = await api(\"/api/sales/cashier/recent\", {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n        setReceipts(Array.isArray(data) ? data : []);\r\n      } catch (e) {\r\n        setError(\"Failed to load receipts\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n    fetchReceipts();\r\n  }, [isOpen]);\r\n\r\n  const openReceipt = (receipt) => {\r\n    const url = new URL(window.location.origin + \"/receipt\");\r\n    if (receipt.transaction_number)\r\n      url.searchParams.set(\"tn\", receipt.transaction_number);\r\n    if (receipt.transaction_id)\r\n      url.searchParams.set(\"tid\", String(receipt.transaction_id));\r\n    window.open(url.toString(), \"_blank\");\r\n  };\r\n\r\n  return (\r\n    <BaseModal\r\n      isOpen={isOpen}\r\n      onClose={onClose}\r\n      title=\"Recent Receipts\"\r\n      subtitle=\"Latest transactions handled by you\"\r\n      size=\"lg\"\r\n      footer={\r\n        <Button\r\n          label=\"Close\"\r\n          variant=\"secondary\"\r\n          onClick={onClose}\r\n          className=\"w-full\"\r\n        />\r\n      }\r\n    >\r\n      {loading && (\r\n        <div className=\"text-sm text-gray-600 py-4 text-center\">\r\n          Loading receipts...\r\n        </div>\r\n      )}\r\n      {error && (\r\n        <div className=\"text-sm text-red-600 bg-red-50 border border-red-100 rounded-lg px-3 py-2 mb-2\">\r\n          {error}\r\n        </div>\r\n      )}\r\n      {!loading && !error && receipts.length === 0 && (\r\n        <div className=\"text-sm text-gray-500 py-6 text-center\">\r\n          No receipts found.\r\n        </div>\r\n      )}\r\n      <div className=\"space-y-2 max-h-[60vh] overflow-y-auto\">\r\n        {receipts.map((r) => (\r\n          <button\r\n            key={`${r.transaction_id}-${r.transaction_number}`}\r\n            onClick={() => openReceipt(r)}\r\n            className=\"w-full text-left border border-gray-200 rounded-xl px-3 py-2 hover:border-blue-300 hover:bg-blue-50 transition-colors\"\r\n          >\r\n            <div className=\"flex justify-between items-center\">\r\n              <div>\r\n                <p className=\"text-sm font-semibold text-gray-900\">\r\n                  {r.transaction_number || \"Txn\"}\r\n                </p>\r\n                <p className=\"text-xs text-gray-600\">\r\n                  {new Date(r.updated_at || r.created_at).toLocaleString()}\r\n                </p>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <p className=\"text-sm font-bold text-blue-700\">\r\n                  ₱{Number(r.total_amount || r.total || 0).toFixed(2)}\r\n                </p>\r\n                <p className=\"text-[11px] text-gray-600 uppercase\">\r\n                  {r.payment?.method || r.payment_type || 'cash'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            {(r.discount_percentage || r.discount_amount) && (\r\n              <p className=\"text-[11px] text-emerald-700 mt-1\">\r\n                Discount applied{\" \"}\r\n                {r.discount_percentage\r\n                  ? `${r.discount_percentage}%`\r\n                  : `₱${Number(r.discount_amount || 0).toFixed(2)}`}\r\n              </p>\r\n            )}\r\n          </button>\r\n        ))}\r\n      </div>\r\n    </BaseModal>\r\n  );\r\n}\r\n\r\nexport default RecentReceiptsModal;\r\n\r\n\r\n\r\n","import React, { useState, useRef, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport ScannerCard from \"../components/ui/POS/ScannerCard\";\r\nimport SkuFormCard from \"../components/ui/POS/SkuFormCard\";\r\nimport CartTableCard from \"../components/ui/POS/CartTableCard\";\r\nimport Button from \"../components/common/Button\";\r\nimport { api, createGcashCheckout, createMayaCheckout } from \"../lib/api\";\r\nimport PriceCheckModal from \"../components/modals/PriceCheckModal\";\r\nimport DiscountModal from \"../components/modals/DiscountModal\";\r\nimport CashLedgerModal from \"../components/modals/CashLedgerModal\";\r\nimport CheckoutModal from \"../components/modals/CheckoutModal\";\r\nimport CashPaymentModal from \"../components/modals/CashPaymentModal\";\r\nimport ScanCustomerCartModal from \"../components/modals/ScanCustomerCartModal\";\r\nimport ProfileModal from \"../components/modals/ProfileModal\";\r\nimport RecentReceiptsModal from \"../components/modals/RecentReceiptsModal\";\r\nimport { BiReceipt, BiUser } from \"react-icons/bi\";\r\n\r\nfunction CashierPOS() {\r\n  const navigate = useNavigate();\r\n\r\n  const [sku, setSku] = useState(\"\");\r\n  const [priceCheckSku, setPriceCheckSku] = useState(\"\");\r\n  const [quantity, setQuantity] = useState(1);\r\n  const [cart, setCart] = useState([]);\r\n  const [appliedDiscount, setAppliedDiscount] = useState(null);\r\n  const [showDiscount, setShowDiscount] = useState(false);\r\n  const [showPriceCheck, setShowPriceCheck] = useState(false);\r\n  const [showImportCart, setShowImportCart] = useState(false);\r\n  const [showCashLedger, setShowCashLedger] = useState(false);\r\n  const [showCheckout, setShowCheckout] = useState(false);\r\n  const [selectedPayment, setSelectedPayment] = useState(null);\r\n  const [showCashModal, setShowCashModal] = useState(false);\r\n  const [darkMode, setDarkMode] = useState(false);\r\n  const [scannerPaused, setScannerPaused] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);\r\n  const [transactionNumber, setTransactionNumber] = useState(\"\");\r\n  const [transactionId, setTransactionId] = useState(null);\r\n  const [showReceipts, setShowReceipts] = useState(false);\r\n  const [showProfileModal, setShowProfileModal] = useState(false);\r\n  const notificationRef = useRef(null);\r\n  const [isMobileNavOpen, setIsMobileNavOpen] = useState(false);\r\n  const touchStartXRef = useRef(null);\r\n  const touchActiveRef = useRef(false);\r\n  const [selectedCartIdx, setSelectedCartIdx] = useState(0);\r\n  const skuInputRef = useRef(null);\r\n  const quantityInputRef = useRef(null);\r\n\r\n  const token = sessionStorage.getItem(\"auth_token\");\r\n  const user = JSON.parse(sessionStorage.getItem(\"user\") || \"{}\");\r\n  const hasFinalizedRef = React.useRef(false);\r\n\r\n  useEffect(() => {\r\n    const keyDownHandler = (e) => {\r\n      if (e.repeat) return;\r\n      switch (e.key) {\r\n        case \"F4\":\r\n          e.preventDefault();\r\n          setShowCashLedger(true);\r\n          break;\r\n        case \"F5\":\r\n          e.preventDefault();\r\n          setShowDiscount(true);\r\n          break;\r\n        case \"F6\":\r\n          e.preventDefault();\r\n          setShowPriceCheck(true);\r\n          break;\r\n        case \"F7\":\r\n          e.preventDefault();\r\n          setShowImportCart(true);\r\n          break;\r\n        case \"F8\":\r\n          e.preventDefault();\r\n          if (cart.length > 0) {\r\n            setShowCheckout(true);\r\n          }\r\n          break;\r\n        case \"Delete\":\r\n          e.preventDefault();\r\n          setCart((prev) => {\r\n            if (prev.length === 0) return prev;\r\n            const next = [...prev];\r\n            next.splice(selectedCartIdx ?? 0, 1);\r\n            return next;\r\n          });\r\n          setSelectedCartIdx((idx) => Math.max(0, idx - 1));\r\n          break;\r\n        case \"ArrowDown\":\r\n          if (cart.length > 0) {\r\n            e.preventDefault();\r\n            setSelectedCartIdx((idx) =>\r\n              Math.min(cart.length - 1, (idx ?? 0) + 1)\r\n            );\r\n          }\r\n          break;\r\n        case \"ArrowUp\":\r\n          if (cart.length > 0) {\r\n            e.preventDefault();\r\n            setSelectedCartIdx((idx) => Math.max(0, (idx ?? 0) - 1));\r\n          }\r\n          break;\r\n        case \"Enter\":\r\n          if (e.ctrlKey || e.metaKey) {\r\n            e.preventDefault();\r\n            setShowCheckout(true);\r\n          }\r\n          break;\r\n        case \"d\":\r\n        case \"D\":\r\n          if (e.altKey) {\r\n            e.preventDefault();\r\n            setShowDiscount(true);\r\n          }\r\n          break;\r\n        case \"l\":\r\n        case \"L\":\r\n          if (e.altKey) {\r\n            e.preventDefault();\r\n            setShowCashLedger(true);\r\n          }\r\n          break;\r\n        case \"p\":\r\n        case \"P\":\r\n          if (e.altKey) {\r\n            e.preventDefault();\r\n            setShowPriceCheck(true);\r\n          }\r\n          break;\r\n        case \"r\":\r\n        case \"R\":\r\n          if (e.altKey) {\r\n            e.preventDefault();\r\n            setShowReceipts(true);\r\n          }\r\n          break;\r\n        case \"q\":\r\n        case \"Q\":\r\n          if (e.altKey) {\r\n            e.preventDefault();\r\n            setShowImportCart(true);\r\n          }\r\n          break;\r\n        case \"s\":\r\n        case \"S\":\r\n          if (e.ctrlKey && e.shiftKey) {\r\n            e.preventDefault();\r\n            skuInputRef.current?.focus();\r\n          }\r\n          break;\r\n        case \"k\":\r\n        case \"K\":\r\n          if (e.ctrlKey && e.shiftKey) {\r\n            e.preventDefault();\r\n            quantityInputRef.current?.focus();\r\n          }\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    };\r\n    window.addEventListener(\"keydown\", keyDownHandler);\r\n    return () => window.removeEventListener(\"keydown\", keyDownHandler);\r\n  }, [cart.length, selectedCartIdx]);\r\n\r\n  // Generate a client-side provisional transaction number when POS opens\r\n  useEffect(() => {\r\n    if (!transactionNumber) {\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(\r\n        `T-${businessId.toString().padStart(2, \"0\")}-${timePart}-${randPart}`\r\n      );\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n  useEffect(() => {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const status = params.get(\"payment\");\r\n    \r\n    // Check if we're in a new tab (opened from payment)\r\n    const isNewTab = window.opener && !window.opener.closed;\r\n\r\n    const finalizeOnlinePayment = async (pendingCartKey, paymentType) => {\r\n      const pending = localStorage.getItem(pendingCartKey);\r\n      if (status === \"success\" && pending) {\r\n        try {\r\n          const parsed = JSON.parse(pending);\r\n          // finalize checkout using saved items\r\n          (async () => {\r\n            if (hasFinalizedRef.current) return;\r\n            const guardKey = `${paymentType.toLowerCase()}_finalize_done`;\r\n            if (sessionStorage.getItem(guardKey) === \"1\") return;\r\n            hasFinalizedRef.current = true;\r\n            sessionStorage.setItem(guardKey, \"1\");\r\n            try {\r\n              setError(\"\");\r\n              const body = {\r\n                items: parsed.items || [],\r\n                payment_type: paymentType.toLowerCase(),\r\n                money_received: parsed.total || null,\r\n                transaction_id: parsed.transactionId || null,\r\n                transaction_number: parsed.transactionNumber || null,\r\n              };\r\n              const resp = await api(\"/api/sales/checkout\", {\r\n                method: \"POST\",\r\n                headers: { Authorization: `Bearer ${token}` },\r\n                body: JSON.stringify(body),\r\n              });\r\n              if (resp?.transaction_number)\r\n                setTransactionNumber(resp.transaction_number);\r\n              if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n              setCart([]);\r\n              try {\r\n                const url = new URL(window.location.origin + \"/receipt\");\r\n                if (resp?.transaction_number)\r\n                  url.searchParams.set(\"tn\", resp.transaction_number);\r\n                if (resp?.transaction_id)\r\n                  url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n                if (resp?.total != null)\r\n                  url.searchParams.set(\"total\", String(resp.total));\r\n                \r\n                // If in new tab, redirect opener and close this tab\r\n                if (isNewTab && window.opener) {\r\n                  window.opener.location.href = url.toString();\r\n                  window.close();\r\n                } else {\r\n                  navigate(url.pathname + url.search);\r\n                }\r\n              } catch (_) {}\r\n            } catch (e) {\r\n              setError(`Failed to record ${paymentType} payment`);\r\n            } finally {\r\n              localStorage.removeItem(pendingCartKey);\r\n              if (!isNewTab) {\r\n                // remove query param\r\n                const url = new URL(window.location.href);\r\n                url.searchParams.delete(\"payment\");\r\n                window.history.replaceState({}, \"\", url.toString());\r\n              }\r\n            }\r\n          })();\r\n        } catch (_) {\r\n          localStorage.removeItem(pendingCartKey);\r\n        }\r\n      } else if (status === \"cancel\" && pending) {\r\n        localStorage.removeItem(pendingCartKey);\r\n        // If in new tab, close it; otherwise just clean up URL\r\n        if (isNewTab && window.opener) {\r\n          window.close();\r\n        } else {\r\n          const url = new URL(window.location.href);\r\n          url.searchParams.delete(\"payment\");\r\n          window.history.replaceState({}, \"\", url.toString());\r\n        }\r\n      }\r\n    };\r\n\r\n    finalizeOnlinePayment(\"pending_gcash_cart\", \"GCash\");\r\n    finalizeOnlinePayment(\"pending_maya_cart\", \"Maya\");\r\n  }, []);\r\n\r\n  const addSkuToCart = async (skuValue, qty = 1) => {\r\n    if (!skuValue || qty < 1) return;\r\n    setError(\"\");\r\n    try {\r\n      const businessId = user?.businessId || user?.business_id || null;\r\n      const url = businessId\r\n        ? `/api/products/sku/${encodeURIComponent(\r\n            skuValue\r\n          )}?business_id=${businessId}`\r\n        : `/api/products/sku/${encodeURIComponent(skuValue)}`;\r\n\r\n      const product = await api(url, {\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      });\r\n      const price = Number(product.selling_price || 0);\r\n      const stockQty = Number(product.stock_quantity ?? 0);\r\n      if (stockQty <= 0) {\r\n        setError(\r\n          `Stock for ${product.product_name} (SKU ${product.sku}) is 0.`\r\n        );\r\n        return;\r\n      }\r\n      if (qty > stockQty) {\r\n        setError(\r\n          `Insufficient stock. Available: ${stockQty}, requested: ${qty}.`\r\n        );\r\n        return;\r\n      }\r\n      setCart((prev) => {\r\n        const existingIdx = prev.findIndex(\r\n          (i) => i.product_id === product.product_id\r\n        );\r\n        if (existingIdx >= 0) {\r\n          const next = [...prev];\r\n          const newQty = next[existingIdx].quantity + qty;\r\n          if (newQty > stockQty) {\r\n            setError(\r\n              `Insufficient stock. Available: ${stockQty}, requested: ${newQty}.`\r\n            );\r\n            return prev;\r\n          }\r\n          next[existingIdx] = { ...next[existingIdx], quantity: newQty };\r\n          return next;\r\n        }\r\n        return [\r\n          ...prev,\r\n          {\r\n            product_id: product.product_id,\r\n            sku: product.sku,\r\n            name: product.product_name,\r\n            quantity: qty,\r\n            price,\r\n          },\r\n        ];\r\n      });\r\n      setSku(\"\");\r\n      setQuantity(1);\r\n      setScannerPaused(false);\r\n    } catch (err) {\r\n      setError(\"Product not found\");\r\n    }\r\n  };\r\n\r\n  const handleAddToCart = async () => {\r\n    await addSkuToCart(sku, quantity);\r\n  };\r\n\r\n  const handleRemove = (idx) => setCart(cart.filter((_, i) => i !== idx));\r\n  const handleEditQuantity = (idx, qty) => {\r\n    setCart((prev) =>\r\n      prev.map((item, i) =>\r\n        i === idx ? { ...item, quantity: Math.max(1, qty) } : item\r\n      )\r\n    );\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (cart.length === 0) {\r\n      setSelectedCartIdx(0);\r\n    } else {\r\n      setSelectedCartIdx((idx) => Math.min(idx ?? 0, cart.length - 1));\r\n    }\r\n  }, [cart.length]);\r\n\r\n  const subtotal = cart.reduce(\r\n    (sum, item) => sum + item.price * item.quantity,\r\n    0\r\n  );\r\n  const total =\r\n    appliedDiscount?.type === \"percentage\"\r\n      ? Math.max(\r\n          0,\r\n          subtotal - subtotal * (Number(appliedDiscount.value || 0) / 100)\r\n        )\r\n      : appliedDiscount?.type === \"amount\"\r\n      ? Math.max(0, subtotal - Number(appliedDiscount.value || 0))\r\n      : subtotal;\r\n\r\n  const completeTransactionCall = async (transId) => {\r\n    if (!transId) return;\r\n    try {\r\n      const resp = await api(`/api/sales/${transId}/complete`, {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      });\r\n      return resp;\r\n    } catch (err) {\r\n      console.error(\"Failed to complete transaction:\", err);\r\n      setError(\"Failed to complete transaction\");\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const handleCheckout = async (\r\n    paymentType = \"cash\",\r\n    moneyReceived = total\r\n  ) => {\r\n    if (cart.length === 0) return;\r\n    setError(\"\");\r\n    try {\r\n      const body = {\r\n        transaction_id: transactionId || null,\r\n        transaction_number: transactionNumber || null,\r\n        items: cart.map((i) => ({\r\n          product_id: i.product_id,\r\n          quantity: i.quantity,\r\n        })),\r\n        payment_type: paymentType,\r\n        money_received: moneyReceived,\r\n        ...(appliedDiscount?.discount_id\r\n          ? { discount_id: appliedDiscount.discount_id }\r\n          : appliedDiscount?.type === \"percentage\"\r\n          ? { discount_percentage: Number(appliedDiscount.value) }\r\n          : appliedDiscount?.type === \"amount\"\r\n          ? { discount_amount: Number(appliedDiscount.value) }\r\n          : {}),\r\n      };\r\n      const resp = await api(\"/api/sales/checkout\", {\r\n        method: \"POST\",\r\n        headers: { Authorization: `Bearer ${token}` },\r\n        body: JSON.stringify(body),\r\n      });\r\n      if (resp?.transaction_number)\r\n        setTransactionNumber(resp.transaction_number);\r\n      if (resp?.transaction_id) setTransactionId(resp.transaction_id);\r\n\r\n      // Removed redundant call to completeTransaction endpoint as checkout already sets status and cashier_user_id\r\n      // if (resp?.transaction_id) {\r\n      //   await completeTransactionCall(resp.transaction_id);\r\n      // }\r\n\r\n      setCart([]);\r\n      try {\r\n        const url = new URL(window.location.origin + \"/receipt\");\r\n        if (resp?.transaction_number)\r\n          url.searchParams.set(\"tn\", resp.transaction_number);\r\n        if (resp?.transaction_id)\r\n          url.searchParams.set(\"tid\", String(resp.transaction_id));\r\n        if (resp?.total != null)\r\n          url.searchParams.set(\"total\", String(resp.total));\r\n        navigate(url.pathname + url.search);\r\n      } catch (_) {}\r\n      // Start a fresh provisional transaction number after successful checkout\r\n      const businessId = user?.businessId || user?.business_id || \"BIZ\";\r\n      const timePart = new Date()\r\n        .toISOString()\r\n        .replace(/[-:T.Z]/g, \"\")\r\n        .slice(0, 14);\r\n      const randPart = Math.floor(1000 + Math.random() * 9000);\r\n      setTransactionNumber(\r\n        `T-${businessId.toString().padStart(2, \"0\")}-${timePart}-${randPart}`\r\n      );\r\n      setAppliedDiscount(null);\r\n      setTransactionId(null);\r\n    } catch (err) {\r\n      setError(\"Checkout failed\");\r\n    }\r\n  };\r\n\r\n  const handleCopyTn = () => {\r\n    navigator.clipboard.writeText(user.store_name);\r\n  };\r\n\r\n  // show confirmation modal first, perform actual logout in confirmLogout\r\n  const handleLogout = () => {\r\n    setShowLogoutConfirm(true);\r\n  };\r\n\r\n  const confirmLogout = () => {\r\n    sessionStorage.removeItem(\"auth_token\");\r\n    sessionStorage.removeItem(\"user\");\r\n    // close modal then navigate home\r\n    setShowLogoutConfirm(false);\r\n    navigate(\"/\");\r\n  };\r\n\r\n  const handleCloseLogoutModal = () => {\r\n    setShowLogoutConfirm(false);\r\n  };\r\n\r\n  const headerActions = (\r\n    <div className=\"flex items-center gap-2\">\r\n      <button\r\n        onClick={() => setShowReceipts(true)}\r\n        className=\"p-2 rounded-lg hover:bg-gray-100 transition-colors\"\r\n        title=\"Recent Receipts (Alt+R)\"\r\n      >\r\n        <BiReceipt className=\"w-5 h-5 text-gray-600\" />\r\n      </button>\r\n      <button\r\n        onClick={() => setShowProfileModal(true)}\r\n        className=\"p-2 rounded-lg hover:bg-gray-100 transition-colors\"\r\n        title=\"Profile\"\r\n      >\r\n        <BiUser className=\"w-5 h-5 text-gray-600\" />\r\n      </button>\r\n      <button\r\n        onClick={handleLogout}\r\n        className=\"p-2 rounded-lg hover:bg-red-50 transition-colors\"\r\n        title=\"Logout\"\r\n      >\r\n        <svg\r\n          className=\"w-5 h-5 text-red-600\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          viewBox=\"0 0 24 24\"\r\n        >\r\n          <path\r\n            strokeLinecap=\"round\"\r\n            strokeLinejoin=\"round\"\r\n            strokeWidth={2}\r\n            d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1\"\r\n          />\r\n        </svg>\r\n      </button>\r\n    </div>\r\n  );\r\n\r\n  const cardClass = \"bg-white border border-blue-100 rounded-2xl p-6 shadow-lg\";\r\n\r\n  return (\r\n    <div className=\"bg-white min-h-screen\">\r\n      {/* Main Content */}\r\n      <div className=\"flex-1 flex flex-col min-h-screen\">\r\n        {/* Header */}\r\n        <header className=\"flex items-center gap-2 px-4 sm:px-6 py-3 bg-white/90 backdrop-blur-md shadow-md border-b border-gray-200/50 h-[64px] min-h-[64px] max-h-[64px] sticky top-0 z-30\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <span className=\"text-xl sm:text-2xl font-bold text-gray-900 tracking-tight\">\r\n              POS\r\n            </span>\r\n            <span className=\"text-xs sm:text-sm font-semibold text-blue-700 bg-blue-50 border border-blue-200 px-2 py-1 rounded-lg\">\r\n              Cashier ID: {user?.userId || user?.user_id || user?.id || \"N/A\"}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex-1 flex items-center justify-center px-2\">\r\n            <button\r\n              onClick={handleCopyTn}\r\n              title=\"Copy store name\"\r\n              className=\"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2.5 py-1.5 shadow-sm hover:bg-blue-100 transition-colors\"\r\n            >\r\n              <svg\r\n                className=\"w-4 h-4\"\r\n                fill=\"none\"\r\n                stroke=\"currentColor\"\r\n                viewBox=\"0 0 24 24\"\r\n              >\r\n                <path\r\n                  strokeLinecap=\"round\"\r\n                  strokeLinejoin=\"round\"\r\n                  strokeWidth={2}\r\n                  d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2\"\r\n                />\r\n              </svg>\r\n              <span className=\"font-mono text-xs sm:text-sm md:text-base font-bold tracking-wider truncate max-w-[50vw]\">\r\n                {user.store_name}\r\n              </span>\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"ml-auto\">{headerActions}</div>\r\n        </header>\r\n\r\n        {/* Main Area */}\r\n        <main className=\"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-y-auto p-2 sm:p-3 md:p-4 pb-55 lg:pb-4\">\r\n          <div className=\"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12\">\r\n            {/* Left Column - Scanner, SKU Form, Transaction */}\r\n            <div className=\"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4\">\r\n              {/* ScannerCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <ScannerCard\r\n                  onScan={async (result) => {\r\n                    const code = result?.[0]?.rawValue;\r\n                    if (!code) return;\r\n                    setScannerPaused(true);\r\n                    if (showPriceCheck) {\r\n                      setPriceCheckSku(code);\r\n                    } else {\r\n                      try {\r\n                        let scannedData;\r\n                        try {\r\n                          scannedData = JSON.parse(code);\r\n                        } catch (e) {\r\n                          scannedData = null;\r\n                        }\r\n                        if (\r\n                          scannedData &&\r\n                          scannedData.t === \"cart\" &&\r\n                          Array.isArray(scannedData.items)\r\n                        ) {\r\n                          // set transactionId from scanned data if present\r\n                          if (scannedData.transaction_id) {\r\n                            setTransactionId(scannedData.transaction_id);\r\n                          }\r\n                          // set transaction_number from scanned data if present\r\n                          if (scannedData.transaction_number) {\r\n                            setTransactionNumber(\r\n                              scannedData.transaction_number\r\n                            );\r\n                          }\r\n                          const items = scannedData.items.map((it) => ({\r\n                            product_id: it.p,\r\n                            quantity: it.q,\r\n                            sku: it.sku || \"\",\r\n                          }));\r\n                          try {\r\n                            const fetchedProducts = await Promise.all(\r\n                              items.map(async (item) => {\r\n                                const res = await api(\r\n                                  `/api/products/${item.product_id}`,\r\n                                  {\r\n                                    headers: {\r\n                                      Authorization: `Bearer ${token}`,\r\n                                    },\r\n                                  }\r\n                                );\r\n                                return {\r\n                                  product_id: item.product_id,\r\n                                  sku: res.sku || item.sku || \"\",\r\n                                  name: res.product_name || \"\",\r\n                                  price: Number(res.selling_price) || 0,\r\n                                  quantity: item.quantity,\r\n                                };\r\n                              })\r\n                            );\r\n                            setCart((prev) => {\r\n                              const byProductId = new Map(\r\n                                prev.map((i) => [i.product_id, i])\r\n                              );\r\n                              for (const it of fetchedProducts) {\r\n                                const existing = byProductId.get(it.product_id);\r\n                                if (existing) {\r\n                                  existing.quantity += it.quantity;\r\n                                } else {\r\n                                  byProductId.set(it.product_id, { ...it });\r\n                                }\r\n                              }\r\n                              return Array.from(byProductId.values());\r\n                            });\r\n                            return;\r\n                          } catch (err) {\r\n                            console.error(\r\n                              \"Error fetching product details for scanned cart:\",\r\n                              err\r\n                            );\r\n                            // fallback to merging raw scanned items without product details\r\n                            setCart((prev) => {\r\n                              const byProductId = new Map(\r\n                                prev.map((i) => [i.product_id, i])\r\n                              );\r\n                              for (const it of items) {\r\n                                const existing = byProductId.get(it.product_id);\r\n                                if (existing) {\r\n                                  existing.quantity += it.quantity;\r\n                                } else {\r\n                                  byProductId.set(it.product_id, {\r\n                                    ...it,\r\n                                    name: \"\",\r\n                                    price: 0,\r\n                                  });\r\n                                }\r\n                              }\r\n                              return Array.from(byProductId.values());\r\n                            });\r\n                            return;\r\n                          }\r\n                        }\r\n                        await addSkuToCart(code, 1);\r\n                      } catch (err) {\r\n                        console.error(\"Error processing scanned code:\", err);\r\n                        await addSkuToCart(code, 1);\r\n                      }\r\n                    }\r\n                  }}\r\n                  paused={scannerPaused}\r\n                  onResume={() => setScannerPaused(false)}\r\n                  textMain=\"text-blue-700\"\r\n                />\r\n              </div>\r\n\r\n              {/* SkuFormCard */}\r\n              <div className=\"flex-shrink-0\">\r\n                <SkuFormCard\r\n                  ref={skuInputRef}\r\n                  sku={sku}\r\n                  setSku={setSku}\r\n                  quantity={quantity}\r\n                  setQuantity={setQuantity}\r\n                  handleAddToCart={handleAddToCart}\r\n                  quantityInputRef={quantityInputRef}\r\n                />\r\n                {error && (\r\n                  <div className=\"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3\">\r\n                    <svg\r\n                      className=\"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5\"\r\n                      fill=\"none\"\r\n                      stroke=\"currentColor\"\r\n                      viewBox=\"0 0 24 24\"\r\n                    >\r\n                      <path\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        strokeWidth={2}\r\n                        d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\"\r\n                      />\r\n                    </svg>\r\n                    <p className=\"text-sm font-medium text-red-700\">\r\n                      {(() => {\r\n                        try {\r\n                          const parsed = JSON.parse(error);\r\n                          return parsed.error || parsed.message || error;\r\n                        } catch {\r\n                          return error;\r\n                        }\r\n                      })()}\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Right Column - Cart and Actions */}\r\n            <div className=\"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0\">\r\n              {/* CartTableCard */}\r\n              <div className=\"flex-1 overflow-auto\">\r\n                <CartTableCard\r\n                  cart={cart}\r\n                  handleRemove={handleRemove}\r\n                  handleEditQuantity={handleEditQuantity}\r\n                  total={total}\r\n                  subtotal={subtotal}\r\n                  appliedDiscount={appliedDiscount}\r\n                  selectedIdx={selectedCartIdx}\r\n                  onSelectRow={setSelectedCartIdx}\r\n                  className=\"flex-1 h-full\"\r\n                />\r\n              </div>\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0\">\r\n                {appliedDiscount && (\r\n                  <div className=\"col-span-12 flex items-center justify-between bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg px-3 py-2\">\r\n                    <span className=\"text-sm font-semibold\">\r\n                      Discount applied: {appliedDiscount.label}\r\n                    </span>\r\n                    <button\r\n                      className=\"text-xs font-bold underline\"\r\n                      onClick={() => setAppliedDiscount(null)}\r\n                    >\r\n                      Remove\r\n                    </button>\r\n                  </div>\r\n                )}\r\n                {/* Grouped Buttons */}\r\n                <div className=\"col-span-8\">\r\n                  <div className=\"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3\">\r\n                    <Button\r\n                      label=\"CASH LEDGER (F4)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      onClick={() => setShowCashLedger(true)}\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"DISCOUNT (F5)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowDiscount(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"PRICE CHECK (F6)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowPriceCheck(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                    <Button\r\n                      label=\"SCAN CUSTOMER QR (F7)\"\r\n                      size=\"md\"\r\n                      className=\"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold\"\r\n                      onClick={() => setShowImportCart(true)}\r\n                      variant=\"secondary\"\r\n                      microinteraction\r\n                      icon={\r\n                        <svg\r\n                          className=\"w-4 h-4\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          viewBox=\"0 0 24 24\"\r\n                        >\r\n                          <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2}\r\n                            d=\"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12\"\r\n                          />\r\n                        </svg>\r\n                      }\r\n                      iconPosition=\"left\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Checkout Button */}\r\n                <div className=\"col-span-4\">\r\n                  <Button\r\n                    label=\"CHECKOUT (F8)\"\r\n                    size=\"md\"\r\n                    className=\"w-full h-full text-sm sm:text-base font-bold\"\r\n                    variant=\"primary\"\r\n                    microinteraction\r\n                    onClick={() => setShowCheckout(true)}\r\n                    disabled={cart.length === 0}\r\n                    icon={\r\n                      <svg\r\n                        className=\"w-5 h-5\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        viewBox=\"0 0 24 24\"\r\n                      >\r\n                        <path\r\n                          strokeLinecap=\"round\"\r\n                          strokeLinejoin=\"round\"\r\n                          strokeWidth={2}\r\n                          d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"\r\n                        />\r\n                      </svg>\r\n                    }\r\n                    iconPosition=\"left\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-3 bg-white/80 border border-gray-200 rounded-xl shadow-sm px-3 py-2 text-[11px] sm:text-xs text-gray-700 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sticky bottom-0\">\r\n            <span className=\"font-semibold text-blue-700\">Keyboard Shortcuts</span>\r\n            <span>Ctrl+Shift+S: Focus SKU</span>\r\n            <span>Ctrl+Shift+K: Focus Qty</span>\r\n            <span>Alt+D: Discount</span>\r\n            <span>Alt+P: Price Check</span>\r\n            <span>Alt+L: Cash Ledger</span>\r\n            <span>Alt+Q: Scan Customer QR</span>\r\n            <span>Alt+R: Recent Receipts</span>\r\n            <span>Ctrl+Enter: Checkout</span>\r\n            <span>Delete: Remove selected item</span>\r\n            <span>Arrow Up/Down: Move selection</span>\r\n          </div>\r\n        </main>\r\n\r\n        {/* Modals */}\r\n        {showLogoutConfirm && (\r\n          <div className=\"fixed inset-0 z-90 flex items-center justify-center\">\r\n            <div\r\n              className=\"absolute inset-0 bg-black/80 z-90\"\r\n              onClick={handleCloseLogoutModal}\r\n            />\r\n            <div className=\"relative bg-white rounded-xl shadow-xl w-[92%] max-w-md z-100 p-0\">\r\n              {/* Header Section */}\r\n              <div className=\"bg-gradient-to-r from-red-50 via-red-50/80 to-orange-50/50 border-b border-red-100 px-6 py-5 rounded-t-2xl\">\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg\">\r\n                    <svg\r\n                      className=\"w-6 h-6 text-white\"\r\n                      fill=\"none\"\r\n                      stroke=\"white\"\r\n                      viewBox=\"0 0 24 24\"\r\n                    >\r\n                      <path\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\"\r\n                      />\r\n                    </svg>\r\n                  </div>\r\n                  <div className=\"flex-1\">\r\n                    <h2 className=\"text-xl font-bold text-gray-900 mb-1\">\r\n                      Confirm Logout\r\n                    </h2>\r\n                    <p className=\"text-sm text-gray-600\">\r\n                      Are you sure you want to log out?\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Content Section */}\r\n              <div className=\"p-6\">\r\n                <p className=\"text-sm text-gray-700 mb-6\">\r\n                  You will be redirected to the login page and your session will\r\n                  end.\r\n                </p>\r\n\r\n                {/* Action Buttons */}\r\n                <div className=\"flex justify-end gap-3\">\r\n                  <button\r\n                    onClick={handleCloseLogoutModal}\r\n                    className=\"px-5 py-2.5 rounded-lg text-sm font-semibold text-gray-700 bg-white border-2 border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200\"\r\n                  >\r\n                    Cancel\r\n                  </button>\r\n                  <button\r\n                    onClick={confirmLogout}\r\n                    className=\"px-5 py-2.5 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2\"\r\n                  >\r\n                    <svg\r\n                      className=\"w-5 h-5\"\r\n                      fill=\"none\"\r\n                      stroke=\"currentColor\"\r\n                      viewBox=\"0 0 24 24\"\r\n                    >\r\n                      <path\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                        d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\"\r\n                      />\r\n                    </svg>\r\n                    Logout\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n        <DiscountModal\r\n          isOpen={showDiscount}\r\n          onClose={() => setShowDiscount(false)}\r\n          onApplyDiscount={(discount) => {\r\n            setAppliedDiscount(discount);\r\n            setShowDiscount(false);\r\n          }}\r\n        />\r\n        <PriceCheckModal\r\n          isOpen={showPriceCheck}\r\n          onClose={() => setShowPriceCheck(false)}\r\n          sku={priceCheckSku}\r\n          setSku={setPriceCheckSku}\r\n        />\r\n        <CashLedgerModal\r\n          isOpen={showCashLedger}\r\n          onClose={() => setShowCashLedger(false)}\r\n        />\r\n        <CheckoutModal\r\n          isOpen={showCheckout}\r\n          onClose={() => setShowCheckout(false)}\r\n          total={total}\r\n          onSelectPayment={(method) => {\r\n            setSelectedPayment(method);\r\n            setShowCheckout(false);\r\n            if (method === \"cash\") {\r\n              setShowCashModal(true);\r\n            } else {\r\n              if (method === \"gcash\") {\r\n                (async () => {\r\n                  try {\r\n                    const successUrl =\r\n                      window.location.origin + \"/pos?payment=success\";\r\n                    const cancelUrl =\r\n                      window.location.origin + \"/pos?payment=cancel\";\r\n                    // persist cart to finalize after redirect back\r\n                    localStorage.setItem(\r\n                      \"pending_gcash_cart\",\r\n                      JSON.stringify({\r\n                        items: cart.map((i) => ({\r\n                          product_id: i.product_id,\r\n                          quantity: i.quantity,\r\n                        })),\r\n                        total,\r\n                        transactionId: transactionId,\r\n                        transactionNumber: transactionNumber,\r\n                      })\r\n                    );\r\n                    const { checkoutUrl } = await createGcashCheckout({\r\n                      amount: Number(total || 0),\r\n                      description: \"POS Order\",\r\n                      referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                      cancelUrl,\r\n                      successUrl,\r\n                    });\r\n                    window.open(checkoutUrl, '_blank');\r\n                  } catch (e) {\r\n                    setError(\"Failed to init GCash\");\r\n                    localStorage.removeItem(\"pending_gcash_cart\");\r\n                  }\r\n                })();\r\n              } else if (method === \"maya\") {\r\n                (async () => {\r\n                  try {\r\n                    const successUrl =\r\n                      window.location.origin + \"/pos?payment=success\";\r\n                    const cancelUrl =\r\n                      window.location.origin + \"/pos?payment=cancel\";\r\n                    // persist cart to finalize after redirect back\r\n                    localStorage.setItem(\r\n                      \"pending_maya_cart\",\r\n                      JSON.stringify({\r\n                        items: cart.map((i) => ({\r\n                          product_id: i.product_id,\r\n                          quantity: i.quantity,\r\n                        })),\r\n                        total,\r\n                        transactionId: transactionId,\r\n                        transactionNumber: transactionNumber,\r\n                      })\r\n                    );\r\n                    const { checkoutUrl } = await createMayaCheckout({\r\n                      amount: Number(total || 0),\r\n                      description: \"POS Order\",\r\n                      referenceNumber: transactionNumber || `POS-${Date.now()}`,\r\n                      cancelUrl,\r\n                      successUrl,\r\n                    });\r\n                    window.open(checkoutUrl, '_blank');\r\n                  } catch (e) {\r\n                    setError(\"Failed to init Maya\");\r\n                    localStorage.removeItem(\"pending_maya_cart\");\r\n                  }\r\n                })();\r\n              } else {\r\n                // For other payment methods, fall back to existing checkout flow\r\n                handleCheckout(method);\r\n              }\r\n            }\r\n          }}\r\n        />\r\n        <CashPaymentModal\r\n          isOpen={showCashModal}\r\n          onClose={() => setShowCashModal(false)}\r\n          total={total}\r\n          onConfirm={(amountReceived) => {\r\n            handleCheckout(\"cash\", amountReceived);\r\n            setShowCashModal(false);\r\n          }}\r\n        />\r\n        <ScanCustomerCartModal\r\n          isOpen={showImportCart}\r\n          onClose={() => setShowImportCart(false)}\r\n          onImport={async (items, transactionId, completionResponse) => {\r\n            try {\r\n              // If transaction was completed (completionResponse exists), navigate to receipt\r\n              if (completionResponse && transactionId) {\r\n                setCart([]);\r\n                setTransactionId(null);\r\n                setTransactionNumber(null);\r\n                setError(\"\");\r\n                setShowImportCart(false);\r\n                // Navigate to receipt page for cashier\r\n                window.location.href = `/receipt?tn=${completionResponse.transaction_number || transactionId}`;\r\n                return;\r\n              }\r\n              \r\n              // Otherwise, import items (backward compatibility for old QR format)\r\n              if (!items || items.length === 0) {\r\n                setError(\"No items found in QR code\");\r\n                return;\r\n              }\r\n              \r\n              console.log(\"Scanned items:\", items);\r\n              // Fetch product details by product_id for all scanned items concurrently\r\n              const fetchedProducts = await Promise.all(\r\n                items.map(async (item) => {\r\n                  const res = await api(`/api/products/${item.product_id}`, {\r\n                    headers: { Authorization: `Bearer ${token}` },\r\n                  });\r\n                  console.log(\r\n                    \"Fetched product for id\",\r\n                    item.product_id,\r\n                    \":\",\r\n                    res\r\n                  );\r\n                  return {\r\n                    product_id: item.product_id,\r\n                    sku: res.sku || item.sku || \"\",\r\n                    name: res.product_name || \"\",\r\n                    price: Number(res.selling_price) || 0,\r\n                    quantity: item.quantity,\r\n                  };\r\n                })\r\n              );\r\n              setCart((prev) => {\r\n                const bySku = new Map(prev.map((i) => [i.sku, i]));\r\n                for (const it of fetchedProducts) {\r\n                  const existing = bySku.get(it.sku);\r\n                  if (existing) existing.quantity += it.quantity;\r\n                  else bySku.set(it.sku, { ...it });\r\n                }\r\n                return Array.from(bySku.values());\r\n              });\r\n            } catch (e) {\r\n              console.error(\"Error fetching products for scanned items:\", e);\r\n              // Fallback to use raw items if fetch fails\r\n              setCart((prev) => {\r\n                const bySku = new Map(prev.map((i) => [i.sku, i]));\r\n                for (const it of items) {\r\n                  const existing = bySku.get(it.sku);\r\n                  if (existing) existing.quantity += it.quantity;\r\n                  else bySku.set(it.sku, { ...it });\r\n                }\r\n                return Array.from(bySku.values());\r\n              });\r\n            }\r\n          }}\r\n        />\r\n        <RecentReceiptsModal\r\n          isOpen={showReceipts}\r\n          onClose={() => setShowReceipts(false)}\r\n        />\r\n        <ProfileModal\r\n          isOpen={showProfileModal}\r\n          onClose={() => setShowProfileModal(false)}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default CashierPOS;\r\n"],"names":["RecentReceiptsModal","isOpen","onClose","receipts","setReceipts","useState","loading","setLoading","error","setError","useEffect","async","token","sessionStorage","getItem","data","api","headers","Authorization","Array","isArray","e","fetchReceipts","jsxs","BaseModal","title","subtitle","size","footer","jsx","Button","label","variant","onClick","className","children","length","map","r","receipt","url","URL","window","location","origin","transaction_number","searchParams","set","transaction_id","String","open","toString","openReceipt","Date","updated_at","created_at","toLocaleString","Number","total_amount","total","toFixed","payment","method","payment_type","discount_percentage","discount_amount","CashierPOS","navigate","useNavigate","sku","setSku","priceCheckSku","setPriceCheckSku","quantity","setQuantity","cart","setCart","appliedDiscount","setAppliedDiscount","showDiscount","setShowDiscount","showPriceCheck","setShowPriceCheck","showImportCart","setShowImportCart","showCashLedger","setShowCashLedger","showCheckout","setShowCheckout","selectedPayment","setSelectedPayment","showCashModal","setShowCashModal","darkMode","setDarkMode","scannerPaused","setScannerPaused","showLogoutConfirm","setShowLogoutConfirm","transactionNumber","setTransactionNumber","transactionId","setTransactionId","showReceipts","setShowReceipts","showProfileModal","setShowProfileModal","useRef","isMobileNavOpen","setIsMobileNavOpen","selectedCartIdx","setSelectedCartIdx","skuInputRef","quantityInputRef","user","JSON","parse","hasFinalizedRef","React","keyDownHandler","repeat","key","preventDefault","prev","next","splice","Math","max","idx","min","ctrlKey","metaKey","altKey","shiftKey","current","focus","addEventListener","removeEventListener","businessId","business_id","timePart","toISOString","replace","slice","randPart","floor","random","padStart","status","URLSearchParams","search","get","isNewTab","opener","closed","finalizeOnlinePayment","pendingCartKey","paymentType","pending","localStorage","parsed","guardKey","toLowerCase","setItem","body","items","money_received","resp","stringify","href","close","pathname","_","removeItem","delete","history","replaceState","addSkuToCart","skuValue","qty","encodeURIComponent","product","price","selling_price","stockQty","stock_quantity","product_name","existingIdx","findIndex","i","product_id","newQty","name","err","subtotal","reduce","sum","item","type","value","handleCheckout","moneyReceived","discount_id","handleCloseLogoutModal","headerActions","BiReceipt","BiUser","handleLogout","fill","stroke","viewBox","strokeLinecap","strokeLinejoin","strokeWidth","d","userId","user_id","id","handleCopyTn","clipboard","writeText","store_name","ScannerCard","onScan","result","code","rawValue","scannedData","t","it","p","q","fetchedProducts","Promise","all","res","byProductId","Map","existing","from","values","paused","onResume","textMain","SkuFormCard","ref","handleAddToCart","message","CartTableCard","handleRemove","filter","handleEditQuantity","selectedIdx","onSelectRow","microinteraction","icon","iconPosition","disabled","confirmLogout","DiscountModal","onApplyDiscount","discount","PriceCheckModal","CashLedgerModal","CheckoutModal","onSelectPayment","successUrl","cancelUrl","checkoutUrl","createGcashCheckout","amount","description","referenceNumber","now","createMayaCheckout","CashPaymentModal","onConfirm","amountReceived","ScanCustomerCartModal","onImport","completionResponse","log","console","bySku","ProfileModal"],"mappings":"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"}