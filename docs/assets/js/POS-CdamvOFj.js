import{j as e}from"./utils-BnCj7yKo.js";import{u as t,a as n,R as s}from"./vendor-BZrj58oz.js";import{S as a}from"./ScannerCard-DdUmj5XW.js";import{P as r}from"./PageLayout-D_ZMWTMw.js";import{S as o,C as i,D as c,P as l,a as d,b as u,c as m}from"./CashPaymentModal-vjy6jN3n.js";import{a as p,b as h,d as x,e as f}from"./index-B6EMrwoj.js";import{N as g}from"./Nav-Admin-BJoTBbbB.js";import{Q as y,S as b}from"./QuantityInputModal-Db3kQoSS.js";import{b as v}from"./index-4YedFPzh.js";import{A as w}from"./AdminReceiptsModal-BbYYXYnA.js";import{u as j}from"./useKeyboardShortcuts-C3XQk2oo.js";import"./qr-DN-bNBye.js";import"./Navbar-UJciBic7.js";import"./Logo-CC4Yu1_Q.js";import"./PrivacyPolicyModal-C_BSH6tZ.js";import"./BaseModal-C-8Qp-dk.js";import"./Card-fMjg4IWJ.js";import"./Input-D3kbgyHK.js";const k=({text:t,shortcut:n,variant:s="secondary"})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t}),e.jsx("span",{className:"hidden sm:inline-block text-xs font-bold px-1.5 py-0.5 rounded border "+("primary"===s?"bg-white/20 border-white/40 text-white":"bg-gray-100 border-gray-300 text-gray-600"),children:n})]});function _(){const _=t(),[N,S]=n.useState(""),[C,q]=n.useState(1),[E,L]=n.useState([]),[I,P]=n.useState(!1),[$,M]=n.useState(!1),[A,O]=n.useState(""),[T,D]=n.useState(!1),[R,U]=n.useState(!1),[B,z]=n.useState(!1),[F,W]=n.useState(!1),[V,H]=n.useState(null),[J,Q]=n.useState(!1),[K,Z]=n.useState(!1),[G,X]=n.useState(""),[Y,ee]=n.useState(""),[te,ne]=n.useState(null);n.useEffect(()=>{if(G){const e=setTimeout(()=>{X("")},5e3);return()=>clearTimeout(e)}},[G]);const[se,ae]=n.useState(!1),re=n.useRef(null),[oe,ie]=n.useState(!1),[ce,le]=n.useState(-1),[de,ue]=n.useState(null),me=sessionStorage.getItem("auth_token"),pe=JSON.parse(sessionStorage.getItem("user")||"{}"),he=s.useRef(!1),[xe,fe]=n.useState(""),[ge,ye]=n.useState(0),[be,ve]=n.useState(null),[we,je]=n.useState("1"),[ke,_e]=n.useState(!1),[Ne,Se]=n.useState(null),Ce=n.useRef(null),[qe,Ee]=n.useState(!1),[Le,Ie]=n.useState(null);n.useEffect(()=>{if(!Y){const e=pe?.businessId||pe?.business_id||"BIZ",t=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.floor(1e3+9e3*Math.random());ee(`T-${e.toString().padStart(2,"0")}-${t}-${n}`)}},[]),n.useEffect(()=>{const e=setTimeout(()=>{re.current?.focus()},300);return()=>clearTimeout(e)},[]),n.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment"),t=pe?.businessId||pe?.business_id,n=window.opener&&!window.opener.closed,s=async(s,a)=>{const r=localStorage.getItem(s);if("success"===e&&r&&t)try{const e=JSON.parse(r);if(he.current)return;const t=`${a}_finalize_done`;if("1"===sessionStorage.getItem(t))return;he.current=!0,sessionStorage.setItem(t,"1");try{X("");const t={items:e.items||[],payment_type:a.toLowerCase(),money_received:e.total||null,discount_id:e.discount_id||null,discount_percentage:e.discount_percentage||null,discount_amount:e.discount_amount||null},s=await p("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${me}`},body:JSON.stringify(t)});s?.transaction_number&&ee(s.transaction_number),s?.transaction_id&&ne(s.transaction_id),L([]);try{const e=new URL(window.location.origin+"/receipt");s?.transaction_number&&e.searchParams.set("tn",s.transaction_number),s?.transaction_id&&e.searchParams.set("tid",String(s.transaction_id)),null!=s?.total&&e.searchParams.set("total",String(s.total)),n&&window.opener?(window.opener.location.href=e.toString(),window.close()):window.location.href=e.toString()}catch(o){}}catch(i){X(`Failed to record ${a} payment`)}finally{if(localStorage.removeItem(s),!n){const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}}}catch(o){localStorage.removeItem(s)}else if("cancel"===e&&r)if(localStorage.removeItem(s),n&&window.opener)window.close();else{const e=new URL(window.location.href);e.searchParams.delete("payment"),window.history.replaceState({},"",e.toString())}};s("pending_gcash_cart","GCash"),s("pending_maya_cart","Maya")},[]);const Pe=async(e,t=1)=>{if(e&&!(t<1)){X("");try{const n=await p(`/api/products/sku/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${me}`}}),s=Number(n.selling_price||0),a=Number(n.stock_quantity??0);if(a<=0)return void X(`Stock for ${n.product_name} (SKU ${n.sku}) is 0.`);if("weight"===n.product_type||"volume"===n.product_type)return Ie(n),void Ee(!0);if(t>a)return void X(`Insufficient stock. Available: ${a}, requested: ${t}.`);L(e=>{const r=e.findIndex(e=>e.product_id===n.product_id);if(r>=0){const n=[...e],s=n[r].quantity+t;return s>a?(X(`Insufficient stock. Available: ${a}, requested: ${s}.`),e):(n[r]={...n[r],quantity:s},n)}return[...e,{product_id:n.product_id,sku:n.sku,name:n.product_name,quantity:t,price:s,is_basic_necessity:n.is_basic_necessity||!1}]}),S(""),q(1),setTimeout(()=>{re.current?.focus()},50)}catch(n){X("Product not found")}finally{setTimeout(()=>{Z(!1)},300)}}},$e=async()=>{await Pe(N,C)},Me=e=>{e>=0&&e<E.length&&L(E.filter((t,n)=>n!==e))},Ae=async(e,t)=>{const n=""===t?1:Math.max(1,Number(t)||1),s=E[e];if(s){X("");try{const t=await p(`/api/products/sku/${encodeURIComponent(s.sku)}`,{headers:{Authorization:`Bearer ${me}`}}),a=Number(t.stock_quantity??0);if(n>a)return void X(`Insufficient stock. Available: ${a}, requested: ${n}.`);L(t=>t.map((t,s)=>s===e?{...t,quantity:n}:t)),je(n),ve(null)}catch(a){X(a.message||"Failed to update quantity")}}},Oe=async()=>{if(0===E.length||ge<0||ge>=E.length)return;const e=E[ge];if(!e)return;const t=e.quantity+1;X("");try{const n=await p(`/api/products/sku/${encodeURIComponent(e.sku)}`,{headers:{Authorization:`Bearer ${me}`}}),s=Number(n.stock_quantity??0);if(t>s)return void X(`Insufficient stock. Available: ${s}, requested: ${t}.`);L(e=>e.map((e,n)=>n===ge?{...e,quantity:t}:e))}catch(n){X(n.message||"Failed to update quantity")}},Te=()=>{if(0===E.length||ge<0||ge>=E.length)return;const e=E[ge];if(!e)return;const t=e.quantity;if(t<=1)return;const n=t-1;L(e=>e.map((e,t)=>t===ge?{...e,quantity:n}:e))},De=E.reduce((e,t)=>e+t.price*t.quantity,0),Re=E.filter(e=>!0===e.is_basic_necessity).reduce((e,t)=>e+t.price*t.quantity,0),Ue=De-Re;let Be=De;if(Ne)if("percentage"===Ne.type){const e=Number(Ne.value);if(!isNaN(e)&&e>0){const t=Re*(e/100);Be=Math.max(0,Re-t+Ue)}}else if("amount"===Ne.type){const e=Number(Ne.value);if(!isNaN(e)&&e>0){const t=Math.min(e,Re);Be=Math.max(0,Re-t+Ue)}}n.useEffect(()=>{const e=e=>{if(I||$||T||R||B||F||se||ke)return;const t=e.target&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable);if(t&&null===be&&!["ArrowUp","ArrowDown","Enter","Escape"].includes(e.key)&&!["e","E","d","D"].includes(e.key)&&!["=","-"].includes(e.key))return;if("Escape"===e.key&&null!==be)return e.preventDefault(),e.stopPropagation(),void ve(null);if("Enter"===e.key&&null!==be)return e.preventDefault(),e.stopPropagation(),Ae(be,we),void ve(null);const n=e.target===re.current,s="ArrowUp"===e.key||"ArrowDown"===e.key,a="="===e.key||"-"===e.key;if(s&&(n||!t||null!==be))switch(e.key){case"ArrowUp":e.preventDefault(),e.stopPropagation(),ye(e=>e>0?e-1:E.length-1);break;case"ArrowDown":e.preventDefault(),e.stopPropagation(),ye(e=>e<E.length-1?e+1:0)}!a||!n&&t&&null===be||E.length>0&&ge>=0&&ge<E.length&&("="===e.key?(e.preventDefault(),e.stopPropagation(),Oe()):"-"===e.key&&(e.preventDefault(),e.stopPropagation(),Te()))};return window.addEventListener("keydown",e,!1),()=>{window.removeEventListener("keydown",e,!1)}},[E.length,ge,be,we,I,$,T,R,B,F,se,ke,Oe,Te]),n.useEffect(()=>{0===E.length?ye(0):ye(e=>Math.min(e,E.length-1))},[E.length]),n.useEffect(()=>{const e=I||$||T||R||B||F||se||ke;if(Z(e),!e){const e=setTimeout(()=>{const e=document.activeElement;e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable||"BUTTON"===e.tagName)||document.body!==e||re.current?.focus()},300);return()=>clearTimeout(e)}},[I,$,T,R,B,F,se,ke]);j([{key:"`",action:()=>{re.current?.focus(),re.current?.select?.()}},{key:"f1",action:()=>{E.length>0&&ge>=0&&ge<E.length&&(ve(ge),je(String(E[ge].quantity)))},enabled:E.length>0&&ge>=0},{key:"f2",action:()=>{0!==E.length&&null!=ge&&Me(ge)},enabled:E.length>0},{key:"f3",description:"Logout",action:()=>_e(!0)},{key:"f4",action:$e,enabled:!!N},{key:"f5",action:()=>U(!0)},{key:"f6",action:()=>{P(!I)}},{key:"f7",action:()=>{M(!0)}},{key:"f8",action:()=>D(!0)},{key:"f9",action:()=>ae(!0)},{key:"f11",action:()=>{Ne&&Se(null)},enabled:!!Ne},{key:"f12",action:()=>z(!0),enabled:E.length>0},{key:"=",action:Oe,enabled:E.length>0&&ge>=0&&ge<E.length},{key:"-",action:Te,enabled:E.length>0&&ge>=0&&ge<E.length},{key:"escape",action:()=>{B?z(!1):I?P(!1):$?M(!1):T?D(!1):F?W(!1):R?U(!1):se?ae(!1):ke&&_e(!1)},allowWhileTyping:!0,stopPropagation:!1}],[E.length,ge,N,Ne,B,I,$,T,F,R,se,ke]);const ze=()=>{sessionStorage.removeItem("auth_token"),sessionStorage.removeItem("user"),_e(!1),_("/")},Fe=()=>{_e(!1)};n.useEffect(()=>{if(!ke)return;const e=e=>{e.stopPropagation(),"Escape"===e.key||"Esc"===e.key?(e.preventDefault(),Fe()):"Enter"===e.key&&(e.preventDefault(),ze())};return document.addEventListener("keydown",e,{capture:!0}),()=>document.removeEventListener("keydown",e,{capture:!0})},[ke]);const We=async(e,t=null)=>{if(0!==E.length){X("");try{const s={items:E.map(e=>({product_id:e.product_id,quantity:e.quantity,price:e.price})),payment_type:e,money_received:t,transaction_id:te,transaction_number:Y,discount_id:Ne?.discount_id||null,discount_percentage:"percentage"===Ne?.type?Ne.value:null,discount_amount:"amount"===Ne?.type?Ne.value:null},a=await p("/api/sales/checkout",{method:"POST",headers:{Authorization:`Bearer ${me}`},body:JSON.stringify(s)});a?.transaction_number&&ee(a.transaction_number),a?.transaction_id&&ne(a.transaction_id),L([]);try{const e=new URL(window.location.origin+"/receipt");a?.transaction_number&&e.searchParams.set("tn",a.transaction_number),a?.transaction_id&&e.searchParams.set("tid",String(a.transaction_id)),null!=a?.total&&e.searchParams.set("total",String(a.total)),_(e.pathname+e.search)}catch(n){}ne(null);const r=pe?.businessId||pe?.business_id||"BIZ",o=(new Date).toISOString().replace(/[-:T.Z]/g,"").slice(0,14),i=Math.floor(1e3+9e3*Math.random());ee(`T-${r.toString().padStart(2,"0")}-${o}-${i}`),Se(null)}catch(s){console.error("Checkout error:",s);X(s?.response?.data?.error||s?.data?.error||s?.message||"Checkout failed")}}},[Ve,He]=n.useState(!1),Je=e.jsxs("div",{className:"flex items-center gap-1 sm:gap-4 mr-3",children:[e.jsxs("div",{className:"space-y-2",children:[Ne&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-green-600",children:[e.jsx("span",{children:"Discount Applied:"}),e.jsx("span",{className:"font-medium",children:"percentage"===Ne.type?`${Ne.value}%`:`₱${Number(Ne.value).toFixed(2)}`})]}),e.jsxs("div",{className:"flex items-center justify-between text-lg font-semibold",children:[e.jsx("span",{children:"Total:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[Ne&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["₱",De.toFixed(2)]}),e.jsxs("span",{children:["₱",Be.toFixed(2)]})]})]})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("button",{onClick:async()=>{try{if(!pe.store_name)return;await navigator.clipboard.writeText(pe.store_name)}catch(e){}},title:"Copy store name",className:"inline-flex items-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg px-2 py-1.5 sm:px-2.5 shadow-sm",children:[e.jsx("svg",{className:"w-3 h-3 sm:w-4 sm:h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6m-10 8l-2 2m2-2l2 2"})}),e.jsx("span",{className:"font-mono text-xs sm:text-sm font-bold tracking-wider truncate max-w-[30vw] sm:max-w-[50vw]",children:pe.store_name})]})}),e.jsxs("button",{onClick:()=>ae(!0),className:"flex items-center gap-2 bg-white/80 backdrop-blur-sm p-1.5 sm:px-3 sm:py-2 rounded-lg border border-gray-200/80 hover:bg-gray-50 transition-colors",title:"View all receipts (F9)",children:[e.jsx("div",{className:"relative",children:e.jsx(v,{className:"w-5 h-5 text-blue-600"})}),e.jsx("span",{className:"text-sm font-medium text-gray-700 hidden sm:inline",children:"Receipts"}),e.jsx("span",{className:"hidden sm:inline-block bg-blue-50 text-blue-700 border border-blue-200 text-xs font-bold px-1.5 py-0.5 rounded",children:"F9"})]})]});return e.jsxs(r,{title:"POS",sidebar:e.jsx(g,{}),headerActions:Je,isSidebarOpen:oe,setSidebarOpen:ie,children:[e.jsx("div",{className:"flex-1 flex flex-col min-h-screen",children:e.jsx("main",{className:"flex-1 bg-gradient-to-br from-gray-50/50 via-blue-50/30 to-indigo-50/50 overflow-hidden p-2 sm:p-3 md:p-4 pb-10 lg:pb-4",children:e.jsxs("div",{className:"grid gap-2 sm:gap-3 md:gap-4 h-full grid-cols-1 lg:grid-cols-12",children:[e.jsxs("div",{className:"lg:col-span-4 flex flex-col gap-2 sm:gap-3 md:gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(a,{onScan:async e=>{const t=e?.[0]?.rawValue;if(t)if(Z(!0),$)O(t);else try{let e;try{e=JSON.parse(t)}catch(n){e=null}if(e&&"cart"===e.t&&Array.isArray(e.items)){e.transaction_id&&ne(e.transaction_id),e.transaction_number&&ee(e.transaction_number);const t=e.items.map(e=>({product_id:e.p,quantity:e.q,sku:e.sku||""}));try{const e=await Promise.all(t.map(async e=>{const t=await p(`/api/products/${e.product_id}`,{headers:{Authorization:`Bearer ${me}`}});return{product_id:e.product_id,sku:t.sku||e.sku||"",name:t.product_name||"",price:Number(t.selling_price)||0,quantity:e.quantity}}));return void L(t=>{const n=new Map(t.map(e=>[e.product_id,e]));for(const s of e){const e=n.get(s.product_id);e?e.quantity+=s.quantity:n.set(s.product_id,{...s})}return Array.from(n.values())})}catch(s){return console.error("Error fetching product details for scanned cart:",s),void L(e=>{const n=new Map(e.map(e=>[e.product_id,e]));for(const s of t){const e=n.get(s.product_id);e?e.quantity+=s.quantity:n.set(s.product_id,{...s,name:"",price:0})}return Array.from(n.values())})}}await Pe(t,1)}catch(s){console.error("Error processing scanned code:",s),await Pe(t,1)}},paused:K,onResume:()=>Z(!1),textMain:"text-blue-700"})}),e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx(o,{ref:re,sku:N,setSku:S,quantity:C,setQuantity:q,handleAddToCart:$e,quantityInputRef:Ce}),G&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 rounded-lg p-3 flex items-start gap-2 mt-3 relative animate-in slide-in-from-top-2 duration-300",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),e.jsx("p",{className:"text-sm font-medium text-red-700 flex-1",children:(()=>{try{const e=JSON.parse(G);return e.error||e.message||G}catch{return G}})()}),e.jsx("button",{onClick:()=>X(""),className:"text-red-400 hover:text-red-600 transition-colors flex-shrink-0 ml-2","aria-label":"Dismiss error",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]})]}),e.jsxs("div",{className:"lg:col-span-8 flex flex-col gap-2 sm:gap-3 min-h-0",children:[te&&Y&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-blue-600 font-medium",children:"Customer Transaction"}),e.jsx("div",{className:"text-sm font-bold text-blue-800 font-mono",children:Y})]})]}),e.jsx("button",{onClick:()=>{ne(null),ee(""),L([]),Se(null)},className:"text-xs text-blue-600 hover:text-blue-800 underline",title:"Start new transaction",children:"Clear"})]}),e.jsx("div",{className:"flex-1 min-h-0 max-h-[calc(100vh-280px)]",children:e.jsx(i,{cart:E,handleRemove:Me,handleEditQuantity:(e,t)=>{Ae(e,t),ve(null)},total:Be,appliedDiscount:Ne,selectedIdx:ge,onSelectRow:e=>{ye(e),e>=0&&e<E.length&&je(String(E[e].quantity))},editingIdx:be,editQty:we,onEditQtyChange:e=>{je(e)},onEditComplete:()=>ve(null),onStartEdit:e=>ve(e),className:"flex-1 h-full"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-2 sm:gap-3 flex-shrink-0",children:[Ne&&e.jsxs("div",{className:"col-span-12 flex items-center justify-between bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg px-3 py-2",children:[e.jsxs("span",{className:"text-sm font-semibold",children:["Discount applied: ",Ne.label]}),e.jsxs("button",{className:"text-xs font-bold underline flex items-center gap-1",onClick:()=>Se(null),children:[e.jsx("span",{className:"text-yellow-600",children:"(F11)"})," Remove"]})]}),e.jsx("div",{className:"col-span-8",children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 gap-2 sm:gap-3",children:[e.jsx(h,{label:e.jsx(k,{text:"CASH LEDGER",shortcut:"F5"}),size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",variant:"secondary",microinteraction:!0,onClick:()=>U(!0),icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsxs("div",{className:"relative group flex-1",children:[e.jsx(h,{label:Ne?e.jsx(k,{text:"REMOVE DISCOUNT",shortcut:"F11",variant:"secondary"}):e.jsx(k,{text:"ADD DISCOUNT",shortcut:"F6"}),variant:"secondary",onClick:()=>{Ne?window.confirm(`Remove ${Ne.label||"discount"}?`)&&Se(null):P(!0)},icon:Ne?e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}):e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold"}),Ne&&e.jsxs("div",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:["Click to remove discount",e.jsx("div",{className:"absolute bottom-0 left-1/2 w-2 h-2 bg-gray-800 transform -translate-x-1/2 translate-y-1/2 rotate-45"})]})]}),e.jsx(h,{label:e.jsx(k,{text:"PRICE CHECK",shortcut:"F7"}),size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>M(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"}),e.jsx(h,{label:e.jsx(k,{text:"SCAN CUSTOMER QR",shortcut:"F8"}),size:"md",className:"w-full h-10 sm:h-12 text-xs sm:text-sm font-bold",onClick:()=>D(!0),variant:"secondary",microinteraction:!0,icon:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),iconPosition:"left"})]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(h,{label:e.jsx(k,{text:"CHECKOUT",shortcut:"F12",variant:"primary"}),size:"md",className:"w-full h-full text-sm sm:text-base font-bold",variant:"primary",microinteraction:!0,onClick:()=>z(!0),disabled:0===E.length,icon:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),iconPosition:"left"})})]})]})]})})}),e.jsx(c,{isOpen:I,onClose:()=>P(!1),onApplyDiscount:e=>{Se(e),P(!1)}}),e.jsx(l,{isOpen:$,onClose:()=>M(!1),sku:A,setSku:O}),e.jsx(d,{isOpen:R,onClose:()=>U(!1)}),e.jsx(w,{isOpen:se,onClose:()=>ae(!1)}),e.jsx(u,{isOpen:B,onClose:()=>z(!1),total:Be,onSelectPayment:e=>{H(e),z(!1),"cash"===e?W(!0):"gcash"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_gcash_cart",JSON.stringify({items:E.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:Be,discount_id:Ne?.discount_id||null,discount_percentage:"percentage"===Ne?.type?Number(Ne.value):null,discount_amount:"amount"===Ne?.type?Number(Ne.value):null}));const{checkoutUrl:n}=await x({amount:Number(Be||0),description:"POS Order",referenceNumber:Y||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(n,"_blank")}catch(e){X("Failed to init GCash"),localStorage.removeItem("pending_gcash_cart")}})():"maya"===e?(async()=>{try{const e=window.location.origin+"/pos?payment=success",t=window.location.origin+"/pos?payment=cancel";localStorage.setItem("pending_maya_cart",JSON.stringify({items:E.map(e=>({product_id:e.product_id,quantity:e.quantity})),total:Be,discount_id:Ne?.discount_id||null,discount_percentage:"percentage"===Ne?.type?Number(Ne.value):null,discount_amount:"amount"===Ne?.type?Number(Ne.value):null}));const{checkoutUrl:n}=await f({amount:Number(Be||0),description:"POS Order",referenceNumber:Y||`POS-${Date.now()}`,cancelUrl:t,successUrl:e});window.open(n,"_blank")}catch(e){X("Failed to init Maya"),localStorage.removeItem("pending_maya_cart")}})():We(e)}}),e.jsx(m,{isOpen:F,onClose:()=>W(!1),total:Be,onConfirm:e=>{We("cash",e),W(!1)}}),e.jsx(y,{isOpen:qe,onClose:()=>{Ee(!1),Ie(null),setTimeout(()=>{re.current?.focus()},50)},product:Le,onConfirm:e=>{if(!Le)return;const t=Le,n=Number(t.stock_quantity??0);if(e>n)return X(`Insufficient stock. Available: ${n} ${t.base_unit||""}, requested: ${e} ${t.base_unit||""}.`),Ee(!1),void Ie(null);let s=Number(t.selling_price||0);"count"!==t.product_type&&t.quantity_per_unit&&t.quantity_per_unit>0&&(s/=Number(t.quantity_per_unit)),L(a=>{const r=a.findIndex(e=>e.product_id===t.product_id);if(r>=0){const s=[...a],o=s[r].quantity+e;return o>n?(X(`Insufficient stock. Available: ${n} ${t.base_unit||""}, requested: ${o} ${t.base_unit||""}.`),a):(s[r]={...s[r],quantity:o},s)}return[...a,{product_id:t.product_id,sku:t.sku,name:t.product_name,quantity:e,price:s,product_type:t.product_type,base_unit:t.base_unit,quantity_per_unit:t.quantity_per_unit||1,is_basic_necessity:t.is_basic_necessity||!1}]}),S(""),q(1),Ee(!1),Ie(null),setTimeout(()=>{re.current?.focus()},50)},existingQuantity:Le&&E.find(e=>e.product_id===Le.product_id)?.quantity||0}),ke&&e.jsxs("div",{className:"fixed inset-0 z-90 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80 z-90",onClick:Fe}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-xl w-[92%] max-w-md z-100 p-0",onKeyDown:e=>{e.stopPropagation(),"Enter"!==e.key||e.isPropagationStopped()||(e.preventDefault(),ze())},children:[e.jsx("div",{className:"bg-gradient-to-r from-red-50 via-red-50/80 to-orange-50/50 border-b border-red-100 px-6 py-5 rounded-t-2xl",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg",children:e.jsx("svg",{className:"w-6 h-6 text-white",fill:"none",stroke:"white",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-1",children:"Confirm Logout"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Are you sure you want to log out? ",e.jsx("span",{className:"text-xs opacity-70",children:"(Press Esc to cancel, Enter to confirm)"})]})]})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-sm text-gray-700 mb-6",children:"You will be redirected to the login page and your session will end."}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:Fe,className:"px-5 py-2.5 rounded-lg text-sm font-semibold text-gray-700 bg-white border-2 border-gray-300 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",autoFocus:!0,children:"Cancel (Esc)"}),e.jsxs("button",{onClick:ze,className:"px-5 py-2.5 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})}),"Logout (Enter)"]})]})]})]})]}),e.jsx(b,{isOpen:T,onClose:()=>D(!1),onImport:async(e,t,n,s)=>{try{if(n&&t)return L([]),ne(null),ee(""),X(""),D(!1),void(window.location.href=`/receipt?tn=${n.transaction_number||t}`);if(t&&e&&e.length>0)return ne(t),s&&ee(s),L(e),X(""),void D(!1);if(!e||0===e.length)return void X("No items found in QR code");console.log("Scanned items:",e);const a=await Promise.all(e.map(async e=>{const t=await p(`/api/products/${e.product_id}`,{headers:{Authorization:`Bearer ${me}`}});return console.log("Fetched product for id",e.product_id,":",t),{product_id:e.product_id,sku:t.sku||e.sku||"",name:t.product_name||"",price:Number(t.selling_price)||0,quantity:e.quantity}}));L(e=>{const t=new Map(e.map(e=>[e.product_id,e]));for(const n of a){const e=t.get(n.product_id);e?e.quantity+=n.quantity:t.set(n.product_id,{...n})}return Array.from(t.values())})}catch(a){console.error("Error fetching products for scanned items:",a),L(t=>{const n=new Map(t.map(e=>[e.product_id,e]));for(const s of e){const e=n.get(s.product_id);e?e.quantity+=s.quantity:n.set(s.product_id,{...s,name:"",price:0})}return Array.from(n.values())})}}})]})}export{_ as default};
//# sourceMappingURL=POS-CdamvOFj.js.map
